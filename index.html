<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TSE RP BROOKASIL | SISTEMA INTEGRADO</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&family=JetBrains+Mono:wght@400;700&family=Orbitron:wght@400;500;700;900&display=swap" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <style>
        /* =========================================
           CSS SUPREMO (AAA) - DEFINI√á√ïES GLOBAIS
           ========================================= */
        :root {
            /* Paleta Core */
            --bg-deep: #020204;
            --bg-panel: rgba(10, 10, 14, 0.7);
            --gold-tse: #D4AF37;
            --gold-glow: rgba(212, 175, 55, 0.4);
            --blue-hud: #00F3FF;
            --blue-glow: rgba(0, 243, 255, 0.3);
            --red-alert: #FF3333;
            --green-success: #00FF9D;
            --text-main: #F0F0F0;
            --text-muted: #8899A6;

            /* Efeitos */
            --glass: blur(12px) saturate(180%);
            --border-hud: 1px solid rgba(255, 255, 255, 0.08);
            --border-gold: 1px solid var(--gold-tse);
            --shadow-float: 0 10px 30px -10px rgba(0,0,0,0.8);
            
            /* Fontes */
            --font-hud: 'Orbitron', sans-serif;
            --font-body: 'Inter', sans-serif;
            --font-code: 'JetBrains Mono', monospace;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; outline: none; }

        body {
            background-color: var(--bg-deep);
            background-image: 
                radial-gradient(circle at 50% 0%, #1a1a2e 0%, transparent 60%),
                linear-gradient(0deg, rgba(0,0,0,0.2) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0,0,0,0.2) 1px, transparent 1px);
            background-size: 100% 100%, 40px 40px, 40px 40px;
            color: var(--text-main);
            font-family: var(--font-body);
            height: 100vh;
            overflow: hidden;
        }

        /* Scanline Effect */
        body::after {
            content: "";
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.1) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.03), rgba(0, 255, 0, 0.01), rgba(0, 0, 255, 0.03));
            background-size: 100% 2px, 3px 100%;
            pointer-events: none;
            z-index: 9999;
        }

        /* Scrollbar Custom */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: var(--bg-deep); }
        ::-webkit-scrollbar-thumb { background: var(--gold-tse); border-radius: 3px; }

        /* =========================================
           COMPONENTES & UTILIT√ÅRIOS
           ========================================= */
        .hidden { display: none !important; }
        .flex { display: flex; }
        .flex-col { flex-direction: column; }
        .grid { display: grid; }
        .gap-4 { gap: 1rem; }
        .w-full { width: 100%; }
        .h-full { height: 100%; }

        h1, h2, h3 { font-family: var(--font-hud); text-transform: uppercase; letter-spacing: 2px; }
        
        .text-gold { color: var(--gold-tse); text-shadow: 0 0 10px var(--gold-glow); }
        .text-blue { color: var(--blue-hud); text-shadow: 0 0 10px var(--blue-glow); }
        .text-red { color: var(--red-alert); }

        /* Bot√µes HUD */
        .btn {
            background: rgba(255,255,255,0.03);
            border: var(--border-hud);
            color: var(--text-main);
            padding: 0.8rem 1.5rem;
            font-family: var(--font-hud);
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.3s ease;
            clip-path: polygon(10px 0, 100% 0, 100% calc(100% - 10px), calc(100% - 10px) 100%, 0 100%, 0 10px);
        }
        .btn:hover { background: rgba(255,255,255,0.1); border-color: var(--text-main); }
        .btn-gold { border-color: var(--gold-tse); color: var(--gold-tse); }
        .btn-gold:hover { background: var(--gold-tse); color: #000; box-shadow: 0 0 20px var(--gold-glow); }
        
        /* Inputs HUD */
        .input-group { position: relative; margin-bottom: 1.2rem; }
        .input-hud {
            width: 100%;
            background: rgba(0,0,0,0.4);
            border: 1px solid #333;
            border-left: 3px solid var(--gold-tse);
            padding: 1rem;
            color: var(--text-main);
            font-family: var(--font-code);
            transition: 0.3s;
        }
        .input-hud:focus { border-color: var(--blue-hud); box-shadow: 0 0 15px rgba(0, 243, 255, 0.1); }
        label { display: block; margin-bottom: 0.4rem; font-size: 0.8rem; color: var(--text-muted); font-family: var(--font-hud); }

        /* Cards Glass */
        .glass-panel {
            background: var(--bg-panel);
            backdrop-filter: var(--glass);
            -webkit-backdrop-filter: var(--glass);
            border: var(--border-hud);
            border-top: 1px solid rgba(255,255,255,0.1);
            box-shadow: var(--shadow-float);
        }

        /* =========================================
           LAYOUT PRINCIPAL
           ========================================= */
        #app { display: flex; height: 100vh; width: 100vw; }

        /* LOGIN SCREEN */
        #login-screen {
            position: fixed; inset: 0; z-index: 50;
            display: flex; align-items: center; justify-content: center;
            background: rgba(2, 2, 4, 0.95);
            backdrop-filter: blur(20px);
        }
        .login-box {
            width: 400px; padding: 3rem;
            border: 1px solid var(--gold-tse);
            box-shadow: 0 0 50px rgba(212, 175, 55, 0.1);
            text-align: center;
        }

        /* SIDEBAR */
        #sidebar {
            width: 260px;
            background: rgba(5, 5, 8, 0.9);
            border-right: var(--border-hud);
            display: flex; flex-direction: column;
            padding: 2rem 1rem;
            z-index: 10;
        }
        .nav-item {
            padding: 1rem; margin-bottom: 0.5rem;
            border-left: 2px solid transparent;
            cursor: pointer;
            color: var(--text-muted);
            font-family: var(--font-hud);
            font-size: 0.9rem;
            transition: 0.3s;
        }
        .nav-item.active, .nav-item:hover {
            background: linear-gradient(90deg, rgba(212, 175, 55, 0.1), transparent);
            border-left-color: var(--gold-tse);
            color: var(--text-main);
        }

        /* MAIN CONTENT */
        #main-content {
            flex: 1; padding: 2rem;
            overflow-y: auto;
            position: relative;
        }
        
        .header-hud {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 2rem; border-bottom: 1px solid rgba(255,255,255,0.1);
            padding-bottom: 1rem;
        }

        /* DASHBOARD GRID */
        .stats-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem; margin-bottom: 2rem;
        }
        .stat-card {
            padding: 1.5rem; border-radius: 4px; position: relative; overflow: hidden;
        }
        .stat-card::before {
            content: ''; position: absolute; top: 0; right: 0; width: 30px; height: 30px;
            background: linear-gradient(135deg, transparent 50%, rgba(255,255,255,0.1) 50%);
        }
        .stat-number { font-size: 2.5rem; font-family: var(--font-hud); font-weight: 700; margin-top: 0.5rem; }

        /* TABLE */
        .table-container { width: 100%; overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
        th { text-align: left; padding: 1rem; color: var(--gold-tse); font-family: var(--font-hud); border-bottom: 1px solid #333; }
        td { padding: 1rem; border-bottom: 1px solid rgba(255,255,255,0.05); font-family: var(--font-code); font-size: 0.9rem; }
        tr:hover td { background: rgba(255,255,255,0.02); }

        .status-badge {
            padding: 0.2rem 0.6rem; border-radius: 4px; font-size: 0.7rem; font-weight: bold; text-transform: uppercase;
        }
        .bg-pending { background: rgba(255, 165, 0, 0.2); color: orange; border: 1px solid orange; }
        .bg-approved { background: rgba(0, 255, 157, 0.2); color: var(--green-success); border: 1px solid var(--green-success); }
        .bg-rejected { background: rgba(255, 51, 51, 0.2); color: var(--red-alert); border: 1px solid var(--red-alert); }

        /* LOGS */
        .log-entry { font-family: var(--font-code); font-size: 0.8rem; padding: 0.5rem; border-left: 1px solid #333; margin-bottom: 0.5rem; }
        .log-time { color: var(--text-muted); margin-right: 10px; }

        /* LOADING */
        #loader { 
            position: fixed; bottom: 20px; right: 20px; 
            padding: 10px 20px; background: var(--bg-deep); border: 1px solid var(--blue-hud);
            color: var(--blue-hud); font-family: var(--font-hud); display: none;
        }
    </style>
</head>
<body>

    <div id="loader">PROCESSANDO DADOS...</div>

    <div id="login-screen">
        <div class="glass-panel login-box">
            <h1 class="text-gold" style="margin-bottom: 0.5rem;">TSE RP</h1>
            <h3 class="text-muted" style="margin-bottom: 2rem; font-size: 0.9rem;">SISTEMA DE AUDITORIA BROOKASIL</h3>
            
            <div class="input-group">
                <input type="text" id="login-user" class="input-hud" placeholder="IDENTIFICA√á√ÉO">
            </div>
            <div class="input-group">
                <input type="password" id="login-pass" class="input-hud" placeholder="CHAVE DE ACESSO">
            </div>
            <button onclick="auth.login()" class="btn btn-gold w-full">INICIAR SESS√ÉO</button>
            <p id="login-msg" class="text-red" style="margin-top: 1rem; font-family: var(--font-code); font-size: 0.8rem;"></p>
        </div>
    </div>

    <div id="app" class="hidden">
        <nav id="sidebar">
            <div style="margin-bottom: 3rem; padding-left: 1rem;">
                <h2 class="text-gold">TSE</h2>
                <div class="text-muted" style="font-size: 0.7rem;" id="user-display">LOGIN: ???</div>
            </div>
            
            <div class="nav-item active" onclick="ui.navigate('dashboard')">DASHBOARD</div>
            <div class="nav-item" onclick="ui.navigate('cadastro')">NOVO CANDIDATO</div>
            <div class="nav-item" onclick="ui.navigate('lista')">CANDIDATURAS</div>
            <div class="nav-item" onclick="ui.navigate('recusados')">RECUSADOS</div>
            <div class="nav-item" id="nav-logs" onclick="ui.navigate('logs')">LOGS DO SISTEMA</div>
            <div class="nav-item" onclick="location.reload()" style="margin-top: auto; color: var(--red-alert);">LOGOUT</div>
        </nav>

        <main id="main-content">
            
            <div id="view-dashboard" class="view-section">
                <div class="header-hud">
                    <h2 class="text-blue">PAINEL DE CONTROLE // <span class="text-gold" id="dash-region">NACIONAL</span></h2>
                    <div class="text-code" id="clock">00:00:00</div>
                </div>

                <div class="stats-grid">
                    <div class="glass-panel stat-card">
                        <label>TOTAL DE REGISTROS</label>
                        <div class="stat-number text-blue" id="stat-total">0</div>
                    </div>
                    <div class="glass-panel stat-card">
                        <label>HOMOLOGADOS</label>
                        <div class="stat-number" style="color: var(--green-success)" id="stat-aprovados">0</div>
                    </div>
                    <div class="glass-panel stat-card">
                        <label>EM AN√ÅLISE</label>
                        <div class="stat-number" style="color: orange" id="stat-analise">0</div>
                    </div>
                    <div class="glass-panel stat-card">
                        <label>INDEFERIDOS</label>
                        <div class="stat-number text-red" id="stat-recusados">0</div>
                    </div>
                </div>

                <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 2rem;">
                    <div class="glass-panel" style="padding: 1rem;">
                        <h3 style="margin-bottom: 1rem; font-size: 0.9rem;">IDEOLOGIA PARTID√ÅRIA</h3>
                        <canvas id="chartIdeologia"></canvas>
                    </div>
                    <div class="glass-panel" style="padding: 1rem;">
                        <h3 style="margin-bottom: 1rem; font-size: 0.9rem;">DISTRIBUI√á√ÉO POR ESTADO</h3>
                        <canvas id="chartEstado"></canvas>
                    </div>
                </div>
            </div>

            <div id="view-cadastro" class="view-section hidden">
                <div class="header-hud"><h2 class="text-gold">REGISTRO DE CANDIDATURA</h2></div>
                
                <div class="glass-panel" style="padding: 2rem; max-width: 800px;">
                    <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div class="input-group">
                            <label>NOME COMPLETO</label>
                            <input type="text" id="cand-nome" class="input-hud">
                        </div>
                        <div class="input-group">
                            <label>TIKTOK (@USUARIO)</label>
                            <input type="text" id="cand-tiktok" class="input-hud" placeholder="@">
                        </div>
                    </div>

                    <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div class="input-group">
                            <label>ESTADO</label>
                            <select id="cand-estado" class="input-hud">
                                </select>
                        </div>
                        <div class="input-group">
                            <label>CIDADE/LOCALIDADE</label>
                            <select id="cand-cidade" class="input-hud">
                                <option value="Capital">Capital (Estadual)</option>
                                <option value="Eleitoral City">Eleitoral City</option>
                                <option value="Liberty City">Liberty City</option>
                                <option value="Nexaville">Nexaville</option>
                                <option value="Castelo Verde">Castelo Verde</option>
                                <option value="Marinha City">Marinha City</option>
                                <option value="Flor√°polis">Flor√°polis</option>
                            </select>
                        </div>
                    </div>

                    <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div class="input-group">
                            <label>PARTIDO</label>
                            <select id="cand-partido" class="input-hud" onchange="formLogic.updateNumberPrefix()">
                                </select>
                        </div>
                        <div class="input-group">
                            <label>CARGO</label>
                            <select id="cand-cargo" class="input-hud" onchange="formLogic.updateNumberPrefix()">
                                <option value="Governador">Governador</option>
                                <option value="Prefeito">Prefeito</option>
                                <option value="Deputado">Deputado</option>
                                <option value="Vereador">Vereador</option>
                            </select>
                        </div>
                    </div>

                    <div class="input-group">
                        <label>N√öMERO DA URNA (AUTO-PREFIXO)</label>
                        <div class="flex">
                            <input type="text" id="cand-num-prefix" class="input-hud" style="width: 60px; text-align: center; color: var(--gold-tse);" readonly>
                            <input type="number" id="cand-num-suffix" class="input-hud" placeholder="Restante dos d√≠gitos">
                        </div>
                    </div>

                    <div class="input-group">
                        <label>IDEOLOGIA (AUTOM√ÅTICA)</label>
                        <input type="text" id="cand-ideologia" class="input-hud" readonly>
                    </div>

                    <button onclick="db.createCandidate()" class="btn btn-gold w-full">PROTOCOLAR CANDIDATURA</button>
                </div>
            </div>

            <div id="view-lista" class="view-section hidden">
                <div class="header-hud"><h2 class="text-blue">REGISTRO GERAL</h2></div>
                <div class="glass-panel" style="padding: 1rem;">
                    <div class="table-container">
                        <table id="table-candidatos">
                            <thead>
                                <tr>
                                    <th>NOME</th>
                                    <th>CARGO</th>
                                    <th>PARTIDO</th>
                                    <th>ESTADO</th>
                                    <th>STATUS</th>
                                    <th>A√á√ÉO</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="view-recusados" class="view-section hidden">
                <div class="header-hud"><h2 class="text-red">LISTA NEGRA (INDEFERIDOS)</h2></div>
                <div class="glass-panel" style="padding: 1rem;">
                    <table id="table-recusados">
                        <thead>
                            <tr>
                                <th>CANDIDATO</th>
                                <th>MOTIVO</th>
                                <th>RESPONS√ÅVEL</th>
                                <th>DATA</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

             <div id="view-logs" class="view-section hidden">
                <div class="header-hud"><h2 class="text-muted">AUDITORIA DE SISTEMA</h2></div>
                <div class="glass-panel" style="padding: 1rem; max-height: 80vh; overflow-y: auto;" id="logs-container">
                    </div>
            </div>

        </main>
    </div>

    <script>
        // =========================================
        // 1. CONFIGURA√á√ÉO & DADOS EST√ÅTICOS
        // =========================================
        const FIREBASE_URL = "https://candidatura-cde-default-rtdb.firebaseio.com";
        
        const PARTIES = {
    direita: [
        { number: "22", name: "Partido Liberal (PL)", color: "#0B3C5D" },
        { number: "11", name: "Progressistas (PP)", color: "#1E90FF" },
        { number: "10", name: "Republicanos", color: "#4169E1" },
        { number: "30", name: "Partido Novo (NOVO)", color: "#00BFFF" },
        { number: "51", name: "Patriota", color: "#2F4F4F" },
        { number: "28", name: "Partido Renovador Trabalhista Brasileiro (PRTB)", color: "#4682B4" },
        { number: "27", name: "Democracia Crist√£ (DC)", color: "#5F9EA0" },
        { number: "36", name: "Agir", color: "#6495ED" },

        // üîπ FICT√çCIOS
        { number: "38", name: "Uni√£o da Direita Brookasileira (UDB)", color: "#003366" },
        { number: "81", name: "Partido da Ordem e Liberdade (POL)", color: "#1C1C1C" },
        { number: "84", name: "Alian√ßa Crist√£ Nacional (ACN)", color: "#2E8B57" },
        { number: "57", name: "Partido da Reedifica√ß√£o da Ordem Nacional (PRONA)", color: "#000080" },
        { number: "48", name: "Partido da Esperan√ßa (PESP)", color: "#228B22" },
        { number: "86", name: "Partido Militar Nacionalista (PMNL)", color: "#556B2F" },
        { number: "75", name: "Partido Republicano Trabalhista Nacional (PRTN)", color: "#191970" }
    ],

    centro: [
        { number: "15", name: "Movimento Democr√°tico Brasileiro (MDB)", color: "#FFD700" },
        { number: "44", name: "Uni√£o Brasil", color: "#FFA500" },
        { number: "55", name: "Partido Social Democr√°tico (PSD)", color: "#FFB347" },
        { number: "20", name: "Podemos", color: "#FF8C00" },
        { number: "45", name: "Partido da Social Democracia Brasileira (PSDB)", color: "#FFDAB9" },
        { number: "77", name: "Solidariedade", color: "#F4A460" },
        { number: "70", name: "Avante", color: "#DAA520" },
        { number: "33", name: "Partido da Mobiliza√ß√£o Nacional (PMN)", color: "#EEC900" },
        { number: "43", name: "Partido Verde (PV)", color: "#9ACD32" },

        // üîπ FICT√çCIOS
        { number: "42", name: "Partido da Uni√£o Nacional (PUN)", color: "#F5DEB3" },
        { number: "37", name: "Movimento Popular Democr√°tico (MPD)", color: "#FFD966" },
        { number: "26", name: "Partido da Mudan√ßa (PDM)", color: "#FFC04D" },
        { number: "63", name: "Movimento Trabalhista Brookasileiro (MTB)", color: "#FFE4B5" },
        { number: "46", name: "Partido Trabalhista Democr√°tico (PTD)", color: "#FFD39B" },
        { number: "88", name: "Partido do Sindicato Democrata (PDSD)", color: "#EEDC82" },
        { number: "14", name: "Partido Miss√£o (MSS)", color: "#FFCC99" },
        { number: "85", name: "Partido Constru√ß√£o (PC)", color: "#F0E68C" }
    ],

    esquerda: [
        { number: "13", name: "Partido dos Trabalhadores (PT)", color: "#CC0000" },
        { number: "50", name: "Partido Socialismo e Liberdade (PSOL)", color: "#FF4C4C" },
        { number: "65", name: "Partido Comunista do Brasil (PCdoB)", color: "#B22222" },
        { number: "18", name: "Rede Sustentabilidade (REDE)", color: "#32CD32" },
        { number: "12", name: "Partido Democr√°tico Trabalhista (PDT)", color: "#DC143C" },
        { number: "80", name: "Unidade Popular (UP)", color: "#8B0000" },
        { number: "29", name: "Partido da Causa Oper√°ria (PCO)", color: "#A00000" },
        { number: "21", name: "Partido Comunista Brasileiro (PCB)", color: "#7B0000" },
        { number: "16", name: "Partido Socialista dos Trabalhadores Unificado (PSTU)", color: "#FF0000" },
        { number: "54", name: "Partido P√°tria Livre (PPL)", color: "#C00000" },
        { number: "40", name: "Partido Socialista Brasileiro (PSB)", color: "#E60026" },

        // üîπ FICT√çCIOS
        { number: "60", name: "Partido da Frente Socialista (PFS)", color: "#B30000" },
        { number: "56", name: "Partido Socialista (PS)", color: "#990000" },
        { number: "31", name: "Partido Social Trabalhista Nacional (PSTN)", color: "#CD2626" }
    ]
};

        const USERS = {
            "TSE Brookasil": { pass: "Brookasil1234", role: "TSE", region: "ALL" },
            "tutuBH": { pass: "tutuBH", role: "TRE", region: "Brookhaven" },
            "williamNC": { pass: "williamNC", role: "TRE", region: "Novacore" },
            "henriqueCB": { pass: "henriqueCB", role: "TRE", region: "Caster√≠ber" },
            "lucasFM": { pass: "lucasFM", role: "TRE", region: "Fortemega" },
            "popoFX": { pass: "popoFX", role: "TRE", region: "Flor√™mix" }
        };

        const REGIONS = ["Brookhaven", "Novacore", "Caster√≠ber", "Fortemega", "Flor√™mix"];

        let currentUser = null;
        let candidatesData = {};
        let logsData = {};
        let charts = {};

        // Configura√ß√£o Firebase (Simples HTTP para evitar problemas de vers√£o CDN complexos em 1 arquivo)
        // Nota: Em um ambiente real usariamos o SDK completo com Auth, mas aqui usaremos REST wrapper simples
        // para garantir funcionamento imediato com o link fornecido.
        
        const api = {
            async get(path) {
                ui.loading(true);
                try {
                    const res = await fetch(`${FIREBASE_URL}/${path}.json`);
                    return await res.json();
                } catch(e) { console.error(e); } 
                finally { ui.loading(false); }
            },
            async post(path, data) {
                ui.loading(true);
                try {
                    await fetch(`${FIREBASE_URL}/${path}.json`, {
                        method: 'POST', body: JSON.stringify(data)
                    });
                } finally { ui.loading(false); }
            },
            async update(path, data) {
                ui.loading(true);
                try {
                    await fetch(`${FIREBASE_URL}/${path}.json`, {
                        method: 'PATCH', body: JSON.stringify(data)
                    });
                } finally { ui.loading(false); }
            }
        };

        // =========================================
        // 2. L√ìGICA DE AUTENTICA√á√ÉO
        // =========================================
        const auth = {
            login: () => {
                const u = document.getElementById('login-user').value;
                const p = document.getElementById('login-pass').value;
                const msg = document.getElementById('login-msg');

                if (USERS[u] && USERS[u].pass === p) {
                    currentUser = { name: u, ...USERS[u] };
                    document.getElementById('login-screen').classList.add('hidden');
                    document.getElementById('app').classList.remove('hidden');
                    document.getElementById('user-display').innerText = `USU√ÅRIO: ${u} [${currentUser.role}]`;
                    document.getElementById('dash-region').innerText = currentUser.region === 'ALL' ? 'NACIONAL' : currentUser.region.toUpperCase();
                    
                    if(currentUser.role !== 'TSE') {
                        document.getElementById('nav-logs').classList.add('hidden');
                    }
                    
                    app.init();
                } else {
                    msg.innerText = "ACESSO NEGADO: CREDENCIAIS INV√ÅLIDAS";
                    
                    // Efeito de erro visual
                    document.querySelector('.login-box').style.borderColor = "red";
                    setTimeout(() => document.querySelector('.login-box').style.borderColor = "var(--gold-tse)", 500);
                }
            }
        };

        // =========================================
        // 3. UI MANAGER
        // =========================================
        const ui = {
            navigate: (viewId) => {
                document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden'));
                document.getElementById(`view-${viewId}`).classList.remove('hidden');
                
                document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
                // Simples highlight logic
                event.target.classList.add('active');

                if(viewId === 'dashboard') db.fetchData();
                if(viewId === 'lista') renderer.renderList();
                if(viewId === 'recusados') renderer.renderRejected();
                if(viewId === 'logs') renderer.renderLogs();
            },
            loading: (show) => {
                document.getElementById('loader').style.display = show ? 'block' : 'none';
            },
            fillSelects: () => {
                const selRegion = document.getElementById('cand-estado');
                REGIONS.forEach(r => {
                    const opt = document.createElement('option');
                    opt.value = r; opt.innerText = r;
                    selRegion.appendChild(opt);
                });

                const selParty = document.getElementById('cand-partido');
                PARTIES.forEach(p => {
                    const opt = document.createElement('option');
                    opt.value = p.sigla; opt.innerText = `${p.sigla} - ${p.num}`;
                    selParty.appendChild(opt);
                });
                
                // Trigger inicial
                formLogic.updateNumberPrefix();
            }
        };

        // =========================================
        // 4. L√ìGICA DE NEG√ìCIO (FORM & VALIDA√á√ÉO)
        // =========================================
        const formLogic = {
            updateNumberPrefix: () => {
                const sigla = document.getElementById('cand-partido').value;
                const cargo = document.getElementById('cand-cargo').value;
                const party = PARTIES.find(p => p.sigla === sigla);
                
                if (!party) return;

                // Definir Ideologia
                document.getElementById('cand-ideologia').value = party.ideo;

                // Regra da Urna
                const prefixInput = document.getElementById('cand-num-prefix');
                prefixInput.value = party.num;

                // Limite de digitos baseados no cargo
                const suffixInput = document.getElementById('cand-num-suffix');
                suffixInput.value = "";
                
                // 2 digitos (Partido) j√° v√£o fixos.
                // Prefeito: 2 digitos totais? N√£o, geralmente Prefeito √© 2 d√≠gitos. Mas a regra diz: 2 do partido + usuario nao altera.
                // Vamos assumir padr√£o TSE Brasil:
                // Prefeito = 2 d√≠gitos (S√≥ o partido). Ent√£o sufixo disabled.
                // Vereador = 5 d√≠gitos (2 partido + 3 sufixo).
                // Deputado = 4 ou 5 d√≠gitos.
                // Governador = 2 d√≠gitos.
                
                if (cargo === 'Prefeito' || cargo === 'Governador') {
                    suffixInput.setAttribute('disabled', true);
                    suffixInput.placeholder = "N/A";
                } else {
                    suffixInput.removeAttribute('disabled');
                    suffixInput.placeholder = "XXX";
                }
            }
        };

        // =========================================
        // 5. DATABASE & ACTIONS
        // =========================================
        const db = {
            fetchData: async () => {
                const data = await api.get('candidatos');
                candidatesData = data || {};
                const logs = await api.get('logs');
                logsData = logs || {};
                renderer.updateDashboard();
            },
            
            createCandidate: async () => {
                const nome = document.getElementById('cand-nome').value;
                const tiktok = document.getElementById('cand-tiktok').value;
                const estado = document.getElementById('cand-estado').value;
                const cidade = document.getElementById('cand-cidade').value;
                const partidoSigla = document.getElementById('cand-partido').value;
                const cargo = document.getElementById('cand-cargo').value;
                const numPrefix = document.getElementById('cand-num-prefix').value;
                const numSuffix = document.getElementById('cand-num-suffix').value;
                const ideologia = document.getElementById('cand-ideologia').value;

                // Valida√ß√µes R√≠gidas
                if(!nome || !tiktok) return alert("ERRO: Preencha todos os campos.");
                
                // Formatar Numero Final
                let numeroUrna = numPrefix;
                if(!document.getElementById('cand-num-suffix').disabled) {
                    if(numSuffix.length < 2) return alert("ERRO: N√∫mero inv√°lido (curto demais).");
                    numeroUrna += numSuffix;
                }

                // Checar Permiss√£o de Estado
                if(currentUser.role === 'TRE' && currentUser.region !== estado) {
                    return alert(`ERRO: Seu TRE (${currentUser.region}) n√£o pode registrar em ${estado}.`);
                }

                // Checar Duplicidade (TikTok e Numero)
                const all = Object.values(candidatesData);
                if(all.find(c => c.tiktok === tiktok)) return alert("ERRO: TikTok j√° registrado.");
                if(all.find(c => c.numero === numeroUrna && c.estado === estado && c.cargo === cargo)) return alert("ERRO: N√∫mero j√° em uso neste cargo/estado.");

                const novoCandidato = {
                    nome, tiktok, estado, cidade, partido: partidoSigla, 
                    cargo, numero: numeroUrna, ideologia,
                    status: 'ANALISE',
                    data: new Date().toLocaleString()
                };

                await api.post('candidatos', novoCandidato);
                await db.logAction(`Candidato ${nome} (${cargo}) registrado por ${currentUser.name}`);
                alert("SUCESSO: Candidatura Protocolada.");
                
                // Reset e Atualiza
                document.getElementById('cand-nome').value = "";
                document.getElementById('cand-num-suffix').value = "";
                db.fetchData();
            },

            approve: async (id, nome) => {
                const cand = candidatesData[id];
                if(currentUser.role === 'TRE' && cand.estado !== currentUser.region) return alert("SEM PERMISS√ÉO: Outro Estado.");
                
                await api.update(`candidatos/${id}`, { status: 'APROVADO' });
                await db.logAction(`Candidatura ${nome} APROVADA por ${currentUser.name}`);
                db.fetchData();
                ui.navigate('lista');
            },

            reject: async (id, nome) => {
                const cand = candidatesData[id];
                if(currentUser.role === 'TRE' && cand.estado !== currentUser.region) return alert("SEM PERMISS√ÉO: Outro Estado.");

                const motivo = prompt("MOTIVO DA RECUSA (OBRIGAT√ìRIO):");
                if(!motivo) return alert("Cancelado: Motivo obrigat√≥rio.");

                // Atualiza status e adiciona metadados de recusa
                await api.update(`candidatos/${id}`, { 
                    status: 'RECUSADO',
                    motivoRecusa: motivo,
                    autorRecusa: currentUser.name
                });
                await db.logAction(`Candidatura ${nome} RECUSADA por ${currentUser.name}. Motivo: ${motivo}`);
                db.fetchData();
                ui.navigate('lista');
            },

            logAction: async (msg) => {
                await api.post('logs', {
                    msg,
                    user: currentUser.name,
                    time: new Date().toLocaleString()
                });
            }
        };

        // =========================================
        // 6. RENDERIZADOR
        // =========================================
        const renderer = {
            updateDashboard: () => {
                const list = Object.values(candidatesData);
                
                // Filtros de Regi√£o (TRE v√™ s√≥ o seu)
                const filtered = currentUser.role === 'TSE' ? list : list.filter(c => c.estado === currentUser.region);

                // Counters
                document.getElementById('stat-total').innerText = filtered.length;
                document.getElementById('stat-aprovados').innerText = filtered.filter(c => c.status === 'APROVADO').length;
                document.getElementById('stat-analise').innerText = filtered.filter(c => c.status === 'ANALISE').length;
                document.getElementById('stat-recusados').innerText = filtered.filter(c => c.status === 'RECUSADO').length;

                // Charts Logic
                renderer.renderCharts(filtered);
            },

            renderCharts: (data) => {
                // Ideologia
                const ideologias = {};
                data.forEach(c => { ideologias[c.ideologia] = (ideologias[c.ideologia] || 0) + 1 });
                
                // Estados
                const estados = {};
                data.forEach(c => { estados[c.estado] = (estados[c.estado] || 0) + 1 });

                // Destruir anteriores se existirem
                if(charts.ideologia) charts.ideologia.destroy();
                if(charts.estado) charts.estado.destroy();

                const commonOptions = {
                    responsive: true,
                    plugins: { legend: { labels: { color: 'white' } } }
                };

                // Chart 1
                const ctx1 = document.getElementById('chartIdeologia').getContext('2d');
                charts.ideologia = new Chart(ctx1, {
                    type: 'doughnut',
                    data: {
                        labels: Object.keys(ideologias),
                        datasets: [{
                            data: Object.values(ideologias),
                            backgroundColor: ['#D4AF37', '#00F3FF', '#FF3333', '#00FF9D', '#FFFFFF'],
                            borderColor: '#020204'
                        }]
                    },
                    options: commonOptions
                });

                // Chart 2
                const ctx2 = document.getElementById('chartEstado').getContext('2d');
                charts.estado = new Chart(ctx2, {
                    type: 'bar',
                    data: {
                        labels: Object.keys(estados),
                        datasets: [{
                            label: 'Candidatos',
                            data: Object.values(estados),
                            backgroundColor: '#00F3FF'
                        }]
                    },
                    options: { ...commonOptions, scales: { y: { ticks: { color: 'white' }, grid: { color: '#333'} }, x: { ticks: { color: 'white' } } } }
                });
            },

            renderList: async () => {
                // For√ßa refresh antes de listar
                await db.fetchData();
                const tbody = document.querySelector('#table-candidatos tbody');
                tbody.innerHTML = "";

                Object.entries(candidatesData).forEach(([id, c]) => {
                    // Filtro de Vis√£o
                    if(currentUser.role === 'TRE' && c.estado !== currentUser.region) return;

                    const tr = document.createElement('tr');
                    
                    let statusClass = 'bg-pending';
                    if(c.status === 'APROVADO') statusClass = 'bg-approved';
                    if(c.status === 'RECUSADO') statusClass = 'bg-rejected';

                    // Bot√µes de A√ß√£o (Apenas se em analise)
                    let actions = "-";
                    if(c.status === 'ANALISE') {
                        actions = `
                            <button class="btn btn-gold" style="padding: 2px 8px; font-size: 0.6rem;" onclick="db.approve('${id}', '${c.nome}')">‚úî</button>
                            <button class="btn" style="padding: 2px 8px; font-size: 0.6rem; color: red; border-color: red;" onclick="db.reject('${id}', '${c.nome}')">‚úñ</button>
                        `;
                    }

                    tr.innerHTML = `
                        <td><strong style="color:white">${c.nome}</strong><br><span class="text-muted" style="font-size:0.7rem">${c.tiktok}</span></td>
                        <td>${c.cargo} (${c.numero})</td>
                        <td><span style="color:${PARTIES.find(p=>p.sigla===c.partido)?.color}">${c.partido}</span></td>
                        <td>${c.estado}</td>
                        <td><span class="status-badge ${statusClass}">${c.status}</span></td>
                        <td>${actions}</td>
                    `;
                    tbody.appendChild(tr);
                });
            },

            renderRejected: async () => {
                await db.fetchData();
                const tbody = document.querySelector('#table-recusados tbody');
                tbody.innerHTML = "";

                Object.values(candidatesData).forEach(c => {
                    if(c.status !== 'RECUSADO') return;
                    // TRE filter
                    if(currentUser.role === 'TRE' && c.estado !== currentUser.region) return;

                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${c.nome} (${c.partido})</td>
                        <td class="text-red">${c.motivoRecusa || 'N/A'}</td>
                        <td class="text-gold">${c.autorRecusa || 'Sistema'}</td>
                        <td class="text-muted">${c.data || '-'}</td>
                    `;
                    tbody.appendChild(tr);
                });
            },

            renderLogs: async () => {
                 // Apenas TSE v√™ logs
                 if(currentUser.role !== 'TSE') return;
                 
                 const container = document.getElementById('logs-container');
                 container.innerHTML = "";
                 
                 // Ordenar logs (mais recente primeiro se poss√≠vel, mas obj firebase √© chato)
                 // Convertendo para array
                 const logsArr = logsData ? Object.values(logsData) : [];
                 logsArr.reverse().forEach(log => {
                     const div = document.createElement('div');
                     div.className = 'log-entry';
                     div.innerHTML = `<span class="log-time">[${log.time}]</span> <span class="text-gold">${log.user}</span>: ${log.msg}`;
                     container.appendChild(div);
                 });
            }
        };

        // =========================================
        // 7. INICIALIZA√á√ÉO
        // =========================================
        const app = {
            init: () => {
                ui.fillSelects();
                db.fetchData();
                
                // Rel√≥gio
                setInterval(() => {
                    document.getElementById('clock').innerText = new Date().toLocaleTimeString();
                }, 1000);
            }
        };

    </script>
</body>
</html>
