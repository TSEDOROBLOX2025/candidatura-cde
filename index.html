<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TSE 2026 | Portal Oficial de Candidaturas</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&family=Rajdhani:wght@500;700&display=swap" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        tse: {
                            gold: '#FFD700',
                            dark: '#0a0f1c',
                            card: 'rgba(15, 23, 42, 0.6)',
                            border: 'rgba(255, 215, 0, 0.15)'
                        }
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        tech: ['Rajdhani', 'sans-serif']
                    }
                }
            }
        }
    </script>

    <style>
        body {
            background-color: #050505;
            background-image: 
                radial-gradient(at 0% 0%, rgba(56, 189, 248, 0.1) 0px, transparent 50%),
                radial-gradient(at 100% 0%, rgba(255, 215, 0, 0.05) 0px, transparent 50%);
            color: #e2e8f0;
            overflow-x: hidden;
        }

        /* Glassmorphism Premium */
        .glass-panel {
            background: var(--tse-card);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid var(--tse-border);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.3);
        }

        .input-premium {
            background: rgba(0, 0, 0, 0.4);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
        }

        .input-premium:focus {
            border-color: #FFD700;
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.1);
            transform: translateY(-2px);
        }

        /* Animações */
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .animate-enter {
            animation: slideIn 0.5s cubic-bezier(0.16, 1, 0.3, 1) forwards;
        }

        /* Scrollbar Personalizada */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #0a0f1c; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #FFD700; }

        .active-nav {
            background: linear-gradient(90deg, rgba(255, 215, 0, 0.15), transparent);
            border-left: 3px solid #FFD700;
            color: #FFD700;
        }
        
        .urna-digital {
            background: #1a1a1a;
            border: 2px solid #333;
            box-shadow: inset 0 0 20px rgba(0,0,0,0.8);
        }
    </style>
</head>
<body class="antialiased min-h-screen flex flex-col md:flex-row">

    <div id="toast-container" class="fixed top-5 right-5 z-[100] flex flex-col gap-2"></div>

    <div id="modal-login" class="fixed inset-0 bg-black/90 z-[90] hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="glass-panel w-full max-w-md p-8 rounded-2xl relative animate-enter">
            <button onclick="toggleModal('modal-login')" class="absolute top-4 right-4 text-gray-500 hover:text-white"><i class="fas fa-times"></i></button>
            
            <div class="text-center mb-8">
                <i class="fas fa-shield-alt text-4xl text-tse-gold mb-3"></i>
                <h2 class="font-tech text-2xl font-bold text-white uppercase tracking-widest">Acesso Restrito</h2>
                <p class="text-xs text-gray-400">Sistema Administrativo do TSE</p>
            </div>

            <div class="space-y-4">
                <div>
                    <label class="text-xs font-bold text-gray-500 uppercase ml-1">Unidade Federativa</label>
                    <select id="login-estado" class="input-premium w-full p-3 rounded-lg text-white outline-none mt-1">
                        <option value="" disabled selected>Selecione seu TRE</option>
                        <option value="Brookhaven">Brookhaven (TSE Central)</option>
                        <option value="Novacore">Novacore</option>
                        <option value="Casteríber">Casteríber</option>
                        <option value="Fortemega">Fortemega</option>
                        <option value="Florêmix">Florêmix</option>
                    </select>
                </div>
                <div>
                    <label class="text-xs font-bold text-gray-500 uppercase ml-1">Chave de Segurança</label>
                    <input type="password" id="login-senha" class="input-premium w-full p-3 rounded-lg text-white outline-none mt-1 text-center tracking-[5px]" placeholder="••••••">
                </div>
                <button onclick="autenticar()" class="w-full bg-tse-gold hover:bg-yellow-400 text-black font-bold py-3 rounded-lg transition-all transform hover:scale-[1.02] shadow-lg shadow-yellow-500/20">
                    ACESSAR SISTEMA
                </button>
            </div>
        </div>
    </div>

    <aside class="w-full md:w-64 bg-[#050505] border-r border-white/5 flex-shrink-0 flex flex-col h-auto md:h-screen sticky top-0 z-40">
        <div class="p-6 border-b border-white/5 flex items-center gap-3">
            <div class="w-10 h-10 rounded bg-gradient-to-br from-tse-gold to-yellow-600 flex items-center justify-center shadow-lg shadow-yellow-500/20">
                <i class="fas fa-vote-yea text-black text-lg"></i>
            </div>
            <div>
                <h1 class="font-tech text-xl font-bold tracking-wider text-white">TSE<span class="text-tse-gold">2026</span></h1>
                <p class="text-[10px] text-gray-500 uppercase tracking-widest">Portal Oficial</p>
            </div>
        </div>

        <nav class="flex-1 overflow-y-auto py-4 space-y-1">
            <button onclick="navTo('dashboard')" id="btn-dashboard" class="w-full text-left px-6 py-3 text-sm font-medium text-gray-400 hover:text-white hover:bg-white/5 transition-all flex items-center gap-3 active-nav">
                <i class="fas fa-chart-pie w-5"></i> Dashboard
            </button>
            <button onclick="navTo('candidatos')" id="btn-candidatos" class="w-full text-left px-6 py-3 text-sm font-medium text-gray-400 hover:text-white hover:bg-white/5 transition-all flex items-center gap-3">
                <i class="fas fa-users w-5"></i> Candidatos
            </button>
            <button onclick="navTo('registro')" id="btn-registro" class="w-full text-left px-6 py-3 text-sm font-medium text-gray-400 hover:text-white hover:bg-white/5 transition-all flex items-center gap-3">
                <i class="fas fa-file-signature w-5"></i> Registrar
            </button>
            
            <div class="pt-4 mt-4 border-t border-white/5 px-6">
                <p class="text-[10px] uppercase font-bold text-gray-600 mb-2">Administração</p>
                <button onclick="checkAdminAccess()" id="btn-admin" class="w-full text-left px-0 py-2 text-sm font-medium text-red-400/70 hover:text-red-400 transition-all flex items-center gap-3">
                    <i class="fas fa-lock w-5"></i> Área Restrita
                </button>
            </div>
        </nav>

        <div class="p-6 border-t border-white/5">
            <div id="modo-eleicao-badge" class="px-3 py-1.5 rounded-full bg-blue-500/10 border border-blue-500/30 flex items-center justify-center gap-2">
                <div class="w-2 h-2 rounded-full bg-blue-400 animate-pulse"></div>
                <span class="text-[10px] font-bold text-blue-400 uppercase tracking-wider">Eleição Federal</span>
            </div>
        </div>
    </aside>

    <main class="flex-1 p-4 md:p-8 lg:p-12 overflow-y-auto max-h-screen relative">
        
        <section id="sec-dashboard" class="space-y-8 animate-enter">
            <header class="flex justify-between items-end mb-6">
                <div>
                    <h2 class="text-3xl font-bold text-white mb-1">Painel em Tempo Real</h2>
                    <p class="text-sm text-gray-400">Estatísticas atualizadas das Eleições 2026</p>
                </div>
                <div class="text-right hidden md:block">
                    <p class="text-xs font-mono text-tse-gold" id="clock">00:00:00</p>
                    <p class="text-[10px] text-gray-500 uppercase">Horário de Brasília</p>
                </div>
            </header>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="glass-panel p-6 rounded-2xl relative overflow-hidden group">
                    <div class="absolute -right-6 -top-6 w-24 h-24 bg-blue-500/10 rounded-full blur-xl group-hover:bg-blue-500/20 transition-all"></div>
                    <p class="text-xs font-bold text-blue-400 uppercase tracking-wider mb-2">Total de Registros</p>
                    <h3 class="text-4xl font-tech font-bold text-white" id="stat-total">0</h3>
                    <div class="mt-4 h-1 w-full bg-white/5 rounded-full overflow-hidden">
                        <div class="h-full bg-blue-500 w-full opacity-50"></div>
                    </div>
                </div>

                <div class="glass-panel p-6 rounded-2xl relative overflow-hidden group">
                    <div class="absolute -right-6 -top-6 w-24 h-24 bg-green-500/10 rounded-full blur-xl group-hover:bg-green-500/20 transition-all"></div>
                    <p class="text-xs font-bold text-green-400 uppercase tracking-wider mb-2">Candidaturas Ativas</p>
                    <h3 class="text-4xl font-tech font-bold text-white" id="stat-aprovados">0</h3>
                    <div class="mt-4 h-1 w-full bg-white/5 rounded-full overflow-hidden">
                        <div id="bar-aprovados" class="h-full bg-green-500 w-0 transition-all duration-1000"></div>
                    </div>
                </div>

                <div class="glass-panel p-6 rounded-2xl relative overflow-hidden group">
                    <div class="absolute -right-6 -top-6 w-24 h-24 bg-yellow-500/10 rounded-full blur-xl group-hover:bg-yellow-500/20 transition-all"></div>
                    <p class="text-xs font-bold text-yellow-400 uppercase tracking-wider mb-2">Em Análise</p>
                    <h3 class="text-4xl font-tech font-bold text-white" id="stat-pendentes">0</h3>
                    <div class="mt-4 h-1 w-full bg-white/5 rounded-full overflow-hidden">
                        <div id="bar-pendentes" class="h-full bg-yellow-500 w-0 transition-all duration-1000"></div>
                    </div>
                </div>
            </div>

            <div class="glass-panel p-8 rounded-2xl">
                <h3 class="font-bold text-lg mb-6">Equilíbrio Ideológico</h3>
                <div class="flex h-4 rounded-full overflow-hidden mb-4">
                    <div id="chart-esq" class="bg-red-500 h-full hover:opacity-80 transition-all w-0" title="Esquerda"></div>
                    <div id="chart-cen" class="bg-gray-400 h-full hover:opacity-80 transition-all w-0" title="Centro"></div>
                    <div id="chart-dir" class="bg-blue-600 h-full hover:opacity-80 transition-all w-0" title="Direita"></div>
                </div>
                <div class="flex justify-between text-xs font-bold uppercase tracking-widest">
                    <div class="flex items-center gap-2"><span class="w-2 h-2 rounded-full bg-red-500"></span> Esquerda <span id="val-esq" class="opacity-50 ml-1">0%</span></div>
                    <div class="flex items-center gap-2"><span class="w-2 h-2 rounded-full bg-gray-400"></span> Centro <span id="val-cen" class="opacity-50 ml-1">0%</span></div>
                    <div class="flex items-center gap-2"><span class="w-2 h-2 rounded-full bg-blue-600"></span> Direita <span id="val-dir" class="opacity-50 ml-1">0%</span></div>
                </div>
            </div>
        </section>

        <section id="sec-registro" class="hidden animate-enter pb-20">
            <div class="max-w-4xl mx-auto">
                <div class="text-center mb-10">
                    <h2 class="text-3xl font-bold text-white">Registro de Candidatura</h2>
                    <p class="text-sm text-gray-400 mt-2">Preencha os dados com atenção. O registro passará por análise.</p>
                </div>

                <form id="form-registro" onsubmit="preRegister(event)" class="glass-panel p-8 md:p-12 rounded-3xl border-t-4 border-t-tse-gold relative">
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                        <div class="col-span-2 md:col-span-1 space-y-4">
                            <div>
                                <label class="text-xs font-bold text-gray-400 uppercase">Nome Completo</label>
                                <input type="text" id="reg-nome" required class="input-premium w-full p-3 rounded-lg text-white mt-1" placeholder="Ex: João da Silva">
                            </div>
                            <div>
                                <label class="text-xs font-bold text-gray-400 uppercase">CPF</label>
                                <input type="text" id="reg-cpf" required class="input-premium w-full p-3 rounded-lg text-white mt-1" placeholder="000.000.000-00">
                            </div>
                            <div>
                                <label class="text-xs font-bold text-gray-400 uppercase">TikTok (Divulgação)</label>
                                <input type="text" id="reg-tiktok" required class="input-premium w-full p-3 rounded-lg text-white mt-1" placeholder="@usuario">
                            </div>
                        </div>

                        <div class="col-span-2 md:col-span-1 space-y-4">
                            <div>
                                <label class="text-xs font-bold text-gray-400 uppercase">Posicionamento</label>
                                <select id="reg-lado" onchange="loadParties(this.value)" required class="input-premium w-full p-3 rounded-lg text-white mt-1">
                                    <option value="">Selecione...</option>
                                    <option value="Direita">Direita</option>
                                    <option value="Centro">Centro</option>
                                    <option value="Esquerda">Esquerda</option>
                                </select>
                            </div>
                            <div>
                                <label class="text-xs font-bold text-gray-400 uppercase">Partido</label>
                                <select id="reg-partido" onchange="updateUrnaNumber()" required class="input-premium w-full p-3 rounded-lg text-white mt-1" disabled>
                                    <option value="">Selecione o posicionamento primeiro</option>
                                </select>
                            </div>
                            <div>
                                <label class="text-xs font-bold text-gray-400 uppercase">Estado</label>
                                <select id="reg-estado" required class="input-premium w-full p-3 rounded-lg text-white mt-1">
                                    <option value="">Selecione...</option>
                                    <option value="Brookhaven">Brookhaven</option>
                                    <option value="Novacore">Novacore</option>
                                    <option value="Casteríber">Casteríber</option>
                                    <option value="Fortemega">Fortemega</option>
                                    <option value="Florêmix">Florêmix</option>
                                </select>
                            </div>
                        </div>

                        <div class="col-span-2 mt-4 pt-6 border-t border-white/10">
                            <label class="text-xs font-bold text-gray-400 uppercase block mb-4 text-center">Configuração da Urna</label>
                            
                            <div class="flex flex-col md:flex-row items-center justify-center gap-8">
                                <div class="w-full md:w-1/2">
                                    <label class="text-xs font-bold text-gray-500 uppercase">Cargo Disputado</label>
                                    <select id="reg-cargo" onchange="updateUrnaStructure()" class="input-premium w-full p-3 rounded-lg text-white mt-1">
                                        </select>
                                </div>

                                <div class="urna-digital p-6 rounded-xl flex items-center gap-2">
                                    <div class="text-center">
                                        <div id="display-num-partido" class="bg-gray-200 text-black font-mono text-3xl px-2 py-1 rounded w-16 h-12 flex items-center justify-center">--</div>
                                        <span class="text-[9px] text-gray-500 uppercase mt-1 block">Partido</span>
                                    </div>
                                    <div id="urna-extra-container" class="flex gap-1 hidden">
                                        <input type="text" id="reg-num-extra" maxlength="3" class="bg-gray-200 text-black font-mono text-3xl px-2 py-1 rounded w-24 h-12 text-center outline-none border-b-4 border-transparent focus:border-green-500" placeholder="000">
                                    </div>
                                </div>
                            </div>
                            <p class="text-center text-xs text-tse-gold mt-4 font-mono">Número Final: <span id="final-number">--</span></p>
                        </div>
                    </div>

                    <button type="submit" class="w-full bg-gradient-to-r from-tse-gold to-yellow-600 text-black font-bold text-lg py-4 rounded-xl shadow-lg shadow-yellow-500/20 hover:scale-[1.01] transition-transform uppercase tracking-wider">
                        <i class="fas fa-paper-plane mr-2"></i> Protocolar Candidatura
                    </button>
                </form>
            </div>
        </section>

        <section id="sec-candidatos" class="hidden animate-enter">
            <header class="flex flex-col md:flex-row justify-between items-center mb-8 gap-4">
                <h2 class="text-2xl font-bold text-white">Candidaturas Homologadas</h2>
                
                <div class="flex gap-2 bg-black/30 p-1 rounded-lg border border-white/10">
                    <button onclick="filterCandidates('todos')" class="px-4 py-2 rounded-md text-xs font-bold uppercase bg-white/10 text-white hover:bg-white/20 transition-all filter-btn active-filter" data-filter="todos">Todos</button>
                    <button onclick="filterCandidates('Presidente')" class="px-4 py-2 rounded-md text-xs font-bold uppercase text-gray-400 hover:text-white hover:bg-white/10 transition-all filter-btn" data-filter="Presidente">Presidente</button>
                    <button onclick="filterCandidates('Governador')" class="px-4 py-2 rounded-md text-xs font-bold uppercase text-gray-400 hover:text-white hover:bg-white/10 transition-all filter-btn" data-filter="Governador">Gov</button>
                    <button onclick="filterCandidates('Outros')" class="px-4 py-2 rounded-md text-xs font-bold uppercase text-gray-400 hover:text-white hover:bg-white/10 transition-all filter-btn" data-filter="Outros">Legis</button>
                </div>
            </header>

            <div id="grid-candidatos" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6">
                </div>
            
            <div id="empty-state" class="hidden flex flex-col items-center justify-center py-20 opacity-50">
                <i class="fas fa-search text-4xl mb-4"></i>
                <p>Nenhum candidato encontrado com este filtro.</p>
            </div>
        </section>

        <section id="sec-admin" class="hidden animate-enter pb-20">
            <div class="glass-panel p-6 rounded-2xl mb-8 border-l-4 border-l-red-500 flex justify-between items-center">
                <div>
                    <h2 class="text-xl font-bold text-white flex items-center gap-2">
                        <i class="fas fa-user-shield text-red-500"></i> Painel Administrativo
                    </h2>
                    <p class="text-xs text-gray-400 mt-1" id="admin-info-text">Conectado como Visitante</p>
                </div>
                <div id="admin-controls" class="hidden gap-2">
                    <button onclick="logoutAdmin()" class="px-4 py-2 bg-red-500/10 text-red-400 border border-red-500/20 rounded hover:bg-red-500/20 text-xs font-bold">SAIR</button>
                </div>
            </div>

            <div id="super-admin-tools" class="hidden glass-panel p-6 rounded-2xl mb-8">
                <h3 class="text-sm font-bold text-tse-gold uppercase mb-4">Configuração Global (TSE Central)</h3>
                <div class="flex gap-4">
                    <button onclick="setElectionMode('Federal')" class="flex-1 bg-blue-900/30 border border-blue-500/30 hover:bg-blue-900/50 p-4 rounded-xl text-center transition-all group">
                        <i class="fas fa-globe-americas text-2xl text-blue-400 mb-2 group-hover:scale-110 transition-transform"></i>
                        <p class="text-xs font-bold text-blue-100">ATIVAR ELEIÇÕES FEDERAIS</p>
                    </button>
                    <button onclick="setElectionMode('Municipal')" class="flex-1 bg-green-900/30 border border-green-500/30 hover:bg-green-900/50 p-4 rounded-xl text-center transition-all group">
                        <i class="fas fa-city text-2xl text-green-400 mb-2 group-hover:scale-110 transition-transform"></i>
                        <p class="text-xs font-bold text-green-100">ATIVAR ELEIÇÕES MUNICIPAIS</p>
                    </button>
                </div>
            </div>

            <div class="grid lg:grid-cols-2 gap-8">
                <div>
                    <h3 class="text-sm font-bold text-yellow-400 uppercase mb-4 flex items-center gap-2">
                        <span class="w-2 h-2 bg-yellow-400 rounded-full animate-pulse"></span> Aguardando Análise
                    </h3>
                    <div id="list-admin-pendentes" class="space-y-4"></div>
                </div>

                <div>
                    <h3 class="text-sm font-bold text-green-400 uppercase mb-4 flex items-center gap-2">
                        <span class="w-2 h-2 bg-green-400 rounded-full"></span> Base de Dados Ativa
                    </h3>
                    <div id="list-admin-aprovados" class="space-y-4"></div>
                </div>
            </div>
        </section>

    </main>

    <script>
        // CONFIGURAÇÃO FIREBASE 
        // Use a configuração pública padrão ou a sua própria
        const firebaseConfig = {
            databaseURL: "https://candidatura-cde-default-rtdb.firebaseio.com"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // Variáveis de Estado
        let currentTab = 'dashboard';
        let electionMode = 'Federal'; // Federal ou Municipal
        let currentUser = null; // { estado: 'Brookhaven', nivel: 'admin' }
        let candidatesCache = [];
        
        // Dados Estáticos
        const parties = {
            Direita: ["PL (22)", "PP (11)", "Republicanos (10)", "PRTB (28)", "NOVO (30)", "Patriota (51)"],
            Centro: ["MDB (15)", "PSD (55)", "PSDB (45)", "Podemos (20)", "União (44)"],
            Esquerda: ["PT (13)", "PSOL (50)", "PDT (12)", "PCdoB (65)", "PSB (40)", "Rede (18)"]
        };

        const passwords = {
            "Brookhaven": "Brookasil1234",
            "Novacore": "williamNC",
            "Casteríber": "henriqueCB",
            "Fortemega": "lucasFM",
            "Florêmix": "charlesFX"
        };

        // --- INICIALIZAÇÃO ---
        document.addEventListener('DOMContentLoaded', () => {
            // Ouvinte de Configuração Global
            db.ref('config/mode').on('value', snap => {
                electionMode = snap.val() || 'Federal';
                updateInterfaceMode();
                loadCandidates(); // Recarrega com base no novo modo
            });

            // Atualizar Relógio
            setInterval(() => {
                document.getElementById('clock').innerText = new Date().toLocaleTimeString('pt-BR');
            }, 1000);

            // Máscara CPF
            document.getElementById('reg-cpf').addEventListener('input', function(e) {
                let v = e.target.value.replace(/\D/g, "");
                if (v.length > 11) v = v.slice(0, 11);
                if (v.length > 9) v = v.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, "$1.$2.$3-$4");
                else if (v.length > 6) v = v.replace(/(\d{3})(\d{3})(\d{3})/, "$1.$2.$3");
                else if (v.length > 3) v = v.replace(/(\d{3})(\d{3})/, "$1.$2");
                e.target.value = v;
            });

            // Input listener para numero extra da urna
            document.getElementById('reg-num-extra').addEventListener('input', updateUrnaNumber);
        });

        // --- NAVEGAÇÃO ---
        function navTo(tabId) {
            // Esconder todas as seções
            ['dashboard', 'registro', 'candidatos', 'admin'].forEach(id => {
                document.getElementById('sec-' + id).classList.add('hidden');
                const btn = document.getElementById('btn-' + id);
                if(btn) btn.classList.remove('active-nav');
            });

            // Mostrar a desejada
            document.getElementById('sec-' + tabId).classList.remove('hidden');
            const activeBtn = document.getElementById('btn-' + tabId);
            if(activeBtn) activeBtn.classList.add('active-nav');
            
            // Re-renderizar se necessário
            if(tabId === 'dashboard') updateDashboardStats();
            
            currentTab = tabId;
        }

        function checkAdminAccess() {
            if(currentUser) {
                navTo('admin');
                renderAdminList();
            } else {
                toggleModal('modal-login');
            }
        }

        function toggleModal(id) {
            const el = document.getElementById(id);
            if(el.classList.contains('hidden')) el.classList.remove('hidden');
            else el.classList.add('hidden');
        }

        // --- AUTH ADMIN ---
        function autenticar() {
            const est = document.getElementById('login-estado').value;
            const sen = document.getElementById('login-senha').value;

            if(passwords[est] === sen) {
                currentUser = { estado: est };
                showToast('success', `Bem-vindo, Admin ${est}`);
                toggleModal('modal-login');
                
                // Atualizar UI Admin
                document.getElementById('admin-info-text').innerText = `Acesso Autorizado: TRE ${est}`;
                document.getElementById('admin-controls').classList.remove('hidden');
                
                if(est === 'Brookhaven') {
                    document.getElementById('super-admin-tools').classList.remove('hidden');
                }

                navTo('admin');
                renderAdminList();
            } else {
                showToast('error', 'Credenciais Inválidas');
            }
        }

        function logoutAdmin() {
            currentUser = null;
            document.getElementById('super-admin-tools').classList.add('hidden');
            navTo('dashboard');
            showToast('info', 'Desconectado com sucesso');
        }

        // --- LÓGICA DE DADOS ---
        function updateInterfaceMode() {
            const badge = document.getElementById('modo-eleicao-badge');
            const selectCargo = document.getElementById('reg-cargo');
            
            if(electionMode === 'Federal') {
                badge.innerHTML = `<div class="w-2 h-2 rounded-full bg-blue-400 animate-pulse"></div><span class="text-[10px] font-bold text-blue-400 uppercase tracking-wider">Eleições Federais</span>`;
                selectCargo.innerHTML = `
                    <option value="Presidente">Presidente</option>
                    <option value="Governador">Governador</option>
                    <option value="Senador">Senador</option>
                    <option value="Deputado Federal">Deputado Federal</option>
                    <option value="Deputado Estadual">Deputado Estadual</option>
                `;
            } else {
                badge.innerHTML = `<div class="w-2 h-2 rounded-full bg-green-400 animate-pulse"></div><span class="text-[10px] font-bold text-green-400 uppercase tracking-wider">Eleições Municipais</span>`;
                selectCargo.innerHTML = `
                    <option value="Prefeito">Prefeito</option>
                    <option value="Vereador">Vereador</option>
                `;
            }
            updateUrnaStructure();
        }

        function loadParties(side) {
            const sel = document.getElementById('reg-partido');
            sel.innerHTML = '<option value="">Selecione...</option>';
            sel.disabled = true;
            
            if(parties[side]) {
                parties[side].forEach(p => {
                    sel.innerHTML += `<option value="${p}">${p}</option>`;
                });
                sel.disabled = false;
            }
        }

        function updateUrnaStructure() {
            const cargo = document.getElementById('reg-cargo').value;
            const extraContainer = document.getElementById('urna-extra-container');
            const numExtraInput = document.getElementById('reg-num-extra');
            
            // Regra: Presidente/Gov/Prefeito = Apenas numero partido (2 digitos)
            // Senador (3), Deputados/Vereador (4 ou 5)
            // Aqui simplificaremos: Executivo = Partido, Legislativo = Partido + 3 dígitos
            
            const isLegislativo = ['Senador', 'Deputado Federal', 'Deputado Estadual', 'Vereador'].includes(cargo);
            
            if(isLegislativo) {
                extraContainer.classList.remove('hidden');
                numExtraInput.value = '';
            } else {
                extraContainer.classList.add('hidden');
                numExtraInput.value = '';
            }
            updateUrnaNumber();
        }

        function updateUrnaNumber() {
            const partidoStr = document.getElementById('reg-partido').value;
            const numExtra = document.getElementById('reg-num-extra').value;
            const displayP = document.getElementById('display-num-partido');
            const finalDisplay = document.getElementById('final-number');
            
            let numPartido = '--';
            if(partidoStr) {
                const match = partidoStr.match(/\((\d+)\)/);
                if(match) numPartido = match[1];
            }
            
            displayP.innerText = numPartido;
            
            if(document.getElementById('urna-extra-container').classList.contains('hidden')) {
                finalDisplay.innerText = numPartido !== '--' ? numPartido : '--';
                finalDisplay.className = numPartido !== '--' ? "text-2xl font-black text-tse-gold" : "text-gray-500";
            } else {
                const full = (numPartido !== '--' ? numPartido : '') + numExtra;
                finalDisplay.innerText = full || '--';
                finalDisplay.className = full.length >= 4 ? "text-2xl font-black text-tse-gold" : "text-gray-500";
            }
        }

        // --- CRUD CANDIDATOS ---
        function preRegister(e) {
            e.preventDefault();
            
            // Coletar dados
            const data = {
                nome: document.getElementById('reg-nome').value,
                cpf: document.getElementById('reg-cpf').value,
                tiktok: document.getElementById('reg-tiktok').value,
                lado: document.getElementById('reg-lado').value,
                partido: document.getElementById('reg-partido').value,
                estado: document.getElementById('reg-estado').value,
                cargo: document.getElementById('reg-cargo').value,
                numero: document.getElementById('final-number').innerText,
                eleicao: electionMode,
                status: 'pendente',
                timestamp: Date.now()
            };

            // Validar
            if(data.numero === '--' || data.numero.length < 2) {
                showToast('error', 'Número da urna inválido');
                return;
            }

            // Verificar duplicidade (simples)
            const exists = candidatesCache.find(c => c.numero === data.numero && c.eleicao === electionMode && c.estado === data.estado);
            if(exists) {
                showToast('error', 'Este número já está em uso neste estado!');
                return;
            }

            // Enviar
            const btn = e.target.querySelector('button[type="submit"]');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processando...';
            btn.disabled = true;

            db.ref('candidatos').push(data).then(() => {
                showToast('success', 'Registro enviado para análise!');
                e.target.reset();
                document.getElementById('final-number').innerText = '--';
                document.getElementById('display-num-partido').innerText = '--';
                navTo('candidatos'); // Redireciona para mostrar que foi, mas só aparecerá após aprovação se filtrar ou no admin
            }).catch(err => {
                showToast('error', 'Erro ao salvar: ' + err.message);
            }).finally(() => {
                btn.innerHTML = originalText;
                btn.disabled = false;
            });
        }

        function loadCandidates() {
            db.ref('candidatos').on('value', snap => {
                candidatesCache = [];
                snap.forEach(child => {
                    candidatesCache.push({ id: child.key, ...child.val() });
                });
                
                updateDashboardStats();
                renderPublicList();
                if(currentUser) renderAdminList();
            });
        }

        function renderPublicList(filterCargo = 'todos') {
            const grid = document.getElementById('grid-candidatos');
            grid.innerHTML = '';
            
            const filtered = candidatesCache.filter(c => {
                if(c.eleicao !== electionMode) return false;
                if(c.status !== 'aprovado') return false;
                if(filterCargo === 'todos') return true;
                if(filterCargo === 'Outros') return !['Presidente', 'Governador', 'Prefeito'].includes(c.cargo);
                return c.cargo === filterCargo;
            });

            if(filtered.length === 0) {
                document.getElementById('empty-state').classList.remove('hidden');
                return;
            } else {
                document.getElementById('empty-state').classList.add('hidden');
            }

            filtered.forEach(c => {
                const color = c.lado === 'Direita' ? 'blue' : (c.lado === 'Esquerda' ? 'red' : 'gray');
                const card = `
                    <div class="glass-panel p-6 rounded-2xl border-t-2 border-${color}-500 hover:transform hover:-translate-y-1 transition-all duration-300 relative group">
                        <div class="absolute top-4 right-4 opacity-50 text-xs font-mono border border-white/20 px-2 py-1 rounded">
                            ${c.estado}
                        </div>
                        
                        <div class="mb-4">
                            <span class="text-[10px] font-bold uppercase tracking-widest text-${color}-400">${c.lado}</span>
                            <h3 class="text-xl font-bold text-white truncate" title="${c.nome}">${c.nome}</h3>
                            <p class="text-xs text-gray-400 truncate">${c.partido}</p>
                        </div>

                        <div class="bg-black/40 rounded-xl p-4 flex justify-between items-center border border-white/5">
                            <div>
                                <p class="text-[10px] text-gray-500 uppercase">Número</p>
                                <p class="text-3xl font-tech font-bold text-tse-gold">${c.numero}</p>
                            </div>
                            <div class="text-right">
                                <p class="text-[10px] text-gray-500 uppercase">Cargo</p>
                                <p class="text-sm font-bold text-white">${c.cargo}</p>
                            </div>
                        </div>

                        <div class="mt-4 flex justify-between items-center">
                            <a href="https://tiktok.com/${c.tiktok.startsWith('@') ? c.tiktok : '@'+c.tiktok}" target="_blank" class="text-xs text-blue-400 hover:text-blue-300 flex items-center gap-1">
                                <i class="fab fa-tiktok"></i> Ver Perfil
                            </a>
                        </div>
                    </div>
                `;
                grid.innerHTML += card;
            });
        }

        function filterCandidates(filter) {
            document.querySelectorAll('.filter-btn').forEach(b => {
                b.classList.remove('active-filter', 'bg-white/10', 'text-white');
                b.classList.add('text-gray-400');
                if(b.dataset.filter === filter) {
                    b.classList.add('bg-white/10', 'text-white');
                    b.classList.remove('text-gray-400');
                }
            });
            renderPublicList(filter);
        }

        // --- ADMIN FUNCS ---
        function renderAdminList() {
            if(!currentUser) return;
            
            const pendContainer = document.getElementById('list-admin-pendentes');
            const aprovContainer = document.getElementById('list-admin-aprovados');
            pendContainer.innerHTML = '';
            aprovContainer.innerHTML = '';

            const myList = candidatesCache.filter(c => {
                // Brookhaven vê tudo, outros veem apenas seu estado
                if(currentUser.estado === 'Brookhaven') return true;
                return c.estado === currentUser.estado;
            });

            myList.forEach(c => {
                const isPend = c.status === 'pendente';
                const html = `
                    <div class="glass-panel p-4 rounded-xl border-l-2 ${isPend ? 'border-yellow-500' : 'border-green-500'} flex justify-between items-center">
                        <div>
                            <div class="flex items-center gap-2">
                                <span class="text-tse-gold font-mono font-bold">${c.numero}</span>
                                <h4 class="font-bold text-sm text-white">${c.nome}</h4>
                            </div>
                            <p class="text-xs text-gray-400">${c.cargo} | ${c.estado} | ${c.partido}</p>
                        </div>
                        <div class="flex gap-2">
                            ${isPend ? `
                                <button onclick="setStatus('${c.id}', 'aprovado')" class="w-8 h-8 rounded bg-green-500/20 text-green-400 hover:bg-green-500 hover:text-white transition flex items-center justify-center" title="Aprovar"><i class="fas fa-check"></i></button>
                                <button onclick="deleteCandidate('${c.id}')" class="w-8 h-8 rounded bg-red-500/20 text-red-400 hover:bg-red-500 hover:text-white transition flex items-center justify-center" title="Rejeitar/Excluir"><i class="fas fa-times"></i></button>
                            ` : `
                                <button onclick="deleteCandidate('${c.id}')" class="w-8 h-8 rounded bg-red-900/20 text-red-600 hover:bg-red-600 hover:text-white transition flex items-center justify-center" title="Revogar"><i class="fas fa-trash"></i></button>
                            `}
                        </div>
                    </div>
                `;

                if(isPend) pendContainer.innerHTML += html;
                else if(c.status === 'aprovado') aprovContainer.innerHTML += html;
            });
            
            if(pendContainer.innerHTML === '') pendContainer.innerHTML = '<p class="text-xs text-gray-500 italic">Nenhuma pendência.</p>';
        }

        function setStatus(id, status) {
            db.ref(`candidatos/${id}`).update({ status: status }).then(() => {
                showToast('success', 'Status atualizado!');
            });
        }

        function deleteCandidate(id) {
            if(confirm('Tem certeza? Isso apagará o registro permanentemente.')) {
                db.ref(`candidatos/${id}`).remove();
                showToast('info', 'Registro removido.');
            }
        }

        function setElectionMode(mode) {
            if(currentUser.estado !== 'Brookhaven') {
                showToast('error', 'Apenas TSE Central pode alterar isso.');
                return;
            }
            if(confirm(`Alterar sistema para Eleições ${mode}? Isso afetará a exibição pública.`)) {
                db.ref('config/mode').set(mode);
                showToast('success', `Modo alterado para ${mode}`);
            }
        }

        // --- DASHBOARD CHARTS ---
        function updateDashboardStats() {
            let total = 0, aprov = 0, pend = 0;
            let ideologia = { Direita: 0, Centro: 0, Esquerda: 0 };

            candidatesCache.forEach(c => {
                if(c.eleicao === electionMode) {
                    total++;
                    if(c.status === 'aprovado') {
                        aprov++;
                        if(ideologia[c.lado] !== undefined) ideologia[c.lado]++;
                    } else if (c.status === 'pendente') {
                        pend++;
                    }
                }
            });

            // Update Numbers
            animateValue('stat-total', parseInt(document.getElementById('stat-total').innerText), total, 1000);
            animateValue('stat-aprovados', parseInt(document.getElementById('stat-aprovados').innerText), aprov, 1000);
            animateValue('stat-pendentes', parseInt(document.getElementById('stat-pendentes').innerText), pend, 1000);

            // Update Bars
            document.getElementById('bar-aprovados').style.width = total > 0 ? `${(aprov/total)*100}%` : '0%';
            document.getElementById('bar-pendentes').style.width = total > 0 ? `${(pend/total)*100}%` : '0%';

            // Update Chart
            if(aprov > 0) {
                const esqPct = (ideologia.Esquerda / aprov) * 100;
                const cenPct = (ideologia.Centro / aprov) * 100;
                const dirPct = (ideologia.Direita / aprov) * 100;

                document.getElementById('chart-esq').style.width = `${esqPct}%`;
                document.getElementById('val-esq').innerText = `${Math.round(esqPct)}%`;
                
                document.getElementById('chart-cen').style.width = `${cenPct}%`;
                document.getElementById('val-cen').innerText = `${Math.round(cenPct)}%`;
                
                document.getElementById('chart-dir').style.width = `${dirPct}%`;
                document.getElementById('val-dir').innerText = `${Math.round(dirPct)}%`;
            } else {
                ['esq', 'cen', 'dir'].forEach(k => {
                    document.getElementById(`chart-${k}`).style.width = '0%';
                    document.getElementById(`val-${k}`).innerText = '0%';
                });
            }
        }

        // Helper: Toast UI
        function showToast(type, msg) {
            const container = document.getElementById('toast-container');
            const el = document.createElement('div');
            const colors = {
                success: 'bg-green-500 text-white',
                error: 'bg-red-500 text-white',
                info: 'bg-blue-500 text-white'
            };
            
            el.className = `${colors[type]} px-6 py-3 rounded-lg shadow-xl text-sm font-bold transform translate-x-full transition-transform duration-300 flex items-center gap-3`;
            el.innerHTML = `<i class="fas fa-${type === 'success' ? 'check' : (type === 'error' ? 'exclamation-circle' : 'info-circle')}"></i> ${msg}`;
            
            container.appendChild(el);
            
            // Animation In
            setTimeout(() => el.classList.remove('translate-x-full'), 10);
            
            // Animation Out
            setTimeout(() => {
                el.classList.add('translate-x-full', 'opacity-0');
                setTimeout(() => el.remove(), 300);
            }, 3000);
        }

        // Helper: Count Animation
        function animateValue(id, start, end, duration) {
            const obj = document.getElementById(id);
            if (start === end) return;
            let range = end - start;
            let current = start;
            let increment = end > start ? 1 : -1;
            let stepTime = Math.abs(Math.floor(duration / range));
            if(stepTime < 10) stepTime = 10; // Cap speed
            
            let timer = setInterval(function() {
                current += increment;
                obj.innerHTML = current;
                if (current == end) clearInterval(timer);
            }, stepTime);
        }

        // Carregar Inicial
        loadCandidates();
    </script>
</body>
</html>
