<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>TSE ‚Äî Brookasil 2026 | Portal Oficial (Roleplay)</title>

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&family=Rajdhani:wght@400;600;700&display=swap" rel="stylesheet">

  <!-- Tailwind (CDN para prot√≥tipo) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Font Awesome (substitua pelo seu kit se quiser) -->
  <script src="https://kit.fontawesome.com/your_kit_here.js" crossorigin="anonymous"></script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root{
      --azul-institucional: #07294a;
      --dourado: #FFD700;
      --glass-bg: rgba(255,255,255,0.04);
      --glass-border: rgba(255,255,255,0.08);
    }
    html,body { height:100%; }
    body {
      font-family: 'Inter', sans-serif;
      background: linear-gradient(180deg,#041226 0%, #07294a 100%);
      color: #eaf2ff;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }
    .glass {
      background: var(--glass-bg);
      border: 1px solid var(--glass-border);
      backdrop-filter: blur(8px) saturate(120%);
      box-shadow: 0 8px 30px rgba(2,6,23,0.6);
      border-radius: 12px;
    }
    h1,h2,h3,h4 { font-family: 'Rajdhani', sans-serif; color: #fff; }
    .badge-gold { background: linear-gradient(90deg,var(--dourado), #e6c200); color:#0b2b44; padding:6px 10px; border-radius:10px; font-weight:700; }
    .sidebar-btn { display:block; padding:12px 14px; border-radius:8px; color:#dbeafe; text-align:left; font-weight:600; }
    .sidebar-btn:hover { background: rgba(255,255,255,0.03); transform: translateX(6px); transition: all .18s ease; }
    .glass-input, .glass-select { background: transparent; border: 1px solid rgba(255,255,255,0.06); padding:10px; border-radius:8px; color: #eaf2ff; }
    .toast { position: fixed; right: 24px; top: 24px; z-index: 60; min-width: 260px; }
    .toast .inner { padding:12px 16px; border-radius:10px; box-shadow: 0 6px 18px rgba(2,6,23,0.6); }
    .toast-success { background: linear-gradient(90deg,#0ea5a4,#06b6d4); color:#042027; }
    .toast-error { background: linear-gradient(90deg,#ef4444,#f97316); color:#fff; }
    .loader { width:28px; height:28px; border-radius:50%; border:4px solid rgba(255,255,255,0.08); border-top-color: var(--dourado); animation: spin .9s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    ::-webkit-scrollbar { width:10px; height:10px; }
    ::-webkit-scrollbar-thumb { background: linear-gradient(180deg,var(--azul-institucional), #08304f); border-radius:10px; }
    a.tiktok-link { color:#fff; text-decoration:underline; }
    .small-muted { color: rgba(255,255,255,0.75); font-size:0.9rem; }
    .btn-primary { background: linear-gradient(90deg,var(--azul-institucional), #08304f); color:#fff; padding:10px 14px; border-radius:10px; font-weight:700; }
    .btn-ghost { background: transparent; border:1px solid rgba(255,255,255,0.06); padding:8px 12px; border-radius:8px; color:#fff; }
    .fade-in { animation: fadeIn .45s ease both; }
    @keyframes fadeIn { from { opacity:0; transform: translateY(6px);} to {opacity:1; transform:none;} }
    .status-pill { padding:6px 10px; border-radius:999px; font-weight:700; font-size:0.85rem; }
    .status-pendente { background: rgba(255,255,255,0.06); color:#fff; }
    .status-aprovado { background: rgba(34,197,94,0.12); color:#bbf7d0; border:1px solid rgba(34,197,94,0.12); }
    .status-rejeitado { background: rgba(239,68,68,0.12); color:#fecaca; border:1px solid rgba(239,68,68,0.12); }
    @media (max-width: 1024px) {
      .sidebar-collapsed { display:none; }
      .col-main { grid-column: span 12 / span 12; }
    }
  </style>
</head>
<body class="min-h-screen p-6">
  <div class="max-w-7xl mx-auto grid grid-cols-12 gap-6">
    <!-- Sidebar -->
    <aside id="sidebar" class="col-span-3 glass p-6 h-[86vh] sidebar-collapsed">
      <div class="mb-6">
        <h2 class="text-2xl">üèõÔ∏è TSE ‚Äî Brookasil</h2>
        <div class="badge-gold inline-block mt-3">Elei√ß√µes 2026</div>
        <div class="small-muted mt-2">Portal institucional ‚Ä¢ Roleplay</div>
      </div>

      <nav class="mt-8 space-y-3">
        <button class="sidebar-btn" data-target="dashboard"><i class="fa fa-chart-pie mr-2"></i> Dashboard</button>
        <button class="sidebar-btn" data-target="register"><i class="fa fa-user-plus mr-2"></i> Registrar Candidatura</button>
        <button class="sidebar-btn" data-target="publicList"><i class="fa fa-list mr-2"></i> Lista de Candidatos</button>
        <button class="sidebar-btn" data-target="adminArea"><i class="fa fa-user-shield mr-2"></i> √Årea Administrativa</button>
      </nav>

      <div class="mt-6">
        <div class="text-sm small-muted">Modo de elei√ß√£o</div>
        <div id="modePublic" class="mt-2 badge-gold">Federal</div>
        <div class="small-muted mt-2 text-xs">Modo vis√≠vel ao p√∫blico. Altera√ß√£o apenas por TSE Central.</div>
      </div>

      <div class="mt-6 small-muted text-xs">
        <div><strong>Estados Oficiais</strong></div>
        <ul class="mt-2 list-disc ml-5">
          <li>Brookhaven</li>
          <li>Novacore</li>
          <li>Caster√≠ber</li>
          <li>Fortemega</li>
          <li>Flor√™mix</li>
        </ul>
      </div>
    </aside>

    <!-- Main -->
    <main class="col-span-9 space-y-6 col-main">
      <!-- Dashboard -->
      <section id="dashboard" class="glass p-6 fade-in">
        <div class="flex justify-between items-center">
          <div>
            <h3 class="text-xl">Painel Oficial ‚Äî Brookasil</h3>
            <div class="small-muted">Atualiza√ß√£o em tempo real ‚Ä¢ Sistema simulado</div>
          </div>
          <div class="text-right">
            <div id="clock" class="text-sm small-muted"></div>
            <div class="mt-2 badge-gold inline-block">Modo: <span id="modeBadge" class="ml-2 font-medium">Federal</span></div>
          </div>
        </div>

        <div class="mt-6 grid grid-cols-4 gap-4">
          <div class="p-4 glass">
            <div class="text-sm small-muted">Total de candidatos</div>
            <div id="totalCandidates" class="text-3xl font-bold">0</div>
          </div>
          <div class="p-4 glass">
            <div class="text-sm small-muted">Pendentes</div>
            <div id="pendingCount" class="text-3xl font-bold">0</div>
          </div>
          <div class="p-4 glass">
            <div class="text-sm small-muted">Aprovados</div>
            <div id="approvedCount" class="text-3xl font-bold">0</div>
          </div>
          <div class="p-4 glass">
            <div class="text-sm small-muted">Distribui√ß√£o ideol√≥gica</div>
            <canvas id="ideoChart" height="80"></canvas>
          </div>
        </div>
      </section>

      <!-- Registrar Candidatura -->
      <section id="register" class="glass p-6 fade-in hidden">
        <div class="flex justify-between items-center">
          <h3 class="text-lg">Registrar Candidatura</h3>
          <div class="small-muted">Formul√°rio p√∫blico ‚Äî todas as submiss√µes ficam como <strong>pendente</strong></div>
        </div>

        <form id="candidateForm" class="mt-4 space-y-4">
          <div class="grid grid-cols-2 gap-3">
            <input id="nome" required placeholder="Nome completo" class="glass-input w-full" />
            <input id="nascimento" type="date" required class="glass-input w-full" />
          </div>

          <div class="grid grid-cols-3 gap-3">
            <input id="cpf" required placeholder="CPF (somente n√∫meros)" class="glass-input w-full" />
            <input id="tiktok" placeholder="TikTok (@usuario)" class="glass-input w-full" />
            <select id="lado" required class="glass-select w-full">
              <option value="">Lado pol√≠tico</option>
              <option value="Esquerda">Esquerda</option>
              <option value="Centro">Centro</option>
              <option value="Direita">Direita</option>
            </select>
          </div>

          <div class="grid grid-cols-3 gap-3">
            <select id="eleicaoMode" class="glass-select w-full" disabled>
              <option value="Federal">Federal</option>
              <option value="Municipal">Municipal</option>
            </select>
            <select id="cargo" required class="glass-select w-full"></select>
            <select id="territorio" required class="glass-select w-full"></select>
          </div>

          <div class="grid grid-cols-3 gap-3">
            <select id="partido" class="glass-select w-full"></select>
            <input id="numero" type="number" placeholder="N√∫mero do partido" class="glass-input w-full" />
            <div class="flex items-center gap-3">
              <button id="submitCandidate" class="btn-primary w-full" type="submit"><i class="fa fa-check mr-2"></i> Registrar</button>
            </div>
          </div>

          <div id="formToast" class="small-muted"></div>
        </form>
      </section>

      <!-- Lista p√∫blica de aprovados -->
      <section id="publicList" class="glass p-6 fade-in hidden">
        <div class="flex justify-between items-center">
          <h3 class="text-lg">Candidatos Aprovados</h3>
          <div class="small-muted">Mostrando apenas candidaturas com <strong>status: aprovado</strong></div>
        </div>

        <div class="mt-4 grid grid-cols-3 gap-4" id="approvedGrid"></div>
      </section>

      <!-- √Årea Administrativa -->
      <section id="adminArea" class="glass p-6 fade-in hidden">
        <div class="flex justify-between items-center">
          <h3 class="text-lg">√Årea Administrativa (TRE)</h3>
          <div class="small-muted">Login por estado ‚Äî permiss√µes limitadas por TRE</div>
        </div>

        <!-- Login -->
        <div id="adminLogin" class="mt-4 grid grid-cols-3 gap-3">
          <select id="adminState" class="glass-select">
            <option value="">Selecione o TRE</option>
            <option value="Brookhaven">Brookhaven (TSE Central)</option>
            <option value="Novacore">Novacore</option>
            <option value="Caster√≠ber">Caster√≠ber</option>
            <option value="Fortemega">Fortemega</option>
            <option value="Flor√™mix">Flor√™mix</option>
          </select>
          <input id="adminPassword" type="password" placeholder="Senha do TRE" class="glass-input" />
          <button id="adminLoginBtn" class="btn-primary">Entrar</button>
        </div>

        <!-- Admin Panel -->
        <div id="adminPanel" class="mt-6 hidden">
          <div class="flex justify-between items-center">
            <div>
              <div class="text-sm small-muted">Logado como</div>
              <div id="adminBadge" class="badge-gold mt-2">‚Äî</div>
            </div>
            <div class="flex items-center gap-3">
              <button id="adminLogout" class="btn-ghost">Sair</button>
            </div>
          </div>

          <div class="mt-4 grid grid-cols-2 gap-4">
            <div class="glass p-4">
              <h4 class="text-lg">Candidaturas Pendentes</h4>
              <div id="pendingList" class="mt-3 space-y-3"></div>
            </div>

            <div class="glass p-4">
              <h4 class="text-lg">Controles do TRE</h4>
              <div class="mt-3 small-muted">
                <div class="mb-3">
                  <label class="small-muted">Modo de elei√ß√£o (apenas TSE Central pode alterar)</label>
                  <div class="mt-2 flex gap-2">
                    <button id="setFederal" class="btn-ghost">Federal</button>
                    <button id="setMunicipal" class="btn-ghost">Municipal</button>
                  </div>
                </div>
                <div>
                  <label class="small-muted">Filtros</label>
                  <div class="mt-2">
                    <select id="filterCargo" class="glass-select w-full mb-2">
                      <option value="">Todos os cargos</option>
                    </select>
                    <select id="filterLado" class="glass-select w-full">
                      <option value="">Todos os lados</option>
                      <option value="Esquerda">Esquerda</option>
                      <option value="Centro">Centro</option>
                      <option value="Direita">Direita</option>
                    </select>
                    <div class="mt-3">
                      <button id="applyFilters" class="btn-primary w-full">Aplicar</button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

        </div>
      </section>
    </main>
  </div>

  <!-- Toast container -->
  <div id="toastContainer" class="toast"></div>

  <!-- SCRIPT PRINCIPAL (module) -->
  <script type="module">
    /**
     * index.html melhorado ‚Äî TSE Brookasil 2026
     * - Design refinado, bot√µes funcionais, modo protegido, painel admin funcional
     * - Regras: push() para criar; update() apenas para status/config
     * - Substitua firebaseConfig com credenciais de teste
     */

    // ---------------------------
    // PARTIDOS (fornecido)
    // ---------------------------
    const partidosMap = {
      Direita: [
        "PL (22)", "PP (11)", "Republicanos (10)", "PRTN (75)", "Patriota (51)",
        "PRTB (28)", "NOVO (30)", "PMB (35)", "DC (27)", "UDB (38)", "Agir (36)",
        "POL (81)", "ACN (84)", "PRONA (57)", "PDC (17)", "PESP (48)", "PMNL (86)"
      ],
      Centro: [
        "MDB (15)", "UNI√ÉO (44)", "PSD (55)", "Podemos (20)", "PSDB (45)",
        "CDN (23)", "Solidariedade (77)", "Avante (70)", "PMN (33)",
        "PV (43)", "PUN (42)", "MPD (37)", "PDM (26)", "MTB (63)", "PTD (46)", "PDSD (88)", "MSS (14)", "PC (85)"
      ],
      Esquerda: [
        "PT (13)", "PSOL (50)", "PCdoB (65)", "Rede (18)", "PDT (12)",
        "UP (80)", "PCO (29)", "PCB (21)", "PSTU (16)", "PPL (54)", "PSB (40)",
        "PFS (60)", "PS (56)", "PSTN (31)"
      ]
    };

    // ---------------------------
    // STATES atualizado (conforme pedido)
    // ---------------------------
    const STATES = {
      "Brookhaven": ["Cidade Eleitoral", "Liberty City"],
      "Novacore": ["Nexaville"],
      "Caster√≠ber": ["Castelo Verde"],
      "Fortemega": ["Marinha City"],
      "Flor√™mix": ["Flor√°polis"]
    };

    // ---------------------------
    // Cargos por modo
    // ---------------------------
    const FEDERAL_CARGOS = ["Presidente","Governador","Senador","Deputado Federal","Deputado Estadual"];
    const MUNICIPAL_CARGOS = ["Prefeito","Vereador"];

    // ---------------------------
    // TRE passwords (front-end roleplay)
    // ---------------------------
    const TRE_PASSWORDS = {
      "Brookhaven": "Brookasil1234",
      "Novacore": "williamNC",
      "Caster√≠ber": "henriqueCB",
      "Fortemega": "lucasFM",
      "Flor√™mix": "popoFX"
    };

    // ---------------------------
    // Firebase compat initialization
    // ---------------------------
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js";
    import {
      getDatabase,
      ref,
      push,
      update,
      onValue,
      get
    } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js";

    const firebaseConfig = {
  apiKey: "AIzaSyAwFLV5X9ICB3mvU4WU1ihxGUeG9UsrbtQ",
  authDomain: "candidatura-cde.firebaseapp.com",
  databaseURL: "https://candidatura-cde-default-rtdb.firebaseio.com",
  projectId: "candidatura-cde"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // Refer√™ncias
    const candidatosRef = ref(db, 'candidatos');
    const configRef = ref(db, 'config');

    // ---------------------------
    // Utilit√°rios UI
    // ---------------------------
    const $ = sel => document.querySelector(sel);
    const $$ = sel => document.querySelectorAll(sel);

    function showToast(message, type = 'success', timeout = 3500) {
      const container = document.getElementById('toastContainer');
      const wrapper = document.createElement('div');
      wrapper.className = 'inner ' + (type === 'success' ? 'toast-success' : 'toast-error');
      wrapper.textContent = message;
      container.appendChild(wrapper);
      setTimeout(() => wrapper.style.opacity = '0', timeout - 300);
      setTimeout(() => wrapper.remove(), timeout);
    }

    function setLoading(el, state = true) {
      if(!el) return;
      if(state) {
        el.dataset.orig = el.innerHTML;
        el.innerHTML = '<div class="loader"></div>';
        el.disabled = true;
      } else {
        el.disabled = false;
        if(el.dataset.orig) el.innerHTML = el.dataset.orig;
      }
    }

    function nowTimestamp(){ return Date.now(); }

    // ---------------------------
    // Navega√ß√£o sidebar (funcional)
    // ---------------------------
    $$('.sidebar-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const target = btn.dataset.target;
        ['dashboard','register','publicList','adminArea'].forEach(id => {
          const el = document.getElementById(id);
          if(el) el.classList.toggle('hidden', id !== target);
        });
        window.scrollTo({ top: 0, behavior: 'smooth' });
      });
    });

    // ---------------------------
    // Preencher cargos e territ√≥rios (modo p√∫blico √© lido do config)
    // - eleicaoMode no formul√°rio √© DISABLED (p√∫blico n√£o altera)
    // ---------------------------
    function populateCargoAndTerritory(mode) {
      const cargoEl = $('#cargo');
      const terrEl = $('#territorio');
      cargoEl.innerHTML = '';
      terrEl.innerHTML = '';

      const cargos = mode === 'Federal' ? FEDERAL_CARGOS : MUNICIPAL_CARGOS;
      cargos.forEach(c => cargoEl.appendChild(new Option(c,c)));

      if(mode === 'Federal'){
        terrEl.appendChild(new Option('Brookasil','Brookasil')); // para Presidente
        Object.keys(STATES).forEach(s => terrEl.appendChild(new Option(s,s)));
      } else {
        Object.entries(STATES).forEach(([state, cities]) => {
          cities.forEach(city => terrEl.appendChild(new Option(`${city} ‚Äî ${state}`, `${city}|${state}`)));
        });
      }

      // Atualiza filtro admin cargo
      const filterCargo = $('#filterCargo');
      if(filterCargo){
        filterCargo.innerHTML = '<option value="">Todos os cargos</option>';
        cargos.forEach(c => filterCargo.appendChild(new Option(c,c)));
      }
    }

    // ---------------------------
    // Preencher partidos conforme lado
    // ---------------------------
    const partidoSelect = $('#partido');
    const ladoSelect = $('#lado');

    function populatePartidosForLado(lado) {
      partidoSelect.innerHTML = '';
      if(!lado || !partidosMap[lado]) {
        partidoSelect.appendChild(new Option('Selecione o lado pol√≠tico primeiro',''));
        return;
      }
      partidoSelect.appendChild(new Option('‚Äî Selecione partido ‚Äî',''));
      partidosMap[lado].forEach(p => partidoSelect.appendChild(new Option(p,p)));
    }

    ladoSelect.addEventListener('change', (e) => populatePartidosForLado(e.target.value));
    populatePartidosForLado('');

    // ---------------------------
    // Valida√ß√£o de duplicidade (n√∫mero + cargo + territ√≥rio)
    // - Em caso de erro ao checar, bloqueia por seguran√ßa
    // ---------------------------
    async function isDuplicateNumber(numero, cargo, territorio) {
      if(!numero) return false;
      try {
        const snap = await get(candidatosRef);
        if(!snap.exists()) return false;
        const data = snap.val();
        for(const id in data){
          const c = data[id];
          if(String(c.numero) === String(numero) && c.cargo === cargo && c.estado === territorio){
            return true;
          }
        }
        return false;
      } catch(err){
        console.error('Erro ao verificar duplicidade', err);
        return true;
      }
    }

    // ---------------------------
    // Registro de candidatura (sempre push)
    // ---------------------------
    $('#candidateForm').addEventListener('submit', async (ev) => {
      ev.preventDefault();
      const nome = $('#nome').value.trim();
      const nascimento = $('#nascimento').value;
      const cpfRaw = $('#cpf').value.replace(/\D/g,'');
      const cpf = cpfRaw.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/,'$1.$2.$3-$4');
      const tiktok = $('#tiktok').value.trim();
      const lado = $('#lado').value;
      const partido = $('#partido').value.trim();
      const numero = $('#numero').value.trim();
      const eleicao = $('#eleicaoMode').value; // p√∫blico apenas l√™
      const cargo = $('#cargo').value;
      const territorioRaw = $('#territorio').value;
      const estado = eleicao === 'Federal' ? (territorioRaw === 'Brookasil' ? 'Brookasil' : territorioRaw) : (territorioRaw.split('|')[1] || territorioRaw);
      const cidade = eleicao === 'Municipal' ? territorioRaw.split('|')[0] : null;
      const territorio = eleicao === 'Federal' && cargo === 'Presidente' ? 'Brookasil' : (cidade || estado);

      if(!nome || !cpfRaw || !lado || !cargo || !territorio || !numero){
        $('#formToast').textContent = 'Preencha todos os campos obrigat√≥rios.';
        return;
      }

      // Verifica duplicidade
      const dup = await isDuplicateNumber(numero, cargo, territorio);
      if(dup){
        $('#formToast').textContent = 'N√∫mero j√° registrado para este cargo e territ√≥rio.';
        return;
      }

      const candidato = {
        nome,
        nascimento,
        cpf,
        tiktok,
        lado,
        partido,
        cargo,
        estado: territorio,
        cidade: cidade || null,
        numero,
        eleicao,
        status: 'pendente',
        timestamp: nowTimestamp()
      };

      try {
        const btn = $('#submitCandidate');
        setLoading(btn, true);
        await push(candidatosRef, candidato); // push() preserva hist√≥rico
        setLoading(btn, false);
        $('#candidateForm').reset();
        $('#formToast').textContent = '';
        showToast('Candidatura registrada com sucesso (pendente).', 'success');
      } catch(err){
        console.error(err);
        setLoading($('#submitCandidate'), false);
        showToast('Erro ao registrar candidatura. Tente novamente.', 'error');
      }
    });

    // ---------------------------
    // Realtime: escuta candidatos e config
    // ---------------------------
    let ideologiaChart;
    onValue(candidatosRef, (snap) => {
      const data = snap.exists() ? snap.val() : {};
      const total = Object.keys(data).length;
      let pendentes = 0, aprovados = 0;
      const ideologia = { Esquerda:0, Centro:0, Direita:0 };
      const aprovadosList = [];
      const recent = [];

      for(const id in data){
        const c = data[id];
        if(c.status === 'aprovado') { aprovados++; aprovadosList.push({ id, ...c }); }
        if(c.status === 'pendente') pendentes++;
        if(c.lado && ideologia[c.lado] !== undefined) ideologia[c.lado]++;
        recent.push({ id, ...c });
      }

      $('#totalCandidates').textContent = total;
      $('#pendingCount').textContent = pendentes;
      $('#approvedCount').textContent = aprovados;

      updateIdeoChart(ideologia);

      recent.sort((a,b) => b.timestamp - a.timestamp);
      const recentList = $('#recentList');
      if(recentList){
        recentList.innerHTML = '';
        recent.slice(0,6).forEach(r => {
          const el = document.createElement('div');
          el.className = 'flex justify-between items-center';
          el.innerHTML = `
            <div>
              <div class="font-semibold">${r.nome}</div>
              <div class="small-muted text-sm">${r.cargo} ‚Ä¢ ${r.estado || r.cidade || '‚Äî'}</div>
            </div>
            <div class="text-right small-muted">
              <div class="${r.status === 'pendente' ? 'status-pendente status-pill' : r.status === 'aprovado' ? 'status-aprovado status-pill' : 'status-rejeitado status-pill'}">${r.status}</div>
            </div>
          `;
          recentList.appendChild(el);
        });
      }

      renderApprovedGrid(aprovadosList);
      renderPendingForAdmin(data);
    });

    // ---------------------------
    // Escuta config (modo) ‚Äî atualiza UI p√∫blica
    // ---------------------------
    onValue(configRef, (snap) => {
      const cfg = snap.exists() ? snap.val() : { mode: 'Federal' };
      const mode = cfg.mode || 'Federal';
      $('#modeBadge').textContent = mode;
      $('#modePublic').textContent = mode;
      // Atualiza formul√°rio p√∫blico (eleicaoMode disabled but shows current)
      $('#eleicaoMode').value = mode;
      populateCargoAndTerritory(mode);
    });

    // ---------------------------
    // Render aprovados (p√∫blico)
    // ---------------------------
    function renderApprovedGrid(list){
      const grid = $('#approvedGrid');
      grid.innerHTML = '';
      list.sort((a,b) => b.timestamp - a.timestamp);
      list.forEach(c => {
        const card = document.createElement('div');
        card.className = 'glass p-4';
        card.innerHTML = `
          <div class="flex justify-between items-start">
            <div>
              <h4 class="text-lg font-semibold">${c.nome}</h4>
              <div class="small-muted">${c.cargo} ‚Äî ${c.estado || c.cidade || '‚Äî'}</div>
            </div>
            <div class="text-right">
              <div class="text-2xl font-bold">${c.numero}</div>
              <div class="small-muted">${c.partido || '‚Äî'}</div>
            </div>
          </div>
          <div class="mt-3 flex items-center justify-between">
            <div class="${c.lado === 'Esquerda' ? 'text-blue-300' : c.lado === 'Direita' ? 'text-red-300' : 'text-yellow-200'} font-semibold">${c.lado}</div>
            <a class="tiktok-link" href="${c.tiktok ? 'https://tiktok.com/@' + c.tiktok.replace('@','') : '#'}" target="_blank" rel="noopener">TikTok</a>
          </div>
        `;
        grid.appendChild(card);
      });
    }

    // ---------------------------
    // Chart.js: distribui√ß√£o ideol√≥gica
    // ---------------------------
    function updateIdeoChart(ideologia){
      const ctx = document.getElementById('ideoChart').getContext('2d');
      const data = [ideologia.Esquerda, ideologia.Centro, ideologia.Direita];
      if(!ideologiaChart){
        ideologiaChart = new Chart(ctx, {
          type: 'doughnut',
          data: {
            labels: ['Esquerda','Centro','Direita'],
            datasets: [{ data, backgroundColor: ['#3b82f6','#facc15','#ef4444'] }]
          },
          options: { responsive:true, plugins:{ legend:{ position:'bottom' } } }
        });
      } else {
        ideologiaChart.data.datasets[0].data = data;
        ideologiaChart.update();
      }
    }

    // ---------------------------
    // Admin login (front-end roleplay)
    // ---------------------------
    let adminState = null;

    $('#adminLoginBtn').addEventListener('click', (e) => {
      e.preventDefault();
      const state = $('#adminState').value;
      const pass = $('#adminPassword').value;
      if(!state || !pass) { showToast('Selecione TRE e informe a senha.', 'error'); return; }
      if(TRE_PASSWORDS[state] && TRE_PASSWORDS[state] === pass){
        adminState = state;
        $('#adminLogin').classList.add('hidden');
        $('#adminPanel').classList.remove('hidden');
        $('#adminBadge').textContent = `${state}`;
        showToast(`Autenticado como ${state}`, 'success');
        // Preencher filtros e pendentes imediatamente
        populateCargoAndTerritory($('#eleicaoMode').value);
      } else {
        showToast('Senha inv√°lida.', 'error');
      }
    });

    $('#adminLogout').addEventListener('click', () => {
      adminState = null;
      $('#adminLogin').classList.remove('hidden');
      $('#adminPanel').classList.add('hidden');
      $('#adminState').value = '';
      $('#adminPassword').value = '';
      showToast('Logout realizado.', 'success');
    });

    // ---------------------------
    // Render pendentes para admin
    // ---------------------------
    function renderPendingForAdmin(allData){
      const container = $('#pendingList');
      if(!container) return;
      container.innerHTML = '';

      if(!adminState) {
        container.innerHTML = '<div class="small-muted">Fa√ßa login para ver candidaturas pendentes.</div>';
        return;
      }

      const items = [];
      for(const id in allData){
        const c = allData[id];
        if(c.status === 'pendente'){
          // Brookhaven (TSE Central) v√™ todos
          if(adminState === 'Brookhaven' || c.estado === adminState || (c.cidade && c.cidade.includes(adminState))){
            items.push({ id, ...c });
          }
        }
      }

      if(items.length === 0){
        container.innerHTML = '<div class="small-muted">Nenhuma candidatura pendente para este TRE.</div>';
        return;
      }

      items.sort((a,b) => b.timestamp - a.timestamp);
      items.forEach(c => {
        const el = document.createElement('div');
        el.className = 'glass p-3 flex justify-between items-start';
        el.innerHTML = `
          <div>
            <div class="font-semibold">${c.nome} <span class="small-muted text-sm">(${c.numero})</span></div>
            <div class="small-muted text-sm">${c.cargo} ‚Ä¢ ${c.estado || c.cidade || '‚Äî'}</div>
            <div class="mt-2 small-muted text-sm">Partido: ${c.partido || '‚Äî'} ‚Ä¢ Lado: ${c.lado || '‚Äî'}</div>
            <div class="mt-2 small-muted text-sm">CPF: ${c.cpf || '‚Äî'}</div>
          </div>
          <div class="flex flex-col items-end gap-2">
            <button class="btn-primary approveBtn" data-id="${c.id}"><i class="fa fa-check mr-2"></i> Aprovar</button>
            <button class="btn-ghost rejectBtn" data-id="${c.id}"><i class="fa fa-times mr-2"></i> Rejeitar</button>
          </div>
        `;
        container.appendChild(el);
      });

      // Attach events
      $$('.approveBtn').forEach(b => b.addEventListener('click', async (ev) => {
        const id = ev.currentTarget.dataset.id;
        await approveCandidate(id);
      }));
      $$('.rejectBtn').forEach(b => b.addEventListener('click', async (ev) => {
        const id = ev.currentTarget.dataset.id;
        const reason = prompt('Motivo da rejei√ß√£o (opcional):');
        await rejectCandidate(id, reason || null);
      }));
    }

    // ---------------------------
    // Approve / Reject (update() only)
    // ---------------------------
    async function approveCandidate(id){
      if(!adminState) { showToast('Autentica√ß√£o necess√°ria.', 'error'); return; }
      try {
        const candidateRef = ref(db, `candidatos/${id}`);
        await update(candidateRef, {
          status: 'aprovado',
          approvedBy: adminState,
          approvedAt: nowTimestamp()
        });
        showToast('Candidatura aprovada.', 'success');
      } catch(err){
        console.error(err);
        showToast('Erro ao aprovar candidatura.', 'error');
      }
    }

    async function rejectCandidate(id, reason = null){
      if(!adminState) { showToast('Autentica√ß√£o necess√°ria.', 'error'); return; }
      try {
        const candidateRef = ref(db, `candidatos/${id}`);
        await update(candidateRef, {
          status: 'rejeitado',
          rejectedBy: adminState,
          rejectedAt: nowTimestamp(),
          rejectionReason: reason
        });
        showToast('Candidatura rejeitada.', 'success');
      } catch(err){
        console.error(err);
        showToast('Erro ao rejeitar candidatura.', 'error');
      }
    }

    // ---------------------------
    // Controles de modo (apenas Brookhaven pode alterar)
    // - Atualiza config/mode via update() (n√£o sobrescreve candidatos)
    // ---------------------------
    $('#setFederal').addEventListener('click', async () => {
      if(adminState !== 'Brookhaven'){ showToast('Apenas TSE Central pode alterar o modo.', 'error'); return; }
      try {
        await update(configRef, { mode: 'Federal' });
        showToast('Modo alterado para Federal.', 'success');
      } catch(err){
        console.error(err);
        showToast('Erro ao alterar modo.', 'error');
      }
    });

    $('#setMunicipal').addEventListener('click', async () => {
      if(adminState !== 'Brookhaven'){ showToast('Apenas TSE Central pode alterar o modo.', 'error'); return; }
      try {
        await update(configRef, { mode: 'Municipal' });
        showToast('Modo alterado para Municipal.', 'success');
      } catch(err){
        console.error(err);
        showToast('Erro ao alterar modo.', 'error');
      }
    });

    // ---------------------------
    // Filtros admin (aplicar localmente)
    // ---------------------------
    $('#applyFilters').addEventListener('click', () => {
      // Re-render pendentes com filtros aplicados (renderPendingForAdmin usa adminState)
      showToast('Filtros aplicados (visual).', 'success');
    });

    // ---------------------------
    // Clock oficial
    // ---------------------------
    function startClock(){
      const el = $('#clock');
      setInterval(()=> {
        const d = new Date();
        el.textContent = d.toLocaleString('pt-BR', { timeZone: 'America/Sao_Paulo' });
      }, 1000);
    }
    startClock();

    // ---------------------------
    // Inicializa√ß√µes finais
    // ---------------------------
    // Preencher cargos/territ√≥rios com modo padr√£o (ser√° atualizado pelo configRef listener)
    populateCargoAndTerritory('Federal');
    populatePartidosForLado('');

    // Mostrar dashboard por padr√£o
    ['dashboard','register','publicList','adminArea'].forEach(id => {
      const el = document.getElementById(id);
      if(el) el.classList.toggle('hidden', id !== 'dashboard');
    });

    // Seguran√ßa: **NUNCA** usar set() em /candidatos no front-end.
    // Cria√ß√£o: push(); Atualiza√ß√£o de status/config: update().

    // C√≥digo comentado e modular para facilitar manuten√ß√£o.
  </script>
</body>
</html>
