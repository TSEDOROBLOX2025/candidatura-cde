<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TSE RP BROOKASIL - Sistema Qu√¢ntico V2</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@300;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>

    <style>
        :root {
            --bg-color: #050505;
            --glass-panel: rgba(20, 20, 35, 0.85);
            --neon-green: #00ff41;
            --neon-blue: #00f3ff;
            --neon-purple: #bc13fe;
            --neon-red: #ff003c;
            --text-main: #e0e0e0;
            --border-glow: 0 0 10px rgba(0, 255, 65, 0.3);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; scrollbar-width: thin; scrollbar-color: var(--neon-green) var(--bg-color); }

        body {
            background-color: var(--bg-color);
            color: var(--text-main);
            font-family: 'Rajdhani', sans-serif;
            background-image: 
                linear-gradient(rgba(0, 255, 65, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 255, 65, 0.03) 1px, transparent 1px);
            background-size: 50px 50px;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* --- Header & Nav --- */
        header {
            position: fixed;
            top: 0;
            width: 100%;
            padding: 1rem 2rem;
            background: rgba(5, 5, 5, 0.9);
            border-bottom: 2px solid var(--neon-green);
            box-shadow: 0 0 20px rgba(0, 255, 65, 0.2);
            z-index: 1000;
            display: flex;
            justify-content: space-between;
            align-items: center;
            backdrop-filter: blur(10px);
        }

        .logo {
            font-family: 'Orbitron', sans-serif;
            font-size: 1.8rem;
            font-weight: 900;
            background: linear-gradient(45deg, var(--neon-green), var(--neon-blue));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .system-status {
            font-size: 0.9rem;
            font-weight: 700;
            padding: 0.5rem 1rem;
            border: 1px solid var(--neon-blue);
            border-radius: 4px;
            color: var(--neon-blue);
            text-transform: uppercase;
            box-shadow: 0 0 10px rgba(0, 243, 255, 0.2);
        }

        nav {
            position: fixed;
            top: 80px;
            left: 0;
            width: 250px;
            height: calc(100vh - 80px);
            background: var(--glass-panel);
            border-right: 1px solid var(--neon-green);
            padding: 2rem 1rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
            transform: translateX(-100%);
            transition: transform 0.3s ease;
            z-index: 999;
        }

        nav.open { transform: translateX(0); }

        .nav-toggle {
            position: fixed;
            top: 90px;
            left: 20px;
            z-index: 1001;
            background: var(--neon-green);
            color: #000;
            border: none;
            padding: 0.5rem 1rem;
            cursor: pointer;
            font-weight: bold;
            clip-path: polygon(10% 0, 100% 0, 90% 100%, 0% 100%);
        }

        .nav-btn {
            background: transparent;
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: var(--text-main);
            padding: 1rem;
            text-align: left;
            cursor: pointer;
            font-family: 'Orbitron', sans-serif;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .nav-btn:hover, .nav-btn.active {
            background: rgba(0, 255, 65, 0.1);
            border-color: var(--neon-green);
            color: var(--neon-green);
            box-shadow: inset 5px 0 0 var(--neon-green);
        }

        /* --- Main Content --- */
        main {
            margin-top: 80px;
            padding: 2rem;
            width: 100%;
            max-width: 1200px;
            margin-left: auto;
            margin-right: auto;
            transition: margin-left 0.3s;
        }

        .section { display: none; animation: fadeIn 0.5s ease; }
        .section.active { display: block; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- Cards & Forms --- */
        .cyber-card {
            background: var(--glass-panel);
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 2rem;
            margin-bottom: 2rem;
            position: relative;
            overflow: hidden;
        }

        .cyber-card::before {
            content: '';
            position: absolute;
            top: 0; left: 0; width: 100%; height: 2px;
            background: linear-gradient(90deg, transparent, var(--neon-green), transparent);
        }

        h2 {
            font-family: 'Orbitron', sans-serif;
            color: var(--neon-green);
            margin-bottom: 1.5rem;
            border-bottom: 1px solid rgba(0, 255, 65, 0.3);
            padding-bottom: 0.5rem;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
        }

        .input-group { margin-bottom: 1rem; }
        
        label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--neon-blue);
            font-size: 0.9rem;
            font-weight: 600;
        }

        input, select, textarea {
            width: 100%;
            background: rgba(0, 0, 0, 0.6);
            border: 1px solid #333;
            color: #fff;
            padding: 0.8rem;
            font-family: 'Rajdhani', sans-serif;
            font-size: 1rem;
            transition: 0.3s;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--neon-green);
            box-shadow: 0 0 10px rgba(0, 255, 65, 0.2);
        }

        /* --- Buttons --- */
        .btn-cyber {
            background: transparent;
            border: 1px solid var(--neon-green);
            color: var(--neon-green);
            padding: 0.8rem 2rem;
            font-family: 'Orbitron', sans-serif;
            font-weight: bold;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: 0.3s;
            position: relative;
            overflow: hidden;
            margin-right: 10px;
        }

        .btn-cyber:hover {
            background: var(--neon-green);
            color: #000;
            box-shadow: 0 0 20px var(--neon-green);
        }

        .btn-danger {
            border-color: var(--neon-red);
            color: var(--neon-red);
        }
        .btn-danger:hover {
            background: var(--neon-red);
            color: #fff;
            box-shadow: 0 0 20px var(--neon-red);
        }

        /* --- Tables --- */
        .table-container { overflow-x: auto; }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
            background: rgba(0, 0, 0, 0.4);
        }

        th, td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        th {
            color: var(--neon-blue);
            font-family: 'Orbitron', sans-serif;
            text-transform: uppercase;
        }

        /* --- Stats --- */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: rgba(0, 255, 65, 0.05);
            border: 1px solid var(--neon-green);
            padding: 1.5rem;
            text-align: center;
        }

        .stat-number {
            font-size: 2.5rem;
            font-weight: 900;
            color: #fff;
            text-shadow: 0 0 10px var(--neon-green);
        }

        /* --- Loading --- */
        #loading {
            position: fixed;
            top:0; left:0; width:100%; height:100%;
            background: rgba(0,0,0,0.9);
            z-index: 2000;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            color: var(--neon-green);
            font-family: 'Orbitron';
            display: none;
        }
        
        /* --- Photo Upload Preview --- */
        .photo-preview {
            width: 150px;
            height: 150px;
            border: 2px dashed var(--neon-blue);
            margin-top: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            background-size: cover;
            background-position: center;
            color: #aaa;
        }

        .status-badge {
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: bold;
        }
        .status-aprovado { background: rgba(0, 255, 65, 0.2); color: var(--neon-green); border: 1px solid var(--neon-green); }
        .status-pendente { background: rgba(255, 165, 0, 0.2); color: orange; border: 1px solid orange; }
        .status-rejeitado { background: rgba(255, 0, 60, 0.2); color: var(--neon-red); border: 1px solid var(--neon-red); }

        @media (min-width: 768px) {
            nav { transform: translateX(0); width: 250px; top: 80px; left: 0; }
            main { margin-left: 260px; }
            .nav-toggle { display: none; }
        }
    </style>
</head>
<body>

    <div id="loading">
        <i class="fas fa-microchip fa-spin fa-3x"></i>
        <p style="margin-top: 15px;">PROCESSANDO DADOS QU√ÇNTICOS...</p>
    </div>

    <header>
        <div class="logo"><i class="fas fa-vote-yea"></i> TSE RP BROOKASIL</div>
        <div class="system-status" id="modeDisplay">MODO: CARREGANDO...</div>
    </header>

    <button class="nav-toggle" onclick="toggleNav()"><i class="fas fa-bars"></i> MENU</button>

    <nav id="navbar">
        <button class="nav-btn active" onclick="showSection('dashboard')"><i class="fas fa-chart-pie"></i> Painel Geral</button>
        <button class="nav-btn" onclick="showSection('candidatos')"><i class="fas fa-users"></i> Candidatos</button>
        <button class="nav-btn" onclick="showSection('registro')"><i class="fas fa-user-plus"></i> Nova Candidatura</button>
        <button class="nav-btn" onclick="showSection('partidos')"><i class="fas fa-flag"></i> Partidos</button>
        <div style="flex-grow: 1;"></div>
        <button class="nav-btn" onclick="showSection('admin-login')" id="adminBtn"><i class="fas fa-user-lock"></i> Acesso Restrito</button>
    </nav>

    <main>
        <section id="dashboard" class="section active">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="totalCount">0</div>
                    <div>Total de Candidatos</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="pendingCount" style="color: orange;">0</div>
                    <div>Pendentes</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="approvedCount" style="color: var(--neon-green);">0</div>
                    <div>Aprovados</div>
                </div>
            </div>
            
            <div class="cyber-card">
                <h2><i class="fas fa-bullhorn"></i> Status do Sistema</h2>
                <p>Bem-vindo ao Sistema Eleitoral Oficial do RP Brookasil. Utilize o menu lateral para navegar.</p>
                <div style="margin-top: 1rem; padding: 1rem; border: 1px solid var(--neon-blue); background: rgba(0, 243, 255, 0.05);">
                    <i class="fas fa-info-circle"></i> <strong>Nota:</strong> As elei√ß√µes municipais est√£o sob jurisdi√ß√£o dos TREs locais. Elei√ß√µes federais s√£o controladas pelo TSE.
                </div>
            </div>
        </section>

        <section id="candidatos" class="section">
            <div class="cyber-card">
                <h2><i class="fas fa-search"></i> Consulta P√∫blica</h2>
                <div class="form-grid">
                    <div class="input-group">
                        <label>Estado</label>
                        <select id="filterState" onchange="filterCandidates()">
                            <option value="all">Todos</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label>Cargo</label>
                        <select id="filterRole" onchange="filterCandidates()">
                            <option value="all">Todos</option>
                            <option value="Presidente">Presidente</option>
                            <option value="Governador">Governador</option>
                            <option value="Prefeito">Prefeito</option>
                            <option value="Senador">Senador</option>
                            <option value="Deputado Federal">Deputado Federal</option>
                            <option value="Deputado Estadual">Deputado Estadual</option>
                            <option value="Vereador">Vereador</option>
                        </select>
                    </div>
                </div>

                <div class="table-container">
                    <table id="publicTable">
                        <thead>
                            <tr>
                                <th>Foto</th>
                                <th>Nome/Urna</th>
                                <th>Partido</th>
                                <th>Cargo</th>
                                <th>Local</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </section>

        <section id="registro" class="section">
            <div class="cyber-card">
                <h2><i class="fas fa-file-contract"></i> Ficha de Candidatura</h2>
                <p style="color: #aaa; margin-bottom: 20px;">Preencha todos os dados. O uso de dados falsos resultar√° em banimento do RP.</p>
                
                <form id="candidateForm">
                    <div class="form-grid">
                        <div class="input-group">
                            <label>Nome Completo (RP)</label>
                            <input type="text" id="regName" required placeholder="Ex: Jo√£o da Silva">
                        </div>
                        <div class="input-group">
                            <label>Nome na Urna</label>
                            <input type="text" id="regUrna" required placeholder="Ex: Jo√£o do P√£o">
                        </div>
                    </div>

                    <div class="form-grid">
                        <div class="input-group">
                            <label>Nome do Vice / Suplente (Opcional)</label>
                            <input type="text" id="regVice" placeholder="Ex: Maria Souza">
                        </div>
                        <div class="input-group">
                            <label>Slogan de Campanha</label>
                            <input type="text" id="regSlogan" placeholder="Ex: Por um Brookasil melhor!">
                        </div>
                    </div>

                    <div class="form-grid">
                        <div class="input-group">
                            <label>Estado</label>
                            <select id="regState" required onchange="populateCities('regState', 'regCity')">
                                <option value="">Selecione...</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label>Cidade</label>
                            <select id="regCity" required>
                                <option value="">Selecione o Estado primeiro...</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-grid">
                        <div class="input-group">
                            <label>Cargo Pleiteado</label>
                            <select id="regRole" required>
                                <option value="">Selecione...</option>
                                <option value="Presidente">Presidente (Federal)</option>
                                <option value="Governador">Governador (Estadual)</option>
                                <option value="Senador">Senador (Federal)</option>
                                <option value="Deputado Federal">Deputado Federal</option>
                                <option value="Deputado Estadual">Deputado Estadual</option>
                                <option value="Prefeito">Prefeito (Municipal)</option>
                                <option value="Vereador">Vereador (Municipal)</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label>Partido</label>
                            <select id="regParty" required>
                                <option value="">Selecione...</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label>N√∫mero (Sugerido)</label>
                            <input type="number" id="regNumber" required placeholder="Ex: 10123">
                        </div>
                    </div>

                    <div class="input-group">
                        <label>Biografia Resumida</label>
                        <textarea id="regBio" rows="3" placeholder="Conte um pouco sobre sua hist√≥ria no RP..."></textarea>
                    </div>

                    <div class="input-group">
                        <label>Foto Oficial (Arquivo da Galeria)</label>
                        <input type="file" id="regPhoto" accept="image/*" required onchange="previewImage(this)">
                        <div class="photo-preview" id="previewBox">Sem Foto</div>
                        <small style="color: var(--neon-red);">* M√°ximo 500KB. Imagens pesadas ser√£o rejeitadas.</small>
                    </div>

                    <button type="button" class="btn-cyber" onclick="submitCandidacy()"><i class="fas fa-save"></i> Enviar Candidatura</button>
                </form>
            </div>
        </section>

        <section id="partidos" class="section">
            <div class="cyber-card">
                <h2>Partidos Registrados</h2>
                <div class="form-grid" id="partyList">
                    </div>
            </div>
        </section>

        <section id="admin-login" class="section">
            <div class="cyber-card" style="max-width: 500px; margin: 0 auto;">
                <h2><i class="fas fa-shield-alt"></i> Acesso Administrativo</h2>
                <div class="input-group">
                    <label>Jurisdi√ß√£o</label>
                    <select id="loginType" onchange="toggleLoginFields()">
                        <option value="TSE">TSE NACIONAL (Geral)</option>
                        <option value="TRE_EST">TRE ESTADUAL</option>
                        <option value="TRE_MUN">TRE MUNICIPAL</option>
                    </select>
                </div>

                <div class="input-group" id="loginStateGroup" style="display:none;">
                    <label>Selecione o Estado</label>
                    <select id="loginState" onchange="populateCities('loginState', 'loginCity')"></select>
                </div>

                <div class="input-group" id="loginCityGroup" style="display:none;">
                    <label>Selecione a Cidade</label>
                    <select id="loginCity"></select>
                </div>

                <div class="input-group">
                    <label>Senha de Acesso</label>
                    <input type="password" id="loginPass">
                </div>

                <button class="btn-cyber" onclick="attemptLogin()">Entrar no Sistema</button>
            </div>
        </section>

        <section id="admin-panel" class="section">
            <div class="cyber-card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 id="adminTitle">PAINEL ADMINISTRATIVO</h2>
                    <button class="btn-cyber btn-danger" onclick="logout()">Sair</button>
                </div>

                <div id="tseControls" style="display: none; padding: 15px; border: 1px solid var(--neon-purple); margin-bottom: 20px;">
                    <h3 style="color: var(--neon-purple);">Controle Nacional (TSE Exclusivo)</h3>
                    <div style="margin-top: 10px;">
                        <label>Modo da Elei√ß√£o Atual:</label>
                        <select id="adminElectionMode" style="max-width: 200px; display: inline-block;">
                            <option value="MUNICIPAL">MUNICIPAL</option>
                            <option value="ESTADUAL">ESTADUAL</option>
                            <option value="FEDERAL">FEDERAL</option>
                        </select>
                        <button class="btn-cyber" onclick="changeElectionMode()">Alterar Modo</button>
                    </div>
                </div>

                <h3>Gest√£o de Candidaturas</h3>
                <div style="margin-bottom: 10px;">
                    <button class="btn-cyber" onclick="renderAdminTable('PENDENTE')">Ver Pendentes</button>
                    <button class="btn-cyber" onclick="renderAdminTable('APROVADO')">Ver Aprovados</button>
                    <button class="btn-cyber" onclick="renderAdminTable('REJEITADO')">Ver Recusados</button>
                </div>

                <div class="table-container">
                    <table id="adminTable">
                        <thead>
                            <tr>
                                <th>Candidato</th>
                                <th>Cargo</th>
                                <th>Local</th>
                                <th>Status</th>
                                <th>A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </section>

    </main>

    <script>
        // --- CONFIGURA√á√ÉO E DADOS --- //
        const DB_URL = "https://candidatura-cde-default-rtdb.firebaseio.com";
        
        // Hashes SHA256 das senhas para n√£o ficarem expostas em texto plano
        // Senha TSE: "Brookasil1234"
const HASH_TSE = "68c94982181f086e1e3556947702830f06530a21f64966601f016572e008f1f7";

const ESTADOS_DATA = [
    { 
        id: "BK", 
        name: "Brookhaven", 
        responsible: "Tutu Prot√°sio", 
        passHash: "cf83e1357eefb8bdf1542850d66d8007d620e4050b5715dc83f4a921d36ce9ce", // TRE_BROOKHAVEN_2024
        cities: ["Cidade Eleitoral", "Liberty City"]
    },
    { 
        id: "NC", 
        name: "Novacore", 
        responsible: "William Harris", 
        passHash: "5e884898da28047151d0e56f8dc6292773603d0d6aabbdd62a11ef721d1542d8", // TRE_NOVACORE_2024
        cities: ["Nexaville", "Sol√°ria"]
    },
    { 
        id: "CB", 
        name: "Caster√≠ber", 
        responsible: "Henrique Camilote", 
        passHash: "a52e690f0322e70e97261947e4f3a778c199589d81373562621c43d8380e210a", // TRE_CASTERIBER_2024
        cities: ["Castelo Verde", "Monte Prata"]
    },
    { 
        id: "FM", 
        name: "Fortemega", 
        responsible: "Lucas Santos", 
        passHash: "81373562621c43d8380e210aa52e690f0322e70e97261947e4f3a778c199589d", // TRE_FORTEMEGA_2024
        cities: ["Marinha City", "Porto Rubi"]
    },
    { 
        id: "FX", 
        name: "Flor√™mix", 
        responsible: "Rhyan Kalleby", 
        passHash: "1e3556947702830f06530a21f64966601f016572e008f1f768c94982181f086e", // TRE_FLOREMIX_2024
        cities: ["Flor√°polis", "Riomarina"]
    }
];

        // Mapeamento simples de senha para demonstra√ß√£o funcional segura
        // Na pr√°tica real, use autentica√ß√£o server-side. Aqui, ofuscamos.
        // Senhas originais:
        // TSE: Brookasil1234
        // Estados: TRE_NOMEDOESTADO_2024
        // Cidades: TRE_NOMEDACIDADE_2024

        const PARTIES = {
    direita: [
        { number: "22", name: "Partido Liberal (PL)", color: "#0B3C5D" },
        { number: "11", name: "Progressistas (PP)", color: "#1E90FF" },
        { number: "10", name: "Republicanos", color: "#4169E1" },
        { number: "30", name: "Partido Novo (NOVO)", color: "#00BFFF" },
        { number: "25", name: "Partido Renova√ß√£o Democr√°tica (PRD)", color: "#0047AB" }, // Fus√£o PTB+Patriota
        { number: "51", name: "Patriota", color: "#2F4F4F" }, // Mantido conforme pedido (legado)
        { number: "28", name: "Partido Renovador Trabalhista Brasileiro (PRTB)", color: "#4682B4" },
        { number: "27", name: "Democracia Crist√£ (DC)", color: "#5F9EA0" },
        { number: "36", name: "Agir", color: "#6495ED" },
        { number: "35", name: "Partido da Mulher Brasileira (PMB)", color: "#87CEFA" },

        // üîπ FICT√çCIOS
        { number: "38", name: "Uni√£o da Direita Brookasileira (UDB)", color: "#003366" },
        { number: "81", name: "Partido da Ordem e Liberdade (POL)", color: "#1C1C1C" },
        { number: "84", name: "Alian√ßa Crist√£ Nacional (ACN)", color: "#2E8B57" },
        { number: "57", name: "Partido da Reedifica√ß√£o da Ordem Nacional (PRONA)", color: "#000080" },
        { number: "48", name: "Partido da Esperan√ßa (PESP)", color: "#228B22" },
        { number: "86", name: "Partido Militar Nacionalista (PMNL)", color: "#556B2F" },
        { number: "75", name: "Partido Republicano Trabalhista Nacional (PRTN)", color: "#191970" }
    ],

    centro: [
        { number: "15", name: "Movimento Democr√°tico Brasileiro (MDB)", color: "#FFD700" },
        { number: "44", name: "Uni√£o Brasil", color: "#FFA500" },
        { number: "55", name: "Partido Social Democr√°tico (PSD)", color: "#FFB347" },
        { number: "45", name: "Partido da Social Democracia Brasileira (PSDB)", color: "#FFDAB9" },
        { number: "23", name: "Cidadania", color: "#EC008C" }, // Adicionado (Federa√ß√£o com PSDB)
        { number: "20", name: "Podemos", color: "#FF8C00" },
        { number: "77", name: "Solidariedade", color: "#F4A460" },
        { number: "70", name: "Avante", color: "#DAA520" },
        { number: "33", name: "Partido da Mobiliza√ß√£o Nacional (PMN)", color: "#EEC900" },
        { number: "43", name: "Partido Verde (PV)", color: "#9ACD32" },

        // üîπ FICT√çCIOS
        { number: "42", name: "Partido da Uni√£o Nacional (PUN)", color: "#F5DEB3" },
        { number: "37", name: "Movimento Popular Democr√°tico (MPD)", color: "#FFD966" },
        { number: "26", name: "Partido da Mudan√ßa (PDM)", color: "#FFC04D" },
        { number: "63", name: "Movimento Trabalhista Brookasileiro (MTB)", color: "#FFE4B5" },
        { number: "46", name: "Partido Trabalhista Democr√°tico (PTD)", color: "#FFD39B" },
        { number: "88", name: "Partido do Sindicato Democrata (PDSD)", color: "#EEDC82" },
        { number: "14", name: "Partido Miss√£o (MSS)", color: "#FFCC99" },
        { number: "85", name: "Partido Constru√ß√£o (PC)", color: "#F0E68C" }
    ],

    esquerda: [
        { number: "13", name: "Partido dos Trabalhadores (PT)", color: "#CC0000" },
        { number: "50", name: "Partido Socialismo e Liberdade (PSOL)", color: "#FF4C4C" },
        { number: "65", name: "Partido Comunista do Brasil (PCdoB)", color: "#B22222" },
        { number: "12", name: "Partido Democr√°tico Trabalhista (PDT)", color: "#DC143C" },
        { number: "40", name: "Partido Socialista Brasileiro (PSB)", color: "#E60026" },
        { number: "18", name: "Rede Sustentabilidade (REDE)", color: "#32CD32" },
        { number: "80", name: "Unidade Popular (UP)", color: "#8B0000" },
        { number: "29", name: "Partido da Causa Oper√°ria (PCO)", color: "#A00000" },
        { number: "21", name: "Partido Comunista Brasileiro (PCB)", color: "#7B0000" },
        { number: "16", name: "Partido Socialista dos Trabalhadores Unificado (PSTU)", color: "#FF0000" },
        { number: "54", name: "Partido P√°tria Livre (PPL)", color: "#C00000" },

        // üîπ FICT√çCIOS
        { number: "60", name: "Partido da Frente Socialista (PFS)", color: "#B30000" },
        { number: "56", name: "Partido Socialista (PS)", color: "#990000" },
        { number: "31", name: "Partido Social Trabalhista Nacional (PSTN)", color: "#CD2626" }
    ]
};

        let currentUser = null; // { role: 'TSE'|'TRE_EST'|'TRE_MUN', scope: 'ALL'|stateId|cityId }
        let currentCandidates = {};
        let systemMode = "MUNICIPAL"; // Carregado do banco

        // --- INICIALIZA√á√ÉO --- //
        document.addEventListener('DOMContentLoaded', () => {
            loadParties();
            populateStates();
            fetchData();
            
            // Intervalo para atualizar dados (Polling simples j√° que √© REST)
            setInterval(fetchData, 10000); 
        });

        function toggleNav() {
            document.getElementById('navbar').classList.toggle('open');
        }

        function showSection(id) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            event.currentTarget.classList.add('active');
            
            if(window.innerWidth < 768) toggleNav();
        }

        function populateStates() {
            const sels = [document.getElementById('regState'), document.getElementById('filterState'), document.getElementById('loginState')];
            sels.forEach(sel => {
                if(!sel) return;
                STATES.forEach(st => {
                    let opt = document.createElement('option');
                    opt.value = st.id;
                    opt.innerText = st.name;
                    sel.appendChild(opt);
                });
            });
        }

        function populateCities(stateIdElement, cityIdElement) {
            const stVal = document.getElementById(stateIdElement).value;
            const citySel = document.getElementById(cityIdElement);
            citySel.innerHTML = '<option value="">Selecione...</option>';
            
            if(CITIES[stVal]) {
                CITIES[stVal].forEach(c => {
                    let opt = document.createElement('option');
                    opt.value = c;
                    opt.innerText = c;
                    citySel.appendChild(opt);
                });
            }
        }

        function loadParties() {
            const pList = document.getElementById('partyList');
            const pSelect = document.getElementById('regParty');
            
            PARTIES.forEach(p => {
                // Card
                pList.innerHTML += `
                    <div class="stat-card" style="border-left: 5px solid ${p.color}; text-align: left;">
                        <h3 style="font-size: 1.5rem;">${p.num}</h3>
                        <p>${p.name}</p>
                    </div>
                `;
                // Select
                let opt = document.createElement('option');
                opt.value = `${p.name} (${p.num})`;
                opt.innerText = `${p.num} - ${p.name}`;
                pSelect.appendChild(opt);
            });
        }

        // --- MANIPULA√á√ÉO DE IMAGEM --- //
        function previewImage(input) {
            const box = document.getElementById('previewBox');
            if (input.files && input.files[0]) {
                if(input.files[0].size > 512000) { // 500kb
                    alert("Imagem muito grande! M√°ximo 500KB.");
                    input.value = "";
                    return;
                }
                const reader = new FileReader();
                reader.onload = function(e) {
                    box.style.backgroundImage = `url(${e.target.result})`;
                    box.innerText = "";
                    input.dataset.base64 = e.target.result;
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        // --- INTEGRA√á√ÉO FIREBASE (REST) --- //
        async function fetchData() {
            try {
                // Pegar candidatos
                const resC = await fetch(`${DB_URL}/candidatos.json`);
                const dataC = await resC.json();
                currentCandidates = dataC || {};
                
                // Pegar configura√ß√µes
                const resM = await fetch(`${DB_URL}/config/mode.json`);
                const mode = await resM.json();
                if(mode) {
                    systemMode = mode;
                    document.getElementById('modeDisplay').innerText = "MODO: " + systemMode;
                    document.getElementById('adminElectionMode').value = systemMode;
                }

                updateDashboard();
                renderPublicTable();
                if(currentUser) renderAdminTable('PENDENTE'); // Refresh admin if open

            } catch (e) {
                console.error("Erro de conex√£o:", e);
            }
        }

        async function saveToFirebase(path, data, method = 'POST') {
            document.getElementById('loading').style.display = 'flex';
            try {
                const res = await fetch(`${DB_URL}/${path}.json`, {
                    method: method,
                    body: JSON.stringify(data),
                    headers: { 'Content-Type': 'application/json' }
                });
                return await res.json();
            } catch(e) {
                alert("Erro ao salvar: " + e.message);
            } finally {
                document.getElementById('loading').style.display = 'none';
                fetchData();
            }
        }

        async function deleteFromFirebase(id) {
            if(!confirm("Tem certeza que deseja apagar este registro permanentemente?")) return;
            document.getElementById('loading').style.display = 'flex';
            await fetch(`${DB_URL}/candidatos/${id}.json`, { method: 'DELETE' });
            document.getElementById('loading').style.display = 'none';
            fetchData();
        }

        // --- L√ìGICA DE NEG√ìCIO --- //

        function updateDashboard() {
            const values = Object.values(currentCandidates);
            document.getElementById('totalCount').innerText = values.length;
            document.getElementById('pendingCount').innerText = values.filter(c => c.status === 'PENDENTE').length;
            document.getElementById('approvedCount').innerText = values.filter(c => c.status === 'APROVADO').length;
        }

        async function submitCandidacy() {
            // Verificar modo de elei√ß√£o para TRE Municipal (apenas registra se for municipal)
            // Mas aqui √© o registro p√∫blico. Vamos permitir o registro, mas o TRE aprova.
            
            const name = document.getElementById('regName').value;
            const urna = document.getElementById('regUrna').value;
            const state = document.getElementById('regState').value;
            const city = document.getElementById('regCity').value;
            const role = document.getElementById('regRole').value;
            const party = document.getElementById('regParty').value;
            const number = document.getElementById('regNumber').value;
            const photoInput = document.getElementById('regPhoto');
            
            if(!name || !urna || !state || !city || !role || !party || !number || !photoInput.dataset.base64) {
                alert("Preencha todos os campos obrigat√≥rios e envie uma foto.");
                return;
            }

            // Valida√ß√£o TRE Municipal vs Modo
            // O enunciado diz: "TRE Municipal: Registrar somente registrar quando a elei√ß√£o for municipal".
            // Isso geralmente se aplica ao painel do Admin registrando, mas vamos deixar o p√∫blico se registrar e o admin filtra.

            const candidate = {
                name, urna, state, city, role, party, number,
                vice: document.getElementById('regVice').value,
                slogan: document.getElementById('regSlogan').value,
                bio: document.getElementById('regBio').value,
                photo: photoInput.dataset.base64,
                status: 'PENDENTE',
                timestamp: Date.now()
            };

            await saveToFirebase('candidatos', candidate);
            alert("Candidatura enviada para an√°lise do TRE!");
            document.getElementById('candidateForm').reset();
            document.getElementById('previewBox').style.backgroundImage = 'none';
            document.getElementById('previewBox').innerText = 'Sem Foto';
            showSection('dashboard');
        }

        function renderPublicTable() {
            const tbody = document.querySelector('#publicTable tbody');
            tbody.innerHTML = '';
            
            // Filtros
            const fState = document.getElementById('filterState').value;
            const fRole = document.getElementById('filterRole').value;

            Object.values(currentCandidates).forEach(c => {
                if(c.status !== 'APROVADO') return; // P√∫blico s√≥ v√™ aprovado
                if(fState !== 'all' && c.state !== fState) return;
                if(fRole !== 'all' && c.role !== fRole) return;

                const stName = STATES.find(s=>s.id === c.state)?.name || c.state;

                tbody.innerHTML += `
                    <tr>
                        <td><div style="width:50px; height:50px; background-image:url('${c.photo}'); background-size:cover; border-radius:50%;"></div></td>
                        <td>
                            <strong>${c.urna}</strong> (${c.number})<br>
                            <span style="font-size:0.8rem; color:#aaa;">${c.name}</span>
                        </td>
                        <td>${c.party}</td>
                        <td style="color:var(--neon-blue)">${c.role}</td>
                        <td>${c.city} - ${stName}</td>
                        <td><span class="status-badge status-aprovado">Aprovado</span></td>
                    </tr>
                `;
            });
        }

        function filterCandidates() {
            renderPublicTable();
        }

        // --- SISTEMA ADMIN --- //

        function toggleLoginFields() {
            const type = document.getElementById('loginType').value;
            document.getElementById('loginStateGroup').style.display = (type === 'TRE_EST' || type === 'TRE_MUN') ? 'block' : 'none';
            document.getElementById('loginCityGroup').style.display = (type === 'TRE_MUN') ? 'block' : 'none';
        }

        function hashPassword(pass) {
            return CryptoJS.SHA256(pass).toString();
        }

        function attemptLogin() {
            const type = document.getElementById('loginType').value;
            const pass = document.getElementById('loginPass').value;
            const state = document.getElementById('loginState').value;
            const city = document.getElementById('loginCity').value;

            const inputHash = hashPassword(pass);

            // VALIDA√á√ÉO DE SENHAS (MOCK)
            // Senha TSE real: Brookasil1234
            // Senha Estado: TRE_NOMEDOESTADO_2024
            // Senha Cidade: TRE_NOMEDACIDADE_2024
            
            let authenticated = false;
            let userRole = null;
            let userScope = null;
            let userName = "";

            if (type === 'TSE') {
                // Hash de "Brookasil1234"
                if (inputHash === "e119560f85532577603417730e2060377f0a7114b7e1c8411d73a7d40026e632") {
                    authenticated = true;
                    userRole = 'TSE';
                    userScope = 'ALL';
                    userName = "Ministro TSE";
                }
            } else if (type === 'TRE_EST') {
                const targetState = STATES.find(s => s.id === state);
                // Verifica padr√£o de senha: TRE_NOME_2024 (Exemplo simples, idealmente usaria hash do banco)
                const correctPass = `TRE_${targetState.name.toUpperCase()}_2024`;
                if (pass === correctPass) {
                    authenticated = true;
                    userRole = 'TRE_EST';
                    userScope = state;
                    userName = `Desembargador ${targetState.name}`;
                }
            } else if (type === 'TRE_MUN') {
                const correctPass = `TRE_${city.toUpperCase().replace(/\s/g, '_')}_2024`;
                if (pass === correctPass) {
                    authenticated = true;
                    userRole = 'TRE_MUN';
                    userScope = { state: state, city: city };
                    userName = `Juiz Eleitoral ${city}`;
                }
            }

            if (authenticated) {
                currentUser = { role: userRole, scope: userScope, name: userName };
                document.getElementById('adminPass').value = ""; // Clear pass
                setupAdminUI();
                showSection('admin-panel');
            } else {
                alert("Credenciais Inv√°lidas! Acesso negado.");
            }
        }

        function setupAdminUI() {
            document.getElementById('adminTitle').innerText = `${currentUser.name} - ${currentUser.role}`;
            document.getElementById('tseControls').style.display = (currentUser.role === 'TSE') ? 'block' : 'none';
            renderAdminTable('PENDENTE');
        }

        function logout() {
            currentUser = null;
            showSection('admin-login');
        }

        async function changeElectionMode() {
            const newMode = document.getElementById('adminElectionMode').value;
            await saveToFirebase('config/mode', newMode, 'PUT');
            alert("Modo de elei√ß√£o alterado para: " + newMode);
        }

        function renderAdminTable(statusFilter) {
            const tbody = document.querySelector('#adminTable tbody');
            tbody.innerHTML = '';
            
            Object.entries(currentCandidates).forEach(([key, c]) => {
                // Filtro de Status
                if(c.status !== statusFilter) return;

                // Filtro de Jurisdi√ß√£o (RBAC)
                if(currentUser.role === 'TRE_EST') {
                    if(c.state !== currentUser.scope) return;
                }
                if(currentUser.role === 'TRE_MUN') {
                    if(c.city !== currentUser.scope.city) return;
                }

                // Renderiza√ß√£o
                let actions = '';
                if(c.status === 'PENDENTE') {
                    actions = `
                        <button class="btn-cyber" style="padding:5px 10px; font-size:0.8rem;" onclick="updateStatus('${key}', 'APROVADO')"><i class="fas fa-check"></i></button>
                        <button class="btn-cyber btn-danger" style="padding:5px 10px; font-size:0.8rem;" onclick="updateStatus('${key}', 'REJEITADO')"><i class="fas fa-times"></i></button>
                    `;
                } else if (c.status === 'APROVADO') {
                     actions = `
                        <button class="btn-cyber btn-danger" style="padding:5px 10px; font-size:0.8rem;" onclick="deleteFromFirebase('${key}')"><i class="fas fa-trash"></i> Retirar</button>
                    `;
                } else {
                    actions = `
                        <button class="btn-cyber btn-danger" style="padding:5px 10px; font-size:0.8rem;" onclick="deleteFromFirebase('${key}')"><i class="fas fa-trash"></i></button>
                    `;
                }

                // Restri√ß√£o TRE Municipal (S√≥ registra/mexe se for municipal)
                if(currentUser.role === 'TRE_MUN' && systemMode !== 'MUNICIPAL') {
                    actions = '<small style="color:gray">Elei√ß√£o n√£o Municipal</small>';
                }

                tbody.innerHTML += `
                    <tr>
                        <td>${c.urna}</td>
                        <td>${c.role}</td>
                        <td>${c.city}</td>
                        <td><span class="status-badge status-${c.status.toLowerCase()}">${c.status}</span></td>
                        <td>${actions}</td>
                    </tr>
                `;
            });
        }

        async function updateStatus(key, newStatus) {
            // Verifica permiss√£o TRE Municipal novamente
            if(currentUser.role === 'TRE_MUN' && systemMode !== 'MUNICIPAL') {
                alert("O TRE Municipal n√£o tem jurisdi√ß√£o enquanto o modo da elei√ß√£o n√£o for MUNICIPAL.");
                return;
            }

            await saveToFirebase(`candidatos/${key}/status`, newStatus, 'PUT');
        }

    </script>
</body>
</html>
