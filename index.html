<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TSE RP OFICIAL | SISTEMA DE ESTADO</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100;300;400;600&family=Orbitron:wght@400;700;900&family=Space+Grotesk:wght@300;500;700&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* * ============================================================
         * üé® CORE DESIGN & VARIABLES
         * ============================================================
         */
        :root {
            /* Palette - Dark Cyber State */
            --bg-obsidian: #05070D;
            --bg-midnight: #0A1024;
            --accent-sapphire: #00F0FF;
            --accent-neon-green: #0AFF60;
            --accent-gold: #D4AF37;
            --accent-error: #FF2A2A;
            
            /* Glassmorphism */
            --glass-bg: rgba(255, 255, 255, 0.03);
            --glass-border: rgba(255, 255, 255, 0.08);
            --glass-blur: blur(20px);
            --glass-glow: 0 0 20px rgba(0, 240, 255, 0.1);

            /* Typography */
            --font-display: 'Orbitron', sans-serif;
            --font-tech: 'Space Grotesk', sans-serif;
            --font-body: 'Inter', sans-serif;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            outline: none;
            user-select: none; /* Interface app-like */
        }

        body {
            background-color: var(--bg-obsidian);
            color: #ffffff;
            font-family: var(--font-body);
            height: 100vh;
            width: 100vw;
            overflow: hidden; /* SPA Fixed */
            display: flex;
            justify-content: center;
            align-items: center;
            perspective: 1000px;
        }

        /* Fundo Animado Complexo */
        .ambient-bg {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -2;
            background: radial-gradient(circle at 50% 50%, #0d1630 0%, #05070D 80%);
            overflow: hidden;
        }

        .ambient-orb {
            position: absolute;
            border-radius: 50%;
            filter: blur(80px);
            opacity: 0.4;
            animation: floatOrb 20s infinite alternate ease-in-out;
        }
        .orb-1 { width: 600px; height: 600px; background: #001f3f; top: -20%; left: -10%; }
        .orb-2 { width: 500px; height: 500px; background: #0b2e13; bottom: -20%; right: -10%; animation-delay: -5s; }
        
        .noise-overlay {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI1MDAiIGhlaWdodD0iNTAwIj48ZmlsdGVyIGlkPSJnoiPjxmZVR1cmJ1bGVuY2UgdHlwZT0iZnJhY3RhbE5vaXNlIiBiYXNlRnJlcXVlbmN5PSIwLjY1IiBudW1PY3RhdmVzPSIzIiBzdGl0Y2hUaWxlcz0ic3RpdGNoIi8+PC9maWx0ZXI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsdGVyPSJ1cmwoI2cpIiBvcGFjaXR5PSIwLjAzIi8+PC9zdmc+');
            pointer-events: none;
            z-index: -1;
            opacity: 0.5;
        }

        /* * ============================================================
         * üßä GLASS SYSTEM & LAYOUT
         * ============================================================
         */
        #app-container {
            width: 95vw;
            height: 90vh;
            display: grid;
            grid-template-columns: 280px 1fr;
            gap: 20px;
            position: relative;
        }

        .glass-panel {
            background: var(--glass-bg);
            backdrop-filter: var(--glass-blur);
            -webkit-backdrop-filter: var(--glass-blur);
            border: 1px solid var(--glass-border);
            border-radius: 16px;
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.5);
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        /* Cursor Glow Effect */
        .glass-panel::before {
            content: '';
            position: absolute;
            top: var(--y, -100px);
            left: var(--x, -100px);
            width: 200px;
            height: 200px;
            background: radial-gradient(circle, rgba(255,255,255,0.06) 0%, transparent 70%);
            transform: translate(-50%, -50%);
            pointer-events: none;
            transition: opacity 0.5s;
        }

        /* Sidebar */
        aside {
            display: flex;
            flex-direction: column;
            padding: 30px;
            justify-content: space-between;
            z-index: 10;
        }

        .brand {
            font-family: var(--font-display);
            font-weight: 900;
            font-size: 1.8rem;
            letter-spacing: 2px;
            background: linear-gradient(90deg, #fff, var(--accent-sapphire));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 40px;
            text-transform: uppercase;
        }

        nav button {
            background: transparent;
            border: none;
            width: 100%;
            text-align: left;
            padding: 15px 20px;
            margin-bottom: 10px;
            color: rgba(255,255,255,0.6);
            font-family: var(--font-tech);
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            border-left: 2px solid transparent;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        nav button:hover, nav button.active {
            color: var(--accent-sapphire);
            background: rgba(0, 240, 255, 0.05);
            border-left: 2px solid var(--accent-sapphire);
            box-shadow: 0 0 15px rgba(0, 240, 255, 0.1);
        }

        /* Status Widget */
        .status-widget {
            padding: 15px;
            background: rgba(0,0,0,0.3);
            border-radius: 8px;
            font-size: 0.8rem;
        }
        .status-dot {
            height: 8px; width: 8px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
            background: var(--accent-neon-green);
            box-shadow: 0 0 8px var(--accent-neon-green);
        }

        /* Main Content Area */
        main {
            padding: 40px;
            overflow-y: auto;
            position: relative;
        }

        /* Scrollbar custom */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: rgba(0,0,0,0.2); }
        ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 3px; }

        /* * ============================================================
         * üìë VIEWS & COMPONENTS
         * ============================================================
         */
        .view-section {
            display: none;
            animation: fadeIn 0.6s cubic-bezier(0.16, 1, 0.3, 1);
        }
        .view-section.active { display: block; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); filter: blur(10px); }
            to { opacity: 1; transform: translateY(0); filter: blur(0); }
        }

        /* Typography Styles */
        h1 {
            font-family: var(--font-display);
            font-size: 2.5rem;
            margin-bottom: 10px;
            letter-spacing: -1px;
        }
        h2 {
            font-family: var(--font-tech);
            font-size: 1.2rem;
            color: var(--accent-sapphire);
            margin-bottom: 30px;
            text-transform: uppercase;
        }

        /* Cards Grid */
        .cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
        }

        .candidate-card {
            background: rgba(255,255,255,0.02);
            border: 1px solid rgba(255,255,255,0.05);
            padding: 20px;
            border-radius: 12px;
            position: relative;
            transition: 0.3s;
        }
        .candidate-card:hover {
            transform: translateY(-5px);
            border-color: var(--accent-sapphire);
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        .tag-ideology {
            position: absolute;
            top: 10px; right: 10px;
            font-size: 0.7rem;
            padding: 4px 8px;
            border-radius: 4px;
            text-transform: uppercase;
            font-weight: bold;
        }
        .ideology-left { background: rgba(255, 42, 42, 0.2); color: #ff6b6b; border: 1px solid rgba(255, 42, 42, 0.4); }
        .ideology-center { background: rgba(255, 255, 255, 0.1); color: #fff; border: 1px solid rgba(255, 255, 255, 0.3); }
        .ideology-right { background: rgba(0, 119, 255, 0.2); color: #4dabff; border: 1px solid rgba(0, 119, 255, 0.4); }

        .card-number {
            font-family: var(--font-display);
            font-size: 2rem;
            color: var(--accent-sapphire);
            margin: 15px 0;
            text-shadow: 0 0 15px rgba(0, 240, 255, 0.4);
        }

        /* FORM STYLES */
        .form-group { margin-bottom: 25px; position: relative; }
        label {
            display: block;
            font-family: var(--font-tech);
            font-size: 0.8rem;
            margin-bottom: 8px;
            color: rgba(255,255,255,0.7);
            text-transform: uppercase;
        }
        input, select {
            width: 100%;
            background: rgba(0,0,0,0.4);
            border: 1px solid rgba(255,255,255,0.1);
            color: #fff;
            padding: 15px;
            border-radius: 8px;
            font-family: var(--font-body);
            font-size: 1rem;
            transition: 0.3s;
        }
        input:focus, select:focus {
            border-color: var(--accent-sapphire);
            box-shadow: 0 0 15px rgba(0, 240, 255, 0.1);
        }
        
        .btn-main {
            background: linear-gradient(135deg, var(--bg-midnight), #1a2744);
            border: 1px solid var(--accent-sapphire);
            color: var(--accent-sapphire);
            padding: 15px 40px;
            font-family: var(--font-display);
            font-weight: bold;
            text-transform: uppercase;
            cursor: pointer;
            border-radius: 4px;
            transition: 0.4s;
            position: relative;
            overflow: hidden;
            letter-spacing: 2px;
            width: 100%;
            margin-top: 20px;
        }
        .btn-main:hover {
            background: var(--accent-sapphire);
            color: #000;
            box-shadow: 0 0 30px rgba(0, 240, 255, 0.6);
        }

        /* Steps */
        .step-indicator {
            display: flex;
            margin-bottom: 30px;
            gap: 10px;
        }
        .step {
            flex: 1;
            height: 4px;
            background: rgba(255,255,255,0.1);
            border-radius: 2px;
            transition: 0.3s;
        }
        .step.active { background: var(--accent-sapphire); box-shadow: 0 0 10px var(--accent-sapphire); }

        /* Loader */
        .loader-overlay {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(5,7,13,0.9);
            z-index: 100;
            display: flex;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(10px);
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }
        .loader-overlay.active { opacity: 1; pointer-events: all; }
        .spinner {
            width: 50px; height: 50px;
            border: 3px solid rgba(0, 240, 255, 0.3);
            border-top: 3px solid var(--accent-sapphire);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin { 100% { transform: rotate(360deg); } }
        @keyframes floatOrb { 0% { transform: translate(0,0); } 100% { transform: translate(50px, 50px); } }

        /* Admin Table */
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { text-align: left; padding: 15px; border-bottom: 1px solid rgba(255,255,255,0.05); }
        th { color: var(--accent-sapphire); font-family: var(--font-tech); text-transform: uppercase; font-size: 0.8rem; }
        .status-badge { padding: 5px 10px; border-radius: 4px; font-size: 0.7rem; text-transform: uppercase; }
        .status-badge.pendente { background: rgba(255,255,0,0.2); color: #ffeb3b; }
        .status-badge.aprovado { background: rgba(10, 255, 96, 0.2); color: #0aff60; }
        .status-badge.indeferido { background: rgba(255, 42, 42, 0.2); color: #ff2a2a; }

        .admin-controls { display: flex; gap: 10px; }
        .btn-mini { padding: 5px 10px; border: none; cursor: pointer; border-radius: 4px; font-weight: bold; }
        .btn-approve { background: var(--accent-neon-green); color: #000; }
        .btn-reject { background: var(--accent-error); color: #fff; }

        /* Welcome Screen specifics */
        .hero-title {
            font-size: 4rem;
            line-height: 1;
            background: linear-gradient(180deg, #fff, #8892b0);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .hero-subtitle {
            font-size: 1.5rem;
            color: var(--accent-sapphire);
            margin-top: 10px;
            font-family: var(--font-tech);
        }

        /* Notifica√ß√£o */
        #toast-container {
            position: fixed;
            bottom: 30px;
            right: 30px;
            z-index: 200;
        }
        .toast {
            background: rgba(10, 16, 36, 0.95);
            border-left: 4px solid var(--accent-sapphire);
            color: #fff;
            padding: 15px 25px;
            margin-top: 10px;
            border-radius: 4px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            gap: 15px;
            animation: slideIn 0.3s ease-out;
            min-width: 300px;
        }
        .toast.error { border-color: var(--accent-error); }
        .toast.success { border-color: var(--accent-neon-green); }
        
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

    </style>
</head>
<body>

    <div class="ambient-bg">
        <div class="ambient-orb orb-1"></div>
        <div class="ambient-orb orb-2"></div>
    </div>
    <div class="noise-overlay"></div>
    <div class="loader-overlay" id="global-loader"><div class="spinner"></div></div>

    <div id="app-container">
        
        <aside class="glass-panel">
            <div>
                <div class="brand">
                    <i class="fas fa-landmark"></i> TSE RP
                </div>
                
                <nav>
                    <button onclick="nav.goto('home')" class="active" id="nav-home">
                        <i class="fas fa-home"></i> In√≠cio
                    </button>
                    <button onclick="nav.goto('consult')" id="nav-consult">
                        <i class="fas fa-search"></i> Consultar
                    </button>
                    <button onclick="nav.goto('register')" id="nav-register">
                        <i class="fas fa-id-card"></i> Candidatura
                    </button>
                    <button onclick="nav.goto('admin-login')" id="nav-admin">
                        <i class="fas fa-user-shield"></i> Admin
                    </button>
                </nav>
            </div>

            <div class="status-widget glass-panel" style="border:none; background: rgba(0,0,0,0.2);">
                <div><span class="status-dot"></span> SISTEMA ONLINE</div>
                <div style="margin-top:5px; opacity: 0.7; font-size: 0.7rem;" id="mode-display">
                    MODO: CARREGANDO...
                </div>
            </div>
        </aside>

        <main class="glass-panel" id="main-viewport">
            
            <section id="view-home" class="view-section active">
                <div style="height: 100%; display: flex; flex-direction: column; justify-content: center; align-items: flex-start;">
                    <h1 class="hero-title">ELEITORAL<br>CITY 2026</h1>
                    <div class="hero-subtitle">SISTEMA ELEITORAL ESTATAL</div>
                    <p style="margin-top: 20px; max-width: 500px; line-height: 1.6; opacity: 0.8;">
                        Bem-vindo ao portal oficial. Este sistema utiliza criptografia estatal de ponta para garantir a integridade do processo democr√°tico de Eleitoral City e da Federa√ß√£o Brookasil.
                    </p>
                    
                    <div style="margin-top: 40px; display: flex; gap: 20px;">
                        <button class="btn-main" onclick="nav.goto('register')" style="width: auto;">
                            <i class="fas fa-pen-nib"></i> Registrar Candidatura
                        </button>
                        <button class="btn-main" onclick="nav.goto('consult')" style="width: auto; background: transparent; border-color: rgba(255,255,255,0.2); color: #fff;">
                            <i class="fas fa-list"></i> Ver Candidatos
                        </button>
                    </div>
                </div>
            </section>

            <section id="view-register" class="view-section">
                <h1>REGISTRO DE CANDIDATURA</h1>
                <h2 id="reg-subtitle">Iniciando protocolo seguro...</h2>

                <div class="step-indicator">
                    <div class="step active" id="step-1-dot"></div>
                    <div class="step" id="step-2-dot"></div>
                    <div class="step" id="step-3-dot"></div>
                </div>

                <form id="reg-form" onsubmit="event.preventDefault();">
                    
                    <div id="step-1">
                        <div class="form-group">
                            <label>Nome Completo (RG)</label>
                            <input type="text" id="reg-nome" required placeholder="Ex: Jo√£o da Silva">
                        </div>
                        <div class="form-group">
                            <label>Usu√°rio TikTok (@)</label>
                            <input type="text" id="reg-tiktok" required placeholder="@usuario">
                        </div>
                        <div class="form-group">
                            <label>Partido / Ideologia</label>
                            <select id="reg-partido" onchange="logic.updatePartyInfo()" required>
                                <option value="">Selecione o Partido...</option>
                                </select>
                        </div>
                        <div id="party-info" style="margin-bottom: 20px; font-size: 0.9rem; color: var(--accent-sapphire);"></div>
                        
                        <button class="btn-main" onclick="logic.nextStep(1)">PR√ìXIMO <i class="fas fa-chevron-right"></i></button>
                    </div>

                    <div id="step-2" style="display:none;">
                        <div class="form-group">
                            <label>Cargo Pretendido</label>
                            <select id="reg-cargo" onchange="logic.updateLocationFields()" required>
                                </select>
                        </div>

                        <div class="form-group" id="group-estado" style="display:none;">
                            <label>Estado</label>
                            <select id="reg-estado" onchange="logic.updateCityField()">
                                <option value="">Selecione o Estado...</option>
                                <option value="Brookhaven">Brookhaven</option>
                                <option value="Novacore">Novacore</option>
                                <option value="Caster√≠ber">Caster√≠ber</option>
                                <option value="Fortemega">Fortemega</option>
                                <option value="Flor√™mix">Flor√™mix</option>
                            </select>
                        </div>

                        <div class="form-group" id="group-cidade" style="display:none;">
                            <label>Cidade</label>
                            <select id="reg-cidade">
                                </select>
                        </div>

                        <button class="btn-main" onclick="logic.nextStep(2)">PR√ìXIMO <i class="fas fa-chevron-right"></i></button>
                        <button class="btn-main" onclick="logic.prevStep(2)" style="background: transparent; border: none; color: #fff; margin-top: 10px;">Voltar</button>
                    </div>

                    <div id="step-3" style="display:none;">
                        <div class="glass-panel" style="padding: 20px; background: rgba(0,0,0,0.3); margin-bottom: 20px;">
                            <p id="review-data" style="line-height: 1.8; font-size: 0.9rem;"></p>
                        </div>

                        <div class="form-group">
                            <label>N√∫mero da Urna</label>
                            <div style="display: flex; gap: 10px; align-items: center;">
                                <input type="text" id="reg-num-prefix" readonly style="width: 80px; text-align: center; color: var(--accent-sapphire); font-weight: bold;" title="Prefixo do Partido">
                                <input type="number" id="reg-num-user" placeholder="Digitos Finais" required style="letter-spacing: 5px; font-size: 1.2rem;">
                            </div>
                            <small style="color: rgba(255,255,255,0.5); display: block; margin-top: 5px;" id="reg-num-hint">Insira os d√≠gitos restantes.</small>
                        </div>

                        <button class="btn-main" onclick="logic.submitCandidacy()">CONFIRMAR E ENVIAR <i class="fas fa-check"></i></button>
                        <button class="btn-main" onclick="logic.prevStep(3)" style="background: transparent; border: none; color: #fff; margin-top: 10px;">Voltar</button>
                    </div>

                </form>
            </section>

            <section id="view-consult" class="view-section">
                <div style="display:flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                    <h1>CANDIDATOS</h1>
                    <select id="filter-state" onchange="consult.load()" style="width: 200px; padding: 10px;">
                        <option value="all">Todos os Estados</option>
                        <option value="Brookhaven">Brookhaven</option>
                        <option value="Novacore">Novacore</option>
                        <option value="Caster√≠ber">Caster√≠ber</option>
                        <option value="Fortemega">Fortemega</option>
                        <option value="Flor√™mix">Flor√™mix</option>
                    </select>
                </div>
                
                <div id="candidates-container" class="cards-grid">
                    <div style="grid-column: 1/-1; text-align: center; padding: 50px; opacity: 0.5;">
                        Carregando base de dados...
                    </div>
                </div>
            </section>

            <section id="view-admin-login" class="view-section">
                <div style="max-width: 400px; margin: 0 auto; text-align: center; padding-top: 50px;">
                    <i class="fas fa-shield-alt" style="font-size: 4rem; color: var(--accent-sapphire); margin-bottom: 20px;"></i>
                    <h1>ACESSO RESTRITO</h1>
                    <p style="margin-bottom: 30px;">√Årea exclusiva para oficiais do TSE e TREs.</p>
                    
                    <form onsubmit="event.preventDefault(); admin.login();">
                        <div class="form-group">
                            <label>Identifica√ß√£o de Acesso (Senha)</label>
                            <input type="password" id="admin-pass" required style="text-align: center; letter-spacing: 3px;">
                        </div>
                        <button class="btn-main">AUTENTICAR</button>
                    </form>
                </div>
            </section>

            <section id="view-admin-dash" class="view-section">
                <div style="display:flex; justify-content: space-between; align-items: center; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 20px; margin-bottom: 20px;">
                    <div>
                        <h1>PAINEL DE CONTROLE</h1>
                        <h2 id="admin-welcome" style="margin:0;">Bem-vindo, Oficial.</h2>
                    </div>
                    <button onclick="admin.logout()" class="btn-mini" style="background: rgba(255,255,255,0.1); color: #fff;">SAIR</button>
                </div>

                <div id="tse-controls" class="glass-panel" style="padding: 20px; margin-bottom: 30px; border-color: var(--accent-gold); display: none;">
                    <h3 style="color: var(--accent-gold); margin-bottom: 15px;"><i class="fas fa-crown"></i> COMANDO NACIONAL (TSE)</h3>
                    <div style="display: flex; gap: 20px; align-items: center;">
                        <div class="form-group" style="margin-bottom: 0; flex: 1;">
                            <label>Modo da Elei√ß√£o</label>
                            <select id="admin-mode-select">
                                <option value="municipal">MUNICIPAL</option>
                                <option value="federal">FEDERAL</option>
                            </select>
                        </div>
                        <div class="form-group" style="margin-bottom: 0; flex: 1;">
                            <label>Status da Urna</label>
                            <select id="admin-status-select">
                                <option value="aberta">ABERTA</option>
                                <option value="fechada">FECHADA</option>
                            </select>
                        </div>
                        <button class="btn-main" onclick="admin.updateConfig()" style="width: auto; margin-top: 22px;">ATUALIZAR SISTEMA</button>
                    </div>
                </div>

                <h3>FILA DE AN√ÅLISE</h3>
                <div class="glass-panel" style="overflow-x: auto;">
                    <table id="admin-table">
                        <thead>
                            <tr>
                                <th>Candidato</th>
                                <th>Cargo</th>
                                <th>Partido</th>
                                <th>Local</th>
                                <th>N√∫mero</th>
                                <th>Status</th>
                                <th>A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody>
                            </tbody>
                    </table>
                </div>
            </section>

        </main>
    </div>

    <div id="toast-container"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import { getDatabase, ref, set, push, onValue, update, get, query, orderByChild, equalTo } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

        // ========================================================
        // 1. CONFIGURA√á√ÉO & INIT
        // ========================================================
        const firebaseConfig = {
            apiKey: "AIzaSyAwFLV5X9ICB3mvU4WU1ihxGUeG9UsrbtQ",
            authDomain: "candidatura-cde.firebaseapp.com",
            databaseURL: "https://candidatura-cde-default-rtdb.firebaseio.com",
            projectId: "candidatura-cde",
            storageBucket: "candidatura-cde.firebasestorage.app",
            messagingSenderId: "958958180950",
            appId: "1:958958180950:web:51427276d0a83978fdb9f7"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // ========================================================
        // 2. CONSTANTES & DADOS EST√ÅTICOS
        // ========================================================
        
        const PARTIDOS_MAP = {
    direita: [
        { number: "22", name: "Partido Liberal (PL)", color: "#0B3C5D" },
        { number: "11", name: "Progressistas (PP)", color: "#1E90FF" },
        { number: "10", name: "Republicanos", color: "#4169E1" },
        { number: "30", name: "Partido Novo (NOVO)", color: "#00BFFF" },
        { number: "51", name: "Patriota", color: "#2F4F4F" },
        { number: "28", name: "Partido Renovador Trabalhista Brasileiro (PRTB)", color: "#4682B4" },
        { number: "27", name: "Democracia Crist√£ (DC)", color: "#5F9EA0" },
        { number: "36", name: "Agir", color: "#6495ED" },

        // üîπ FICT√çCIOS
        { number: "38", name: "Uni√£o da Direita Brookasileira (UDB)", color: "#003366" },
        { number: "81", name: "Partido da Ordem e Liberdade (POL)", color: "#1C1C1C" },
        { number: "84", name: "Alian√ßa Crist√£ Nacional (ACN)", color: "#2E8B57" },
        { number: "57", name: "Partido da Reedifica√ß√£o da Ordem Nacional (PRONA)", color: "#000080" },
        { number: "48", name: "Partido da Esperan√ßa (PESP)", color: "#228B22" },
        { number: "86", name: "Partido Militar Nacionalista (PMNL)", color: "#556B2F" },
        { number: "75", name: "Partido Republicano Trabalhista Nacional (PRTN)", color: "#191970" }
    ],

    centro: [
        { number: "15", name: "Movimento Democr√°tico Brasileiro (MDB)", color: "#FFD700" },
        { number: "44", name: "Uni√£o Brasil", color: "#FFA500" },
        { number: "55", name: "Partido Social Democr√°tico (PSD)", color: "#FFB347" },
        { number: "20", name: "Podemos", color: "#FF8C00" },
        { number: "45", name: "Partido da Social Democracia Brasileira (PSDB)", color: "#FFDAB9" },
        { number: "77", name: "Solidariedade", color: "#F4A460" },
        { number: "70", name: "Avante", color: "#DAA520" },
        { number: "33", name: "Partido da Mobiliza√ß√£o Nacional (PMN)", color: "#EEC900" },
        { number: "43", name: "Partido Verde (PV)", color: "#9ACD32" },

        // üîπ FICT√çCIOS
        { number: "42", name: "Partido da Uni√£o Nacional (PUN)", color: "#F5DEB3" },
        { number: "37", name: "Movimento Popular Democr√°tico (MPD)", color: "#FFD966" },
        { number: "26", name: "Partido da Mudan√ßa (PDM)", color: "#FFC04D" },
        { number: "63", name: "Movimento Trabalhista Brookasileiro (MTB)", color: "#FFE4B5" },
        { number: "46", name: "Partido Trabalhista Democr√°tico (PTD)", color: "#FFD39B" },
        { number: "88", name: "Partido do Sindicato Democrata (PDSD)", color: "#EEDC82" },
        { number: "14", name: "Partido Miss√£o (MSS)", color: "#FFCC99" },
        { number: "85", name: "Partido Constru√ß√£o (PC)", color: "#F0E68C" }
    ],

    esquerda: [
        { number: "13", name: "Partido dos Trabalhadores (PT)", color: "#CC0000" },
        { number: "50", name: "Partido Socialismo e Liberdade (PSOL)", color: "#FF4C4C" },
        { number: "65", name: "Partido Comunista do Brasil (PCdoB)", color: "#B22222" },
        { number: "18", name: "Rede Sustentabilidade (REDE)", color: "#32CD32" },
        { number: "12", name: "Partido Democr√°tico Trabalhista (PDT)", color: "#DC143C" },
        { number: "80", name: "Unidade Popular (UP)", color: "#8B0000" },
        { number: "29", name: "Partido da Causa Oper√°ria (PCO)", color: "#A00000" },
        { number: "21", name: "Partido Comunista Brasileiro (PCB)", color: "#7B0000" },
        { number: "16", name: "Partido Socialista dos Trabalhadores Unificado (PSTU)", color: "#FF0000" },
        { number: "54", name: "Partido P√°tria Livre (PPL)", color: "#C00000" },
        { number: "40", name: "Partido Socialista Brasileiro (PSB)", color: "#E60026" },

       
        { number: "60", name: "Partido da Frente Socialista (PFS)", color: "#B30000" },
        { number: "56", name: "Partido Socialista (PS)", color: "#990000" },
        { number: "31", name: "Partido Social Trabalhista Nacional (PSTN)", color: "#CD2626" }
    ]
};
        const CIDADES_MUNICIPAL = ["Eleitoral City", "Liberty City", "Nexaville", "Castelo Verde", "Marinha City", "Flor√°polis"];
        
        // Hashes Simples (Para demonstra√ß√£o client-side segura contra visualiza√ß√£o direta)
        // Em prod real, isso seria server-side.
        // Brookhaven1234 -> hash fict√≠cio mapeado
        const AUTH_HASHES = {
            "Brookasil1234": { role: "TSE", name: "TSE NACIONAL" },
            "tutuBH": { role: "TRE", name: "TRE Brookhaven", state: "Brookhaven" },
            "williamNC": { role: "TRE", name: "TRE Novacore", state: "Novacore" },
            "henriqueCB": { role: "TRE", name: "TRE Caster√≠ber", state: "Caster√≠ber" },
            "lucasFM": { role: "TRE", name: "TRE Fortemega", state: "Fortemega" },
            "popoFX": { role: "TRE", name: "TRE Flor√™mix", state: "Flor√™mix" }
        };

        // Estado Global da Aplica√ß√£o
        let globalState = {
            mode: "municipal", // ou federal
            isOpen: false,
            currentUser: null, // Objeto admin logado
            registration: {} // Dados tempor√°rios do formul√°rio
        };

        // ========================================================
        // 3. UI UTILS
        // ========================================================
        
        window.nav = {
            goto: (viewName) => {
                document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
                document.querySelectorAll('nav button').forEach(el => el.classList.remove('active'));
                
                const target = document.getElementById(`view-${viewName}`);
                if (target) {
                    target.classList.add('active');
                    // Special routing logic
                    if(viewName === 'admin-login' && globalState.currentUser) {
                        nav.goto('admin-dash');
                        return;
                    }
                    if(viewName === 'consult') consult.load();
                }

                const navBtn = document.getElementById(`nav-${viewName === 'admin-dash' || viewName === 'admin-login' ? 'admin' : viewName}`);
                if(navBtn) navBtn.classList.add('active');
            }
        };

        window.toast = (msg, type = 'info') => {
            const container = document.getElementById('toast-container');
            const el = document.createElement('div');
            el.className = `toast ${type}`;
            el.innerHTML = `<i class="fas fa-${type === 'error' ? 'exclamation-circle' : 'check-circle'}"></i> <span>${msg}</span>`;
            container.appendChild(el);
            setTimeout(() => { el.style.opacity = '0'; setTimeout(() => el.remove(), 300); }, 4000);
        };

        const loader = {
            show: () => document.getElementById('global-loader').classList.add('active'),
            hide: () => document.getElementById('global-loader').classList.remove('active')
        };

        // Efeito Mouse
        document.addEventListener('mousemove', (e) => {
            document.querySelectorAll('.glass-panel, .btn-main').forEach(card => {
                const rect = card.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                card.style.setProperty('--x', `${x}px`);
                card.style.setProperty('--y', `${y}px`);
            });
        });

        // ========================================================
        // 4. L√ìGICA DE NEG√ìCIO (ELEI√á√ÉO)
        // ========================================================

        window.logic = {
            init: () => {
                // Ouvir configura√ß√µes globais
                const configRef = ref(db, 'config');
                onValue(configRef, (snapshot) => {
                    const data = snapshot.val();
                    if (data) {
                        globalState.mode = data.modoEleicao || "municipal";
                        globalState.isOpen = data.eleicaoAberta;
                        document.getElementById('mode-display').innerText = `MODO: ${globalState.mode.toUpperCase()} | ${globalState.isOpen ? 'ABERTA' : 'FECHADA'}`;
                        document.getElementById('mode-display').style.color = globalState.isOpen ? 'var(--accent-neon-green)' : 'var(--accent-error)';
                    }
                });
                
                // Povoar Partidos
                const sel = document.getElementById('reg-partido');
                PARTIDOS_MAP.forEach((p, idx) => {
                    const opt = document.createElement('option');
                    opt.value = idx; // Index no array
                    opt.text = `${p.numero} - ${p.nome} (${p.sigla})`;
                    sel.appendChild(opt);
                });
            },

            updatePartyInfo: () => {
                const idx = document.getElementById('reg-partido').value;
                if(idx === "") return;
                const p = PARTIDOS_MAP[idx];
                const color = p.ideologia === 'direita' ? '#4dabff' : p.ideologia === 'esquerda' ? '#ff6b6b' : '#fff';
                document.getElementById('party-info').innerHTML = `<span style="color:${color}; text-transform:uppercase; font-weight:bold;">Ideologia: ${p.ideologia}</span>`;
            },

            nextStep: (current) => {
                // Valida√ß√µes Step 1
                if (current === 1) {
                    if (!document.getElementById('reg-nome').value || !document.getElementById('reg-tiktok').value || document.getElementById('reg-partido').value === "") {
                        toast("Preencha todos os campos.", "error"); return;
                    }
                    // Popular Step 2
                    const cargoSel = document.getElementById('reg-cargo');
                    cargoSel.innerHTML = '<option value="">Selecione...</option>';
                    
                    if (globalState.mode === 'municipal') {
                        cargoSel.innerHTML += '<option value="Prefeito">Prefeito</option><option value="Vereador">Vereador</option>';
                        document.getElementById('group-estado').style.display = 'none';
                        document.getElementById('group-cidade').style.display = 'block';
                        // Popular Cidades
                        const cidSel = document.getElementById('reg-cidade');
                        cidSel.innerHTML = '<option value="">Selecione...</option>';
                        CIDADES_MUNICIPAL.forEach(c => cidSel.innerHTML += `<option value="${c}">${c}</option>`);
                    } else {
                        // Federal
                        cargoSel.innerHTML += `
                            <option value="Presidente">Presidente</option>
                            <option value="Governador">Governador</option>
                            <option value="Senador">Senador</option>
                            <option value="Deputado Federal">Deputado Federal</option>
                            <option value="Deputado Estadual">Deputado Estadual</option>
                        `;
                    }
                }

                // Valida√ß√µes Step 2
                if (current === 2) {
                    const cargo = document.getElementById('reg-cargo').value;
                    if (!cargo) { toast("Selecione o cargo.", "error"); return; }
                    
                    if (globalState.mode === 'federal') {
                        if (cargo !== 'Presidente' && !document.getElementById('reg-estado').value) {
                             toast("Selecione o estado.", "error"); return;
                        }
                        if (cargo === 'Deputado Federal' && !document.getElementById('reg-cidade').value) {
                             toast("Selecione a cidade base.", "error"); return;
                        }
                    } else {
                        if (!document.getElementById('reg-cidade').value) { toast("Selecione a cidade.", "error"); return; }
                    }

                    // Configurar Step 3 (N√∫meros)
                    const pIdx = document.getElementById('reg-partido').value;
                    const partido = PARTIDOS_MAP[pIdx];
                    document.getElementById('reg-num-prefix').value = partido.numero;
                    
                    // L√≥gica de d√≠gitos
                    const numInput = document.getElementById('reg-num-user');
                    numInput.value = "";
                    let maxLen = 0;

                    if (cargo === 'Presidente' || cargo === 'Governador' || cargo === 'Prefeito') {
                        maxLen = 0; // S√≥ n√∫mero do partido
                        numInput.placeholder = "Bloqueado";
                        numInput.disabled = true;
                    } else if (cargo === 'Senador' || cargo === 'Deputado Estadual') {
                        maxLen = 1; // 3 digitos total (2 partido + 1)
                        numInput.placeholder = "X";
                        numInput.disabled = false;
                    } else if (cargo === 'Deputado Federal' || cargo === 'Vereador') {
                        maxLen = 2; // 4 digitos total (2 partido + 2)
                        numInput.placeholder = "XX";
                        numInput.disabled = false;
                    }
                    numInput.setAttribute('maxlength', maxLen);
                    
                    // Resumo
                    const local = globalState.mode === 'municipal' ? 
                        document.getElementById('reg-cidade').value : 
                        (cargo === 'Presidente' ? 'Nacional' : document.getElementById('reg-estado').value);

                    document.getElementById('review-data').innerHTML = `
                        <strong>Candidato:</strong> ${document.getElementById('reg-nome').value}<br>
                        <strong>Cargo:</strong> ${cargo}<br>
                        <strong>Partido:</strong> ${partido.nome}<br>
                        <strong>Local:</strong> ${local}
                    `;
                }

                document.getElementById(`step-${current}`).style.display = 'none';
                document.getElementById(`step-${current+1}`).style.display = 'block';
                document.getElementById(`step-${current}-dot`).classList.remove('active');
                document.getElementById(`step-${current+1}-dot`).classList.add('active');
            },

            prevStep: (current) => {
                document.getElementById(`step-${current}`).style.display = 'none';
                document.getElementById(`step-${current-1}`).style.display = 'block';
                document.getElementById(`step-${current}-dot`).classList.remove('active');
                document.getElementById(`step-${current-1}-dot`).classList.add('active');
            },

            updateLocationFields: () => {
                const cargo = document.getElementById('reg-cargo').value;
                const estGroup = document.getElementById('group-estado');
                const cidGroup = document.getElementById('group-cidade');

                if (globalState.mode === 'federal') {
                    if (cargo === 'Presidente') {
                        estGroup.style.display = 'none';
                        cidGroup.style.display = 'none';
                    } else if (cargo === 'Deputado Federal') {
                        estGroup.style.display = 'block';
                        cidGroup.style.display = 'block'; // Prompt diz "Estado + Cidade"
                        logic.updateCityField(); // Reset list
                    } else {
                        estGroup.style.display = 'block';
                        cidGroup.style.display = 'none';
                    }
                }
            },

            updateCityField: () => {
                // Se for federal e deputado federal, lista cidades do estado selecionado?
                // O prompt simplifica "Estado + Cidade". Vou usar as cidades gen√©ricas para preencher.
                if (globalState.mode === 'federal') {
                    const sel = document.getElementById('reg-cidade');
                    sel.innerHTML = '<option value="">Selecione...</option>';
                    CIDADES_MUNICIPAL.forEach(c => sel.innerHTML += `<option value="${c}">${c}</option>`);
                }
            },

            submitCandidacy: async () => {
                if (!globalState.isOpen) { toast("Elei√ß√µes fechadas.", "error"); return; }
                
                loader.show();
                
                // Coletar dados
                const pIdx = document.getElementById('reg-partido').value;
                const partidoObj = PARTIDOS_MAP[pIdx];
                const prefix = document.getElementById('reg-num-prefix').value;
                const suffix = document.getElementById('reg-num-user').value;
                const finalNum = prefix + suffix;
                const cargo = document.getElementById('reg-cargo').value;
                
                let estado = "BR";
                let cidade = "-";
                
                if (globalState.mode === 'municipal') {
                    cidade = document.getElementById('reg-cidade').value;
                    estado = "Municipal"; // Simplifica√ß√£o
                } else {
                    if(cargo !== 'Presidente') estado = document.getElementById('reg-estado').value;
                    if(cargo === 'Deputado Federal') cidade = document.getElementById('reg-cidade').value;
                }

                // VALIDAR N√öMERO E REGRAS
                // Regra: Max 4 candidatos por cargo do mesmo partido
                // Regra: Numero √∫nico
                // Regra: Nome √∫nico
                
                // Consulta ao BD para valida√ß√£o (Query pesada mas necess√°ria)
                const candRef = ref(db, 'candidatos');
                
                try {
                    const snapshot = await get(candRef);
                    let erro = null;
                    let countPartyCargo = 0;

                    if (snapshot.exists()) {
                        snapshot.forEach(estadoSnap => {
                            estadoSnap.forEach(candSnap => {
                                const c = candSnap.val();
                                if (c.numero == finalNum) erro = "N√∫mero j√° existe na federa√ß√£o.";
                                if (c.nome.toLowerCase() === document.getElementById('reg-nome').value.toLowerCase()) erro = "Nome j√° registrado.";
                                if (c.tiktok === document.getElementById('reg-tiktok').value) erro = "TikTok j√° em uso.";
                                
                                if (c.partido === partidoObj.nome && c.cargo === cargo && c.estado === estado) {
                                    countPartyCargo++;
                                }
                            });
                        });
                    }

                    if (erro) { loader.hide(); toast(erro, "error"); return; }
                    if (countPartyCargo >= 4) { loader.hide(); toast("Limite de 4 candidatos deste partido para este cargo atingido.", "error"); return; }

                    // Salvar
                    const newCandRef = push(ref(db, `candidatos/${estado}`));
                    await set(newCandRef, {
                        id: newCandRef.key,
                        nome: document.getElementById('reg-nome').value,
                        tiktok: document.getElementById('reg-tiktok').value,
                        partido: partidoObj.nome,
                        ideologia: partidoObj.ideologia,
                        sigla: partidoObj.sigla,
                        numero: finalNum,
                        cargo: cargo,
                        estado: estado,
                        cidade: cidade,
                        status: 'pendente', // pendente, aprovado, indeferido
                        criadoEm: Date.now()
                    });

                    loader.hide();
                    toast("Candidatura enviada para an√°lise!", "success");
                    document.getElementById('reg-form').reset();
                    nav.goto('home');
                    
                } catch (e) {
                    loader.hide();
                    console.error(e);
                    toast("Erro de conex√£o.", "error");
                }
            }
        };

        // ========================================================
        // 5. CONSULTA P√öBLICA
        // ========================================================
        window.consult = {
            load: () => {
                const container = document.getElementById('candidates-container');
                container.innerHTML = '<div class="spinner" style="margin: 50px auto;"></div>';
                
                const filterState = document.getElementById('filter-state').value;
                
                // Buscar tudo e filtrar no cliente (para simplicidade do index.html √∫nico)
                const dbRef = ref(db, 'candidatos');
                onValue(dbRef, (snapshot) => {
                    container.innerHTML = '';
                    if (!snapshot.exists()) {
                        container.innerHTML = '<p style="text-align:center; opacity:0.5;">Nenhum candidato encontrado.</p>';
                        return;
                    }

                    let candidates = [];
                    snapshot.forEach(estSnap => {
                        const estadoKey = estSnap.key;
                        // Filtro de estado
                        if (filterState !== 'all' && estadoKey !== filterState) return;
                        
                        estSnap.forEach(cSnap => {
                            const c = cSnap.val();
                            if(c.status === 'aprovado') candidates.push(c);
                        });
                    });

                    if (candidates.length === 0) {
                        container.innerHTML = '<p style="text-align:center; opacity:0.5;">Nenhum registro aprovado nesta regi√£o.</p>';
                        return;
                    }

                    candidates.sort((a,b) => a.cargo.localeCompare(b.cargo));

                    candidates.forEach(c => {
                        const html = `
                            <div class="candidate-card glass-panel">
                                <span class="tag-ideology ideology-${c.ideologia}">${c.ideologia}</span>
                                <h3 style="margin-top:15px; font-size: 1.1rem;">${c.nome}</h3>
                                <p style="font-size:0.8rem; opacity:0.7;">${c.cargo}</p>
                                <div class="card-number">${c.numero}</div>
                                <div style="font-size:0.8rem;">
                                    <strong>${c.partido}</strong> (${c.sigla})<br>
                                    <i class="fab fa-tiktok"></i> ${c.tiktok}<br>
                                    <i class="fas fa-map-marker-alt"></i> ${c.estado === 'Municipal' ? c.cidade : c.estado}
                                </div>
                            </div>
                        `;
                        container.innerHTML += html;
                    });
                }, { onlyOnce: true });
            }
        };

        // ========================================================
        // 6. ADMINISTRA√á√ÉO
        // ========================================================
        window.admin = {
            login: () => {
                const pass = document.getElementById('admin-pass').value;
                const auth = AUTH_HASHES[pass];
                
                if (auth) {
                    globalState.currentUser = auth;
                    toast(`Bem-vindo, ${auth.name}`, "success");
                    document.getElementById('admin-pass').value = '';
                    nav.goto('admin-dash');
                    admin.initDash();
                } else {
                    toast("Acesso Negado. Credenciais inv√°lidas.", "error");
                }
            },

            logout: () => {
                globalState.currentUser = null;
                nav.goto('home');
            },

            initDash: () => {
                const user = globalState.currentUser;
                document.getElementById('admin-welcome').innerText = `Oficial: ${user.name}`;
                
                // Mostrar controles TSE se for TSE
                if (user.role === 'TSE') {
                    document.getElementById('tse-controls').style.display = 'block';
                    // Load current config values to inputs
                    document.getElementById('admin-mode-select').value = globalState.mode;
                    document.getElementById('admin-status-select').value = globalState.isOpen ? 'aberta' : 'fechada';
                } else {
                    document.getElementById('tse-controls').style.display = 'none';
                }

                // Carregar Tabela
                const tableBody = document.querySelector('#admin-table tbody');
                const dbRef = ref(db, 'candidatos');
                
                onValue(dbRef, (snapshot) => {
                    tableBody.innerHTML = '';
                    snapshot.forEach(estSnap => {
                        // Se for TRE, filtrar apenas seu estado
                        if (user.role === 'TRE' && estSnap.key !== user.state) return;

                        estSnap.forEach(cSnap => {
                            const c = cSnap.val();
                            const tr = document.createElement('tr');
                            tr.innerHTML = `
                                <td>${c.nome}</td>
                                <td>${c.cargo}</td>
                                <td>${c.sigla}</td>
                                <td>${c.estado === 'Municipal' ? c.cidade : c.estado}</td>
                                <td style="font-family: var(--font-display); color: var(--accent-sapphire);">${c.numero}</td>
                                <td><span class="status-badge ${c.status}">${c.status}</span></td>
                                <td>
                                    <div class="admin-controls">
                                        <button class="btn-mini btn-approve" onclick="admin.setStatus('${estSnap.key}', '${cSnap.key}', 'aprovado')"><i class="fas fa-check"></i></button>
                                        <button class="btn-mini btn-reject" onclick="admin.setStatus('${estSnap.key}', '${cSnap.key}', 'indeferido')"><i class="fas fa-times"></i></button>
                                    </div>
                                </td>
                            `;
                            tableBody.appendChild(tr);
                        });
                    });
                });
            },

            setStatus: (estadoKey, candKey, status) => {
                update(ref(db, `candidatos/${estadoKey}/${candKey}`), {
                    status: status
                }).then(() => toast(`Candidatura ${status}!`, "success"))
                  .catch(() => toast("Erro ao atualizar.", "error"));
            },

            updateConfig: () => {
                if (globalState.currentUser.role !== 'TSE') return;
                
                const newMode = document.getElementById('admin-mode-select').value;
                const newStatus = document.getElementById('admin-status-select').value === 'aberta';

                update(ref(db, 'config'), {
                    modoEleicao: newMode,
                    eleicaoAberta: newStatus
                }).then(() => toast("Sistema Eleitoral Atualizado!", "success"));
            }
        };

        // Boot
        logic.init();

        // Export logic to window for HTML onclicks
        window.logic = logic;
        window.admin = admin;
        window.consult = consult;

    </script>
</body>
</html>
