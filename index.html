<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>TSE — Brookasil 2026 | Portal Oficial</title>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&family=Rajdhani:wght@500;700&display=swap" rel="stylesheet">

  <script src="https://cdn.tailwindcss.com"></script>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root {
      --bg-gradient: linear-gradient(135deg, #020617 0%, #0f172a 100%);
      --glass-bg: rgba(30, 41, 59, 0.4);
      --glass-border: rgba(255, 255, 255, 0.08);
      --accent-gold: #fbbf24;
      --accent-blue: #3b82f6;
    }

    body {
      font-family: 'Inter', sans-serif;
      background: var(--bg-gradient);
      color: #e2e8f0;
      min-height: 100vh;
      overflow-x: hidden;
    }

    h1, h2, h3, .brand-font {
      font-family: 'Rajdhani', sans-serif;
      letter-spacing: 0.05em;
    }

    /* Efeito de Vidro (Glassmorphism) */
    .glass-panel {
      background: var(--glass-bg);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border: 1px solid var(--glass-border);
      border-radius: 16px;
      box-shadow: 0 4px 30px rgba(0, 0, 0, 0.3);
    }

    /* Inputs e Selects estilizados */
    .glass-input {
      background: rgba(15, 23, 42, 0.6);
      border: 1px solid rgba(255, 255, 255, 0.1);
      color: white;
      padding: 0.75rem 1rem;
      border-radius: 8px;
      width: 100%;
      transition: all 0.3s;
    }
    .glass-input:focus {
      outline: none;
      border-color: var(--accent-blue);
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
    }
    select.glass-input option {
      background: #0f172a;
      color: white;
    }

    /* Botões */
    .btn-gold {
      background: linear-gradient(90deg, #d97706, #fbbf24);
      color: #0f172a;
      font-weight: 700;
      padding: 0.75rem 1.5rem;
      border-radius: 8px;
      transition: transform 0.2s, box-shadow 0.2s;
    }
    .btn-gold:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 20px rgba(251, 191, 36, 0.2);
    }

    .btn-ghost {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      color: white;
      padding: 0.6rem 1.2rem;
      border-radius: 8px;
      transition: all 0.2s;
    }
    .btn-ghost:hover {
      background: rgba(255, 255, 255, 0.1);
    }

    /* Sidebar Navigation */
    .nav-item {
      display: flex;
      align-items: center;
      padding: 12px 16px;
      border-radius: 10px;
      color: #94a3b8;
      cursor: pointer;
      transition: all 0.3s;
    }
    .nav-item:hover, .nav-item.active {
      background: rgba(59, 130, 246, 0.15);
      color: var(--accent-blue);
      border-left: 4px solid var(--accent-blue);
    }
    .nav-item i { margin-right: 12px; width: 20px; text-align: center; }

    /* Scrollbar */
    ::-webkit-scrollbar { width: 8px; }
    ::-webkit-scrollbar-track { background: #020617; }
    ::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }

    /* Utilitários */
    .fade-in { animation: fadeIn 0.5s ease-out forwards; opacity: 0; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    
    .status-badge {
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 0.75rem;
      font-weight: 700;
      text-transform: uppercase;
    }
    .status-pendente { background: rgba(251, 191, 36, 0.15); color: #fbbf24; border: 1px solid rgba(251, 191, 36, 0.2); }
    .status-aprovado { background: rgba(34, 197, 94, 0.15); color: #4ade80; border: 1px solid rgba(34, 197, 94, 0.2); }
    .status-rejeitado { background: rgba(239, 68, 68, 0.15); color: #f87171; border: 1px solid rgba(239, 68, 68, 0.2); }

    .loader {
      border: 3px solid rgba(255,255,255,0.1);
      border-top: 3px solid var(--accent-blue);
      border-radius: 50%;
      width: 24px;
      height: 24px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    /* Toast Notification */
    #toast-container { position: fixed; top: 20px; right: 20px; z-index: 50; }
    .toast {
      background: var(--glass-bg);
      backdrop-filter: blur(10px);
      border-left: 4px solid var(--accent-blue);
      padding: 1rem;
      margin-bottom: 10px;
      border-radius: 8px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.3);
      display: flex; align-items: center; color: white; min-width: 300px;
      animation: slideIn 0.3s ease-out;
    }
    @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }
  </style>
</head>
<body class="p-4 md:p-6 text-sm md:text-base">

  <div class="max-w-7xl mx-auto grid grid-cols-1 md:grid-cols-12 gap-6 h-[92vh]">
    
    <aside class="md:col-span-3 glass-panel p-6 flex flex-col justify-between h-full">
      <div>
        <div class="flex items-center gap-3 mb-8">
          <div class="w-10 h-10 rounded-full bg-gradient-to-br from-blue-600 to-blue-900 flex items-center justify-center text-white font-bold shadow-lg shadow-blue-500/30">
            <i class="fa fa-scale-balanced"></i>
          </div>
          <div>
            <h1 class="text-xl font-bold text-white brand-font">TSE BROOKASIL</h1>
            <p class="text-xs text-blue-400">Eleições 2026</p>
          </div>
        </div>

        <nav class="space-y-2">
          <div class="nav-item active" onclick="switchTab('dashboard', this)">
            <i class="fa fa-chart-pie"></i> Visão Geral
          </div>
          <div class="nav-item" onclick="switchTab('candidatos', this)">
            <i class="fa fa-users-viewfinder"></i> Lista de Candidatos
          </div>
          <div class="nav-item" onclick="switchTab('registro', this)">
            <i class="fa fa-user-pen"></i> Registrar Candidatura
          </div>
          <div class="mt-8 pt-8 border-t border-white/10">
            <div class="text-xs uppercase text-gray-500 font-bold mb-2 ml-4">Administração</div>
            <div class="nav-item text-yellow-500 hover:text-yellow-400" onclick="switchTab('admin', this)">
              <i class="fa fa-user-shield"></i> Área Restrita (TRE)
            </div>
          </div>
        </nav>
      </div>

      <div>
        <div class="glass-panel p-4 bg-blue-900/20 border-blue-500/20">
          <div class="text-xs text-gray-400">Modo da Eleição</div>
          <div id="displayMode" class="text-lg font-bold text-blue-300 brand-font mt-1">Carregando...</div>
          <div class="text-[10px] text-gray-500 mt-2">Atualizado em tempo real</div>
        </div>
        <div class="mt-4 text-center text-xs text-gray-600">
          &copy; 2026 Sistema Oficial RP
        </div>
      </div>
    </aside>

    <main class="md:col-span-9 h-full overflow-y-auto pr-2 pb-10">
      
      <header class="flex justify-between items-center mb-8 glass-panel p-4 sticky top-0 z-10">
        <div class="flex items-center gap-2">
          <span class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span>
          <span class="text-xs text-gray-300">Sistema Operacional</span>
        </div>
        <div class="flex items-center gap-4">
          <div class="text-right">
            <div id="clock" class="text-lg font-bold brand-font text-white">00:00</div>
            <div class="text-xs text-gray-400" id="dateDisplay">...</div>
          </div>
        </div>
      </header>

      <section id="dashboard" class="space-y-6 fade-in">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
          <div class="glass-panel p-6 relative overflow-hidden group">
            <div class="absolute -right-6 -top-6 w-24 h-24 bg-blue-500/20 rounded-full blur-xl group-hover:bg-blue-500/30 transition"></div>
            <div class="text-gray-400 text-sm">Total de Candidatos</div>
            <div id="statTotal" class="text-4xl font-bold text-white brand-font mt-2">0</div>
            <div class="text-xs text-blue-400 mt-2"><i class="fa fa-arrow-up"></i> Estatística Global</div>
          </div>
          <div class="glass-panel p-6 relative overflow-hidden group">
            <div class="absolute -right-6 -top-6 w-24 h-24 bg-yellow-500/20 rounded-full blur-xl group-hover:bg-yellow-500/30 transition"></div>
            <div class="text-gray-400 text-sm">Aguardando Aprovação</div>
            <div id="statPending" class="text-4xl font-bold text-yellow-400 brand-font mt-2">0</div>
            <div class="text-xs text-yellow-500/80 mt-2">Requer ação do TRE</div>
          </div>
          <div class="glass-panel p-6 relative overflow-hidden group">
            <div class="absolute -right-6 -top-6 w-24 h-24 bg-green-500/20 rounded-full blur-xl group-hover:bg-green-500/30 transition"></div>
            <div class="text-gray-400 text-sm">Candidatos Aprovados</div>
            <div id="statApproved" class="text-4xl font-bold text-green-400 brand-font mt-2">0</div>
            <div class="text-xs text-green-500/80 mt-2">Prontos para urna</div>
          </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div class="glass-panel p-6">
            <h3 class="text-lg font-bold text-white mb-4">Distribuição Ideológica</h3>
            <div class="h-48 flex justify-center">
              <canvas id="chartIdeologia"></canvas>
            </div>
          </div>
          <div class="glass-panel p-6">
            <h3 class="text-lg font-bold text-white mb-4">Cargos Concorridos</h3>
            <div class="h-48 flex justify-center">
              <canvas id="chartCargos"></canvas>
            </div>
          </div>
        </div>
      </section>

      <section id="candidatos" class="hidden fade-in">
        <div class="flex justify-between items-center mb-6">
          <h2 class="text-2xl font-bold text-white brand-font">Candidatos Oficiais</h2>
          <div class="flex gap-2">
            <select id="filterPublicLado" class="glass-input !py-2 !w-auto text-xs">
              <option value="">Todos os Lados</option>
              <option value="Direita">Direita</option>
              <option value="Centro">Centro</option>
              <option value="Esquerda">Esquerda</option>
            </select>
          </div>
        </div>
        <div id="publicGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
          </div>
      </section>

      <section id="registro" class="hidden fade-in">
        <div class="glass-panel p-8 max-w-3xl mx-auto">
          <div class="text-center mb-8">
            <h2 class="text-2xl font-bold text-white brand-font">Ficha de Candidatura</h2>
            <p class="text-gray-400 text-sm">Preencha os dados corretamente. Falsidade ideológica é crime (RP).</p>
          </div>

          <form id="formCandidato" class="space-y-4">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label class="block text-xs text-gray-500 mb-1">Nome Completo</label>
                <input id="regNome" required type="text" class="glass-input" placeholder="Ex: João da Silva">
              </div>
              <div>
                <label class="block text-xs text-gray-500 mb-1">Data de Nascimento</label>
                <input id="regNasc" required type="date" class="glass-input">
              </div>
            </div>

            <div class="grid grid-cols-3 gap-4">
              <div class="col-span-1">
                <label class="block text-xs text-gray-500 mb-1">CPF (apenas números)</label>
                <input id="regCPF" required type="text" class="glass-input" placeholder="000.000.000-00">
              </div>
              <div class="col-span-2">
                <label class="block text-xs text-gray-500 mb-1">Link TikTok (Divulgação)</label>
                <div class="relative">
                  <span class="absolute left-3 top-3 text-gray-500">@</span>
                  <input id="regTikTok" type="text" class="glass-input pl-8" placeholder="usuario">
                </div>
              </div>
            </div>

            <hr class="border-white/10 my-4">

            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
              <div>
                <label class="block text-xs text-gray-500 mb-1">Espectro Político</label>
                <select id="regLado" required class="glass-input">
                  <option value="">Selecione...</option>
                  <option value="Direita">Direita</option>
                  <option value="Centro">Centro</option>
                  <option value="Esquerda">Esquerda</option>
                </select>
              </div>
              <div class="md:col-span-2">
                <label class="block text-xs text-gray-500 mb-1">Partido</label>
                <select id="regPartido" required class="glass-input">
                  <option value="">Selecione o espectro primeiro</option>
                </select>
              </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
              <div>
                <label class="block text-xs text-gray-500 mb-1">Número na Urna</label>
                <input id="regNumero" required type="number" class="glass-input" placeholder="Ex: 22">
              </div>
              <div>
                <label class="block text-xs text-gray-500 mb-1">Cargo</label>
                <select id="regCargo" required class="glass-input"></select>
              </div>
              <div>
                <label class="block text-xs text-gray-500 mb-1">Território/Estado</label>
                <select id="regTerritorio" required class="glass-input"></select>
              </div>
            </div>

            <div class="pt-4">
              <button type="submit" id="btnSubmit" class="btn-gold w-full flex justify-center items-center gap-2">
                <span>Registrar Candidatura</span>
              </button>
            </div>
          </form>
        </div>
      </section>

      <section id="admin" class="hidden fade-in">
        <div id="adminLogin" class="glass-panel p-8 max-w-md mx-auto text-center mt-10">
          <div class="w-16 h-16 bg-yellow-500/20 rounded-full flex items-center justify-center mx-auto mb-4 text-yellow-500 text-2xl">
            <i class="fa fa-lock"></i>
          </div>
          <h2 class="text-xl font-bold text-white mb-6">Acesso Restrito TRE</h2>
          <div class="space-y-3">
            <select id="loginEstado" class="glass-input">
              <option value="">Selecione o TRE...</option>
              <option value="Brookhaven">Brookhaven (TSE Central)</option>
              <option value="Novacore">Novacore</option>
              <option value="Casteríber">Casteríber</option>
              <option value="Fortemega">Fortemega</option>
              <option value="Florêmix">Florêmix</option>
            </select>
            <input id="loginSenha" type="password" placeholder="Senha de Acesso" class="glass-input">
            <button id="btnLogin" class="btn-gold w-full">Entrar no Sistema</button>
          </div>
        </div>

        <div id="adminPanel" class="hidden space-y-6">
          <div class="flex justify-between items-center glass-panel p-4 bg-yellow-500/5 border-yellow-500/20">
            <div>
              <div class="text-xs text-yellow-500 font-bold uppercase">Logado como</div>
              <div id="adminUserDisplay" class="text-xl font-bold text-white">---</div>
            </div>
            <div class="flex items-center gap-3">
              <div id="adminControls" class="hidden flex gap-2">
                <button onclick="setElectionMode('Federal')" class="btn-ghost text-xs border-blue-500 text-blue-300">Definir Federal</button>
                <button onclick="setElectionMode('Municipal')" class="btn-ghost text-xs border-green-500 text-green-300">Definir Municipal</button>
              </div>
              <button onclick="logout()" class="btn-ghost text-red-400 border-red-500/30 hover:bg-red-500/10">
                <i class="fa fa-power-off"></i> Sair
              </button>
            </div>
          </div>

          <div class="glass-panel p-6">
            <h3 class="text-lg font-bold text-white mb-4 border-b border-white/10 pb-2">
              <i class="fa fa-clock text-yellow-500 mr-2"></i> Candidaturas Pendentes
            </h3>
            <div id="pendingList" class="space-y-3">
              <p class="text-gray-500 text-center py-4">Nenhuma candidatura pendente para sua jurisdição.</p>
            </div>
          </div>
        </div>
      </section>

    </main>
  </div>

  <div id="toast-container"></div>

  <script type="module">
    // --- CONFIGURAÇÃO FIREBASE (SUBSTITUA PELOS SEUS DADOS) ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js";
    import { getDatabase, ref, push, update, onValue, get } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js";

    const firebaseConfig = {
  apiKey: "AIzaSyAwFLV5X9ICB3mvU4WU1ihxGUeG9UsrbtQ",
  authDomain: "candidatura-cde.firebaseapp.com",
  databaseURL: "https://candidatura-cde-default-rtdb.firebaseio.com",
  projectId: "candidatura-cde",
  storageBucket: "candidatura-cde.firebasestorage.app",
  messagingSenderId: "958958180950",
  appId: "1:958958180950:web:51427276d0a83978fdb9f7"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // --- DADOS ESTÁTICOS ---
    const TRE_PASSWORDS = {
      "Brookhaven": "Brookasil1234", // TSE Central
      "Novacore": "williamNC",
      "Casteríber": "henriqueCB",
      "Fortemega": "lucasFM",
      "Florêmix": "popoFX"
    };

    const PARTIDOS = {
            Direita: [
                "PL (22)", "PP (11)", "Republicanos (10)", "PRTN (75)", "Patriota (51)", 
                "PRTB (28)", "NOVO (30)", "PMB (35)", "DC (27)", "UDB (38)", "Agir (36)", 
                "POL (81)", "ACN (84)", "PRONA (57)", "PDC (17)", "PESP (48)", "PMNL (86)"
            ],
            Centro: [
                "MDB (15)", "UNIÃO (44)", "PSD (55)", "Podemos (20)", "PSDB (45)", 
                "CDN (23)", "Solidariedade (77)", "Avante (70)", "PMN (33)",
                "PV (43)", "PUN (42)", "MPD (37)", "PDM (26)", "MTB (63)", "PTD (46)", "PDSD (88)", "MSS (14)", "PC (85)"
            ],
            Esquerda: [
                "PT (13)", "PSOL (50)", "PCdoB (65)", "Rede (18)", "PDT (12)", 
                "UP (80)", "PCO (29)", "PCB (21)", "PSTU (16)", "PPL (54)", "PSB (40)", 
                "PFS (60)", "PS (56)", "PSTN (31)"
            ]
        };
    };

    const ESTADOS = {
      "Brookhaven": ["Cidade Eleitoral", "Liberty City"],
      "Novacore": ["Nexaville"],
      "Casteríber": ["Castelo Verde"],
      "Fortemega": ["Marinha City"],
      "Florêmix": ["Florápolis"]
    };

    // --- VARIÁVEIS DE ESTADO ---
    let currentMode = "Federal"; // Carregado do DB
    let currentUser = null; // Admin logado
    let candidatesData = {};

    // --- UTILITÁRIOS VISUAIS ---
    window.switchTab = (tabId, element) => {
      document.querySelectorAll('section').forEach(s => s.classList.add('hidden'));
      document.getElementById(tabId).classList.remove('hidden');
      document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
      if(element) element.classList.add('active');
    };

    const showToast = (msg, type = 'info') => {
      const container = document.getElementById('toast-container');
      const toast = document.createElement('div');
      toast.className = 'toast';
      toast.style.borderLeftColor = type === 'success' ? '#4ade80' : type === 'error' ? '#f87171' : '#3b82f6';
      toast.innerHTML = `<div>${msg}</div>`;
      container.appendChild(toast);
      setTimeout(() => toast.remove(), 3000);
    };

    // --- RELÓGIO ---
    setInterval(() => {
      const now = new Date();
      document.getElementById('clock').innerText = now.toLocaleTimeString('pt-BR', {hour:'2-digit', minute:'2-digit'});
      document.getElementById('dateDisplay').innerText = now.toLocaleDateString('pt-BR');
    }, 1000);

    // --- LÓGICA DO FORMULÁRIO ---
    // Atualiza partidos ao selecionar lado
    document.getElementById('regLado').addEventListener('change', (e) => {
      const select = document.getElementById('regPartido');
      select.innerHTML = '<option value="">Selecione...</option>';
      if (PARTIDOS[e.target.value]) {
        PARTIDOS[e.target.value].forEach(p => select.appendChild(new Option(p, p)));
      }
    });

    // Atualiza campos de cargo/local baseado no modo da eleição
    const updateFormOptions = () => {
      const cargoSel = document.getElementById('regCargo');
      const terrSel = document.getElementById('regTerritorio');
      cargoSel.innerHTML = '';
      terrSel.innerHTML = '';

      if (currentMode === 'Federal') {
        ['Presidente', 'Governador', 'Senador', 'Deputado Federal'].forEach(c => cargoSel.appendChild(new Option(c, c)));
        terrSel.appendChild(new Option('Brookasil (Nacional)', 'Brookasil'));
        Object.keys(ESTADOS).forEach(e => terrSel.appendChild(new Option(e, e)));
      } else {
        ['Prefeito', 'Vereador'].forEach(c => cargoSel.appendChild(new Option(c, c)));
        Object.entries(ESTADOS).forEach(([est, cids]) => {
          cids.forEach(cid => terrSel.appendChild(new Option(`${cid} (${est})`, `${cid}|${est}`)));
        });
      }
    };

    // Envio do Formulário
    document.getElementById('formCandidato').addEventListener('submit', async (e) => {
      e.preventDefault();
      const btn = document.getElementById('btnSubmit');
      
      // Validação básica
      const num = document.getElementById('regNumero').value;
      const cargo = document.getElementById('regCargo').value;
      const territorioRaw = document.getElementById('regTerritorio').value;
      
      // Tratar território
      let estado = territorioRaw;
      let cidade = null;
      if(territorioRaw.includes('|')){
        [cidade, estado] = territorioRaw.split('|');
      }
      if(cargo === 'Presidente') estado = 'Brookasil';

      // Verificar duplicidade (Simulação Client-Side para RP)
      const duplicado = Object.values(candidatesData).some(c => 
        c.numero === num && c.cargo === cargo && c.estado === estado
      );

      if(duplicado) {
        showToast('ERRO: Este número já existe para este cargo e local!', 'error');
        return;
      }

      const novoCandidato = {
        nome: document.getElementById('regNome').value,
        nascimento: document.getElementById('regNasc').value,
        cpf: document.getElementById('regCPF').value,
        tiktok: document.getElementById('regTikTok').value,
        lado: document.getElementById('regLado').value,
        partido: document.getElementById('regPartido').value,
        numero: num,
        cargo: cargo,
        estado: estado,
        cidade: cidade,
        status: 'pendente',
        timestamp: Date.now()
      };

      try {
        btn.innerHTML = '<div class="loader"></div>';
        await push(ref(db, 'candidatos'), novoCandidato);
        showToast('Candidatura enviada para análise do TRE!', 'success');
        document.getElementById('formCandidato').reset();
      } catch (err) {
        showToast('Erro ao conectar com servidor.', 'error');
        console.error(err);
      } finally {
        btn.innerHTML = '<span>Registrar Candidatura</span>';
      }
    });

    // --- SISTEMA ADMIN ---
    document.getElementById('btnLogin').addEventListener('click', () => {
      const est = document.getElementById('loginEstado').value;
      const pass = document.getElementById('loginSenha').value;

      if(TRE_PASSWORDS[est] && TRE_PASSWORDS[est] === pass) {
        currentUser = est;
        document.getElementById('adminLogin').classList.add('hidden');
        document.getElementById('adminPanel').classList.remove('hidden');
        document.getElementById('adminUserDisplay').innerText = `TRE ${est}`;
        
        if(est === 'Brookhaven') {
          document.getElementById('adminControls').classList.remove('hidden');
        } else {
          document.getElementById('adminControls').classList.add('hidden');
        }
        
        renderAdminList();
        showToast(`Bem-vindo, Magistrado de ${est}.`, 'success');
      } else {
        showToast('Senha incorreta ou acesso negado.', 'error');
      }
    });

    window.logout = () => {
      currentUser = null;
      document.getElementById('adminLogin').classList.remove('hidden');
      document.getElementById('adminPanel').classList.add('hidden');
    };

    window.setElectionMode = async (mode) => {
      if(currentUser !== 'Brookhaven') return;
      await update(ref(db, 'config'), { mode: mode });
      showToast(`Modo alterado para ${mode}`, 'success');
    };

    window.judgeCandidate = async (id, veredict) => {
      if(!currentUser) return;
      const status = veredict ? 'aprovado' : 'rejeitado';
      await update(ref(db, `candidatos/${id}`), { status: status, juiz: currentUser });
      showToast(`Candidatura ${status}!`, veredict ? 'success' : 'error');
    };

    const renderAdminList = () => {
      if(!currentUser) return;
      const list = document.getElementById('pendingList');
      list.innerHTML = '';
      
      const pendentes = Object.entries(candidatesData)
        .filter(([_, c]) => c.status === 'pendente')
        .filter(([_, c]) => {
          // Lógica de Poder: Brookhaven vê tudo, outros só veem seu estado
          if(currentUser === 'Brookhaven') return true;
          return c.estado === currentUser || (c.cidade && c.estado === currentUser);
        });

      if(pendentes.length === 0) {
        list.innerHTML = '<div class="text-center text-gray-500 py-4">Tudo limpo por aqui.</div>';
        return;
      }

      pendentes.forEach(([key, c]) => {
        const item = document.createElement('div');
        item.className = 'glass-panel p-4 flex justify-between items-center border border-yellow-500/30';
        item.innerHTML = `
          <div>
            <div class="font-bold text-white">${c.nome} (${c.partido})</div>
            <div class="text-xs text-gray-400">${c.cargo} • ${c.estado}</div>
            <div class="text-xs text-yellow-500 mt-1">CPF: ${c.cpf}</div>
          </div>
          <div class="flex gap-2">
            <button onclick="judgeCandidate('${key}', true)" class="btn-ghost text-green-400 hover:bg-green-500/20"><i class="fa fa-check"></i></button>
            <button onclick="judgeCandidate('${key}', false)" class="btn-ghost text-red-400 hover:bg-red-500/20"><i class="fa fa-times"></i></button>
          </div>
        `;
        list.appendChild(item);
      });
    };

    // --- LISTENER GLOBAL (REALTIME) ---
    // Config
    onValue(ref(db, 'config'), (snap) => {
      const data = snap.val();
      currentMode = (data && data.mode) ? data.mode : 'Federal';
      document.getElementById('displayMode').innerText = currentMode.toUpperCase();
      updateFormOptions(); // Atualiza formulário em tempo real se o modo mudar
    });

    // Candidatos
    let chartIdeologiaInstance = null;
    let chartCargosInstance = null;

    onValue(ref(db, 'candidatos'), (snap) => {
      candidatesData = snap.val() || {};
      const arr = Object.values(candidatesData);
      
      // Atualizar Stats
      document.getElementById('statTotal').innerText = arr.length;
      document.getElementById('statPending').innerText = arr.filter(c => c.status === 'pendente').length;
      document.getElementById('statApproved').innerText = arr.filter(c => c.status === 'aprovado').length;

      // Render Admin (se logado)
      renderAdminList();

      // Render Público (Aprovados)
      const publicGrid = document.getElementById('publicGrid');
      publicGrid.innerHTML = '';
      arr.filter(c => c.status === 'aprovado').forEach(c => {
        const card = document.createElement('div');
        card.className = 'glass-panel p-4 border-l-4 ' + (c.lado === 'Esquerda' ? 'border-red-500' : c.lado === 'Direita' ? 'border-blue-500' : 'border-yellow-500');
        card.innerHTML = `
          <div class="flex justify-between items-start">
            <h3 class="font-bold text-white text-lg">${c.nome}</h3>
            <span class="bg-gray-800 text-white font-bold px-2 py-1 rounded text-xs">${c.numero}</span>
          </div>
          <p class="text-gray-400 text-sm mt-1">${c.cargo}</p>
          <p class="text-xs text-gray-500">${c.estado} ${c.cidade ? ' - ' + c.cidade : ''}</p>
          <div class="mt-3 flex justify-between items-center">
            <span class="text-xs font-bold uppercase tracking-wide opacity-70">${c.partido}</span>
            ${c.tiktok ? `<a href="https://tiktok.com/@${c.tiktok.replace('@','')}" target="_blank" class="text-pink-500 hover:text-pink-400"><i class="fab fa-tiktok"></i></a>` : ''}
          </div>
        `;
        publicGrid.appendChild(card);
      });

      // Atualizar Gráficos
      updateCharts(arr);
    });

    function updateCharts(data) {
        const aprovados = data.filter(c => c.status === 'aprovado');
        
        // Dados Ideologia
        const counts = { Direita: 0, Centro: 0, Esquerda: 0 };
        aprovados.forEach(c => { if(counts[c.lado] !== undefined) counts[c.lado]++ });

        const ctx1 = document.getElementById('chartIdeologia');
        if(chartIdeologiaInstance) chartIdeologiaInstance.destroy();
        chartIdeologiaInstance = new Chart(ctx1, {
            type: 'doughnut',
            data: {
                labels: ['Esquerda', 'Centro', 'Direita'],
                datasets: [{
                    data: [counts.Esquerda, counts.Centro, counts.Direita],
                    backgroundColor: ['#ef4444', '#eab308', '#3b82f6'],
                    borderWidth: 0
                }]
            },
            options: { plugins: { legend: { position: 'bottom', labels: { color: 'white' } } } }
        });
        
        // Dados Cargos (Top 5)
        const cargosCount = {};
        aprovados.forEach(c => { cargosCount[c.cargo] = (cargosCount[c.cargo] || 0) + 1 });
        
        const ctx2 = document.getElementById('chartCargos');
        if(chartCargosInstance) chartCargosInstance.destroy();
        chartCargosInstance = new Chart(ctx2, {
            type: 'bar',
            data: {
                labels: Object.keys(cargosCount),
                datasets: [{
                    label: 'Candidatos',
                    data: Object.values(cargosCount),
                    backgroundColor: 'rgba(59, 130, 246, 0.6)',
                    borderColor: '#3b82f6',
                    borderWidth: 1
                }]
            },
            options: { 
                scales: { 
                    y: { beginAtZero: true, ticks: { color: 'gray' } }, 
                    x: { ticks: { color: 'gray' } } 
                },
                plugins: { legend: { display: false } }
            }
        });
    }
  </script>
</body>
</html>
